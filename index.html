<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cadastro de Ocorr√™ncias - 2025</title>

  <!-- jsPDF para gera√ß√£o local de PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* ===== Reset/Base ===== */
    * { box-sizing: border-box; margin:0; padding:0; }
    html,body{height:100%}
    body{
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(135deg,#9fe7ff 0%, #b9f7c9 60%, #baf3ff 100%);
      color:#fff; font-weight:800; padding:18px;
    }
    .app{max-width:1400px;margin:0 auto;display:flex;flex-direction:column;gap:18px}
    header{display:flex;align-items:center;justify-content:space-between;padding:18px;border-radius:14px;background:linear-gradient(90deg,rgba(0,31,63,0.95),rgba(0,78,120,0.95));box-shadow:0 8px 30px rgba(0,0,0,0.15)}
    header h1{font-size:20px;margin:0}
    .header-controls{display:flex;gap:10px;align-items:center}
    .card{background:#2f3336;padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.15)}
    .flex{display:flex;gap:18px;align-items:flex-start}
    .col{display:flex;flex-direction:column;gap:12px}
    label{display:block;margin-bottom:6px;font-size:13px}
    
    /* Ajustes para inputs com largura adequada ao conte√∫do */
    input[type="text"],input[type="email"],input[type="password"],select,textarea,input[type="date"]{
      min-width: 120px;
      padding:10px 12px;border-radius:8px;border:none;font-weight:800;font-size:14px;color:#111;
      width: auto;
      max-width: 100%;
    }
    
    /* Estilo para campos de data - permitir clique em toda √°rea */
    .date-field-container {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .date-field-container input[type="date"] {
      flex: 1;
    }
    
    .date-field-container::after {
      content: "üìÖ";
      position: absolute;
      right: 12px;
      pointer-events: none;
    }
    
    /* Estilo para listas dropdown com cores alternadas */
    select option:nth-child(odd) {
      background-color: #f5f5f5;
    }
    select option:nth-child(even) {
      background-color: #e9e9e9;
    }
    select option:checked {
      background-color: #2a5298;
      color: white;
    }
    
    /* Campos espec√≠ficos com larguras adequadas */
    #professor_gestao, #disciplina_gestao { min-width: 180px; }
    #serie_gestao { min-width: 200px; }
    #aluno_gestao { min-width: 220px; }
    #classificacao_gestao { min-width: 160px; }
    #ra_gestao { min-width: 120px; }
    #dataRetorno_gestao { min-width: 140px; }
    
    /* √Årea do professor */
    #professor_select, #turma_select { min-width: 180px; }
    #alunos_selected_input { min-width: 280px; }
    #data_prof { min-width: 140px; }
    
    textarea{min-height:110px;resize:vertical;padding-top:12px; width: 100%;}
    button{cursor:pointer;border:none;padding:10px 14px;border-radius:8px;font-weight:900;box-shadow:0 6px 18px rgba(0,0,0,0.15)}
    .btn-primary{background:linear-gradient(90deg,#1e3c72,#2a5298);color:#fff}
    .btn-danger{background:linear-gradient(90deg,#e94b4b,#c62828);color:#fff}
    .btn-success{background:linear-gradient(90deg,#4CAF50,#2E7D32);color:#fff}
    .btn-secondary{background:linear-gradient(90deg,#6c757d,#5a6268);color:#fff}
    .subtitle{font-size:14px;color:#d9f2ff;margin-bottom:6px}
    .historyList{max-height:420px;overflow:auto;display:flex;flex-direction:column;gap:10px;padding-right:6px}
    .historyItem{background:rgba(255,255,255,0.06);border-left:5px solid rgba(255,255,255,0.06);padding:12px;border-radius:8px;color:#fff;font-weight:700}
    .historyItem .meta{font-size:13px;color:#dbefff;font-weight:800;display:flex;justify-content:space-between;gap:8px;align-items:center}
    .historyItem .desc{margin-top:8px;color:#e7f7ff;font-weight:600;font-size:14px}
    .modal-root{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:2000}
    .modal{width:92%;max-width:780px;background:#fff;color:#111;border-radius:12px;padding:14px;max-height:84vh;overflow:auto}
    .studentList{display:flex;flex-direction:column;gap:8px}
    .pill{background:linear-gradient(90deg,#2a5298,#3a6bd1);color:#fff;padding:6px 10px;border-radius:999px;font-weight:800;display:inline-block}
    .muted{opacity:.9;font-weight:700;color:#e7f7ff}
    .qnum{color:#ff3b3b;font-weight:900}
    
    /* Novos estilos para formul√°rios com campos redimension√°veis */
    .form-row {display: flex; gap: 12px; margin-bottom: 12px; align-items: flex-start;}
    .form-group {display: flex; flex-direction:column; flex: 1 1 auto;}
    .form-group label {margin-bottom: 6px;}
    
    /* Ajustes espec√≠ficos para a √°rea de gest√£o - melhor organiza√ß√£o */
    .gestao-form .form-group {flex: 1;}
    .gestao-form .form-row {margin-bottom: 15px;}
    .gestao-form input, 
    .gestao-form select, 
    .gestao-form textarea {
        width: auto;
        min-width: 150px;
        padding: 12px;
        font-size: 15px;
    }
    
    /* Layout otimizado para campos lado a lado */
    .gestao-form .form-row.double {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    
    .gestao-form .form-row.triple {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 12px;
    }
    
    .gestao-form .form-row.full {
        display: block;
    }
    
    .checkbox-group {display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;}
    .checkbox-item {background: #efefef; color: #111; padding: 6px 10px; border-radius: 999px; display: inline-flex; align-items: center;}
    .checkbox-item input {margin-right: 4px;}
    
    /* Estilo espec√≠fico para o campo Classifica√ß√£o */
    .classification-container {display: flex; flex-direction: column; min-width: 250px;}
    
    /* Ajuste para garantir que os dropdowns tenham largura adequada */
    select {
      width: auto;
      min-width: 200px;
    }
    
    /* ESTILOS PARA O MODAL DE ALUNOS COM BOT√ïES FIXOS */
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .modal-content {
      max-height: 60vh;
      overflow-y: auto;
      margin-bottom: 15px;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding-top: 15px;
      border-top: 1px solid #eee;
      position: sticky;
      bottom: 0;
      background: white;
    }
    
    .student-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .student-row:hover {
      background-color: #f5f5f5;
    }
    
    .student-row.selected {
      background-color: #e6f7ff;
    }
    
    .student-name {
      flex: 1;
      padding-right: 10px;
    }
    
    /* Bot√µes de sair nas √°reas espec√≠ficas */
    .area-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .area-title {
      font-size: 18px;
      font-weight: 800;
    }
    
    /* Ajustes para responsividade */
    @media(max-width:980px){
      .flex{flex-direction:column}
      header{flex-direction:column;gap:8px;align-items:flex-start} 
      .form-row {flex-direction: column;}
      .classification-container {width: 100%;}
      .gestao-form .form-row {flex-direction: column;}
      .gestao-form .form-row.double,
      .gestao-form .form-row.triple {
          grid-template-columns: 1fr;
      }
      
      /* Em telas menores, os campos ocupam 100% da largura */
      input[type="text"],input[type="email"],input[type="password"],select,textarea,input[type="date"] {
        width: 100%;
      }
      
      .area-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
    }
    
    /* loader animation */
    @keyframes spin{to{transform:rotate(360deg)}}
    .loader{width:18px;height:18px;border:3px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;display:inline-block}
    
    /* Notifica√ß√µes */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 700;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
    }
    .notification.success {
      background: linear-gradient(90deg, #4CAF50, #2E7D32);
    }
    .notification.error {
      background: linear-gradient(90deg, #e94b4b, #c62828);
    }
    
    /* Estilos para o formul√°rio de login unificado */
    .login-form {
      max-width: 480px;
      margin: 0 auto;
    }
    .login-form .form-row {
      margin-bottom: 15px;
    }
    
    /* Estilo para o registro em tempo real */
    .real-time-register {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .real-time-item {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .real-time-item:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- HEADER -->
    <header>
      <h1>2025 ‚Äî Cadastro de Ocorr√™ncias</h1>
      <div class="header-controls">
        <div id="userDisplay" class="muted">N√£o autenticado</div>
        <button id="btnLogout" class="btn-danger" style="display:none" onclick="logout()">Sair</button>
        <button id="btnDownloadPdf" class="btn-success" style="display:none" onclick="downloadDocument()">Baixar Template</button>
      </div>
    </header>

    <!-- LOGIN UNIFICADO -->
    <div id="loginScreen" class="card" style="display:block">
      <div class="login-form">
        <div class="subtitle">Acesso ao Sistema</div>
        
        <div class="form-row">
          <div class="form-group" style="flex: 1;">
            <label for="emailLogin">E-mail</label>
            <input id="emailLogin" type="email" placeholder="seu.email@escola.com">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group" style="flex: 1;">
            <label for="passwordLogin">Senha</label>
            <input id="passwordLogin" type="password" placeholder="senha">
          </div>
        </div>
        
        <div class="form-row">
          <button class="btn-primary" onclick="login()">Entrar</button>
        </div>
      </div>
    </div>

    <!-- MAIN APP - GEST√ÉO -->
    <div id="mainAppGestao" style="display:none;flex-direction:column;gap:14px">
      <div class="flex">
        <!-- GEST√ÉO -->
        <div class="card col" style="flex:1">
          <div class="area-header">
            <div class="area-title">CADASTRO ‚Äî GEST√ÉO</div>
          </div>
          <div class="col gestao-form">
            <!-- S√©rie/Turma em primeiro lugar -->
            <div class="form-row double">
              <div class="form-group">
                <label>S√©rie / Turma</label>
                <select id="serie_gestao" onchange="carregarAlunosPorTurmaGestao(this.value)">
                  <option value="">-- Selecione a turma --</option>
                </select>
              </div>
              <div class="form-group">
                <label>Aluno</label>
                <select id="aluno_gestao" onchange="preencherRAGestao(this.value)">
                  <option value="">-- Selecione o aluno --</option>
                </select>
              </div>
            </div>
            
            <!-- Aluno e RA lado a lado -->
            <div class="form-row triple">
              <div class="form-group">
                <label>RA</label>
                <input id="ra_gestao" type="text" readonly>
              </div>
              <div class="form-group">
                <label>Professor</label>
                <input id="professor_gestao" type="text">
              </div>
              <div class="form-group">
                <label>Disciplina</label>
                <input id="disciplina_gestao" type="text">
              </div>
            </div>
            
            <!-- Classifica√ß√£o com largura ajustada -->
            <div class="form-row double">
              <div class="form-group">
                <label>Classifica√ß√£o</label>
                <select id="classificacao_gestao" onchange="toggleSuspension('gestao')">
                  <option value="">Selecione</option>
                  <option value="OCORR√äNCIA">OCORR√äNCIA</option>
                  <option value="SUSPENS√ÉO">SUSPENS√ÉO</option>
                </select>
              </div>
              <div class="form-group" style="display:none" id="suspensionRow_gestao">
                <label>Data de retorno</label>
                <div class="date-field-container">
                  <input id="dataRetorno_gestao" type="date">
                </div>
              </div>
            </div>
            
            <div class="form-row full">
              <div class="form-group">
                <label>Descri√ß√£o</label>
                <textarea id="descricao_gestao" placeholder="Descri√ß√£o detalhada"></textarea>
              </div>
            </div>

            <div class="form-row">
              <button class="btn-primary" onclick="cadastrarOcorrenciaGestao()">Registrar (Gest√£o)</button>
              <button class="btn-success" onclick="generatePDFLocal()">Gerar PDF (local)</button>
            </div>

            <div id="successGestao" style="display:none;margin-top:10px;background:linear-gradient(90deg,#4CAF50,#2E7D32);padding:10px;border-radius:8px;color:#fff;font-weight:900">
              Ocorr√™ncia registrada com sucesso!
            </div>
          </div>
        </div>
      </div>

      <!-- HIST√ìRICO GEST√ÉO -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="subtitle">HIST√ìRICO DE OCORR√äNCIAS - GEST√ÉO</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn-primary" onclick="carregarHistoricoGestao()">Atualizar</button>
          </div>
        </div>
        <div style="margin-top:12px" id="historyListGestao" class="historyList"></div>
      </div>
    </div> <!-- mainAppGestao -->

    <!-- MAIN APP - PROFESSOR -->
    <div id="mainAppProfessor" style="display:none;flex-direction:column;gap:14px">
      <div class="flex">
        <!-- PROFESSOR -->
        <div class="card col" style="flex:1">
          <div class="area-header">
            <div class="area-title">REGISTRO ‚Äî PROFESSOR</div>
          </div>
          <div class="col">
            <div class="form-row double">
              <div class="form-group">
                <label>Professor</label>
                <select id="professor_select"></select>
              </div>
              <div class="form-group">
                <label>Turma</label>
                <select id="turma_select" onchange="onTurmaChange()"></select>
              </div>
            </div>

            <div class="form-row double">
              <div class="form-group">
                <label>Alunos (clique para selecionar)</label>
                <input id="alunos_selected_input" type="text" readonly placeholder="Clique para selecionar" onclick="openStudentsModal()">
                <div id="selectedPills" style="margin-top:8px"></div>
              </div>
              <div class="form-group">
                <label>Data</label>
                <div class="date-field-container">
                  <input id="data_prof" type="date">
                </div>
              </div>
            </div>

            <div class="form-row full">
              <div class="form-group">
                <label>Irregularidades</label>
                <div class="checkbox-group">
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Agress√£o"> Agress√£o
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Danos ao patrim√¥nio"> Danos ao patrim√¥nio
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Desacato"> Desacato
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Estava fora da sala"> Estava fora da sala
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Falta de material"> Falta de material
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Indisciplina"> Indisciplina
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="N√£o realiza as atividades"> N√£o realiza as atividades
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Saiu da sala sem autoriza√ß√£o"> Saiu da sala sem autoriza√ß√£o
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Uso de celular"> Uso de celular
                  </label>
                </div>
              </div>
            </div>

            <div class="form-row full">
              <div class="form-group">
                <label>Descri√ß√£o</label>
                <textarea id="descricao_prof" placeholder="Descreva a ocorr√™ncia..."></textarea>
              </div>
            </div>

            <div class="form-row">
              <button class="btn-primary" onclick="registrarOcorrenciaProfessor()">Registrar (Professor)</button>
              <button class="btn-danger" onclick="clearProfessorForm()">Limpar</button>
            </div>

            <div id="successProfessor" style="display:none;margin-top:10px;background:linear-gradient(90deg,#4CAF50,#2E7D32);padding:10px;border-radius:8px;color:#fff;font-weight:900">
              Ocorr√™ncia registrada com sucesso!
            </div>
          </div>
        </div>
      </div>

      <!-- HIST√ìRICO PROFESSOR E REGISTRO EM TEMPO REAL -->
      <div class="flex">
        <!-- HIST√ìRICO PROFESSOR -->
        <div class="card" style="flex: 1">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="subtitle">HIST√ìRICO DE OCORR√äNCIAS - PROFESSOR</div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn-primary" onclick="carregarHistoricoProfessor()">Atualizar</button>
            </div>
          </div>
          <div style="margin-top:12px" id="historyListProfessor" class="historyList"></div>
        </div>
        
        <!-- REGISTRO EM TEMPO REAL -->
        <div class="card" style="flex: 1">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="subtitle">REGISTRO EM TEMPO REAL - PROFESSOR</div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn-primary" onclick="atualizarRegistroTempoReal()">Atualizar</button>
            </div>
          </div>
          <div class="real-time-register" id="realTimeRegister">
            <div class="muted" style="text-align: center; padding: 20px;">Nenhum registro em tempo real</div>
          </div>
        </div>
      </div>
    </div> <!-- mainAppProfessor -->

    <!-- MODAL SELE√á√ÉO ALUNOS COM BOT√ïES FIXOS -->
    <div id="modalRoot" class="modal-root">
      <div class="modal">
        <div class="modal-header">
          <strong>Selecionar alunos</strong>
          <button onclick="closeStudentsModal()" style="background:transparent;border:none;font-weight:900;cursor:pointer">‚úï</button>
        </div>

        <div class="modal-content">
          <input id="studentSearch" type="text" placeholder="Filtrar alunos..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:10px" oninput="filterStudentList()">
          <div id="studentList" class="studentList"></div>
        </div>

        <div class="modal-footer">
          <button class="btn-primary" onclick="confirmStudents()">Confirmar</button>
          <button class="btn-danger" onclick="closeStudentsModal()">Cancelar</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    /*******************************
     * CONFIGURA√á√ïES
     *******************************/
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw8DhjEbvF3wjRPnvnztMlQgMwa4FaVDC8D3zGo0KC-fil88RnsieePl2v2yppcTI2s6w/exec';
    const SPREADSHEET_ID = '1u7qMsMHkZT47OZdar5qvshQDRA8XJrLgDjAZVOViAio';

    // nomes de abas (front-end manda "sheet" para o Apps Script)
    const SHEET_GERAL = 'BANCODEDADOSGERAL';
    const SHEET_PROF = 'OCORRENCIASDOSPROFESSORES'; // onde professores gravam (a partir de A2)
    const SHEET_GESTAO = 'BANCODEALUNOS'; // onde gest√£o grava (a partir de A2)

    // estado
    let allAlunos = [];
    let alunosDaTurmaAtual = [];
    let alunosSelecionados = [];
    let professores = [];
    let turmas = [];
    let currentUserRole = null;
    let alunosComRA = []; // Para armazenar alunos com RA na √°rea de gest√£o
    let registroTempoReal = []; // Para armazenar registros em tempo real

    // inicial
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('data_prof').value = new Date().toISOString().split('T')[0];
      carregarTurmasGestao(); // Carregar turmas ao iniciar
      
      // Ajustar largura dos campos ap√≥s o carregamento
      setTimeout(ajustarLarguraCampos, 100);
      
      // Adicionar eventos de clique para os campos de data
      setupDateFields();
    });

    // Configurar campos de data para abrir o calend√°rio ao clicar em qualquer parte
    function setupDateFields() {
      // Campo de data do professor
      const dataProfContainer = document.querySelector('#data_prof').parentElement;
      dataProfContainer.addEventListener('click', function() {
        document.getElementById('data_prof').showPicker();
      });
      
      // Campo de data de retorno da gest√£o
      const dataRetornoGestao = document.getElementById('dataRetorno_gestao');
      if (dataRetornoGestao) {
        const dataRetornoContainer = dataRetornoGestao.parentElement;
        dataRetornoContainer.addEventListener('click', function() {
          dataRetornoGestao.showPicker();
        });
      }
    }

    // Fun√ß√£o para ajustar a largura dos campos baseada no conte√∫do
    function ajustarLarguraCampos() {
      // Selecionar todos os campos de entrada
      const campos = document.querySelectorAll('input[type="text"], input[type="email"], select');
      
      campos.forEach(campo => {
        // Criar um elemento tempor√°rio para medir o texto
        const temp = document.createElement('span');
        temp.style.visibility = 'hidden';
        temp.style.position = 'absolute';
        temp.style.whiteSpace = 'pre';
        temp.style.font = window.getComputedStyle(campo).font;
        
        // Obter o valor atual ou o texto da op√ß√£o selecionada
        let texto = '';
        if (campo.tagName === 'SELECT') {
          const opcaoSelecionada = campo.options[campo.selectedIndex];
          texto = opcaoSelecionada ? opcaoSelecionada.text : '';
        } else {
          texto = campo.value || campo.placeholder || '';
        }
        
        temp.textContent = texto;
        document.body.appendChild(temp);
        
        // Definir a largura m√≠nima baseada no conte√∫do
        const largura = temp.getBoundingClientRect().width + 30; // Adicionar padding
        campo.style.minWidth = Math.max(parseInt(window.getComputedStyle(campo).minWidth) || 120, largura) + 'px';
        
        document.body.removeChild(temp);
      });
    }

    // Fun√ß√£o para exibir notifica√ß√µes
    function showNotification(type, message) {
      // Remover notifica√ß√µes existentes
      const existingNotifications = document.querySelectorAll('.notification');
      existingNotifications.forEach(notification => notification.remove());
      
      // Criar nova notifica√ß√£o
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // Remover ap√≥s 5 segundos
      setTimeout(() => {
        notification.remove();
      }, 5000);
    }

    // Login unificado
    function login(){
      const email = document.getElementById('emailLogin').value.trim();
      const password = document.getElementById('passwordLogin').value.trim();
      
      if(email === 'gestao@escola.com' && password === 'gestao123'){
        showAppAs('gestao', email);
      } else if(email === 'professor@escola.com' && password === 'prof123'){
        showAppAs('professor', email);
      } else {
        alert('E-mail ou senha incorretos.');
      }
    }

    function showAppAs(role, email){
      currentUserRole = role;
      document.getElementById('loginScreen').style.display = 'none';
      
      if (role === 'gestao') {
        document.getElementById('mainAppGestao').style.display = 'flex';
        document.getElementById('mainAppProfessor').style.display = 'none';
        carregarHistoricoGestao();
      } else {
        document.getElementById('mainAppGestao').style.display = 'none';
        document.getElementById('mainAppProfessor').style.display = 'flex';
        carregarProfessoresETurmas();
        carregarHistoricoProfessor();
        atualizarRegistroTempoReal();
      }
      
      document.getElementById('userDisplay').textContent = email + (role==='gestao'?' (Gest√£o)':' (Professor)');
      document.getElementById('btnLogout').style.display = 'inline-block';
      document.getElementById('btnDownloadPdf').style.display = 'inline-block';
      
      // Reajustar largura ap√≥s mostrar a aplica√ß√£o
      setTimeout(ajustarLarguraCampos, 200);
    }

    function logout(){
      currentUserRole = null;
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('mainAppGestao').style.display = 'none';
      document.getElementById('mainAppProfessor').style.display = 'none';
      document.getElementById('userDisplay').textContent = 'N√£o autenticado';
      document.getElementById('btnLogout').style.display = 'none';
      document.getElementById('btnDownloadPdf').style.display = 'none';
      alunosDaTurmaAtual = []; alunosSelecionados = []; document.getElementById('selectedPills').innerHTML='';
      
      // Limpar formul√°rios
      document.getElementById('emailLogin').value = '';
      document.getElementById('passwordLogin').value = '';
    }

    /*******************************
     * Fun√ß√µes espec√≠ficas para a √°rea de gest√£o
     *******************************/
    
    // Carregar turmas para a √°rea de gest√£o
    async function carregarTurmasGestao() {
      try {
        const r = await fetch(`${SCRIPT_URL}?endpoint=classes&sheet=${encodeURIComponent(SHEET_GERAL)}`);
        const j = await r.json();
        if(j && j.status === 'success' && Array.isArray(j.classes)) {
          turmas = j.classes;
        } else {
          turmas = Object.keys(_getClassRanges());
        }
        
        const turmaSelect = document.getElementById('serie_gestao');
        turmaSelect.innerHTML = '<option value="">-- Selecione a turma --</option>';
        turmas.forEach(t => {
          const option = document.createElement('option');
          option.value = t;
          option.textContent = t;
          turmaSelect.appendChild(option);
        });
        
        // Reajustar largura ap√≥s carregar turmas
        setTimeout(ajustarLarguraCampos, 100);
      } catch(err) {
        console.error('Erro ao carregar turmas (gest√£o):', err);
        turmas = Object.keys(_getClassRanges());
        const turmaSelect = document.getElementById('serie_gestao');
        turmaSelect.innerHTML = '<option value="">-- Selecione a turma --</option>';
        turmas.forEach(t => {
          const option = document.createElement('option');
          option.value = t;
          option.textContent = t;
          turmaSelect.appendChild(option);
        });
        
        // Reajustar largura ap√≥s carregar turmas
        setTimeout(ajustarLarguraCampos, 100);
      }
    }
    
    // Carregar alunos por turma na √°rea de gest√£o
    async function carregarAlunosPorTurmaGestao(turma) {
      if (!turma) {
        document.getElementById('aluno_gestao').innerHTML = '<option value="">-- Selecione o aluno --</option>';
        document.getElementById('ra_gestao').value = '';
        return;
      }
      
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=students&sheet=${encodeURIComponent(SHEET_GERAL)}&turma=${encodeURIComponent(turma)}`);
        const json = await resp.json();
        
        // Verificar se a resposta inclui studentsList (com RA) ou apenas students (apenas nomes)
        if (json.studentsList && Array.isArray(json.studentsList)) {
          alunosComRA = json.studentsList;
        } else if (json.students && Array.isArray(json.students)) {
          // Se n√£o tiver RA, criar array apenas com nomes
          alunosComRA = json.students.map(nome => ({ nome, ra: '' }));
        } else {
          alunosComRA = [];
        }
        
        const alunoSelect = document.getElementById('aluno_gestao');
        alunoSelect.innerHTML = '<option value="">-- Selecione o aluno --</option>';
        
        alunosComRA.forEach(aluno => {
          const option = document.createElement('option');
          option.value = aluno.nome;
          option.textContent = aluno.nome;
          option.setAttribute('data-ra', aluno.ra || '');
          alunoSelect.appendChild(option);
        });
        
        // Reajustar largura ap√≥s carregar alunos
        setTimeout(ajustarLarguraCampos, 100);
      } catch(err) {
        console.error('Erro ao carregar alunos (gest√£o):', err);
        document.getElementById('aluno_gestao').innerHTML = '<option value="">-- Selecione o aluno --</option>';
      }
    }
    
    // Preencher RA quando selecionar um aluno na √°rea de gest√£o
    function preencherRAGestao(nomeAluno) {
      const alunoSelect = document.getElementById('aluno_gestao');
      const selectedOption = alunoSelect.selectedOptions[0];
      const ra = selectedOption ? selectedOption.getAttribute('data-ra') : '';
      document.getElementById('ra_gestao').value = ra || '';
      
      // Reajustar largura ap√≥s preencher RA
      setTimeout(ajustarLarguraCampos, 50);
    }

    /*******************************
     * GET professores & turmas (consultando BANCODEDADOSGERAL)
     *******************************/
    async function carregarProfessoresETurmas(){
      try {
        // professores (GET do sheet geral)
        const r1 = await fetch(`${SCRIPT_URL}?endpoint=teachers&sheet=${encodeURIComponent(SHEET_GERAL)}`);
        const j1 = await r1.json();
        if(j1 && j1.status === 'success' && Array.isArray(j1.teachers)) professores = j1.teachers;
        else professores = getFallbackProfessores();

        const profSel = document.getElementById('professor_select');
        profSel.innerHTML = '<option value="">-- selecione --</option>';
        professores.forEach(p => { const o = document.createElement('option'); o.value = p; o.textContent = p; profSel.appendChild(o) });

        // turmas (GET do sheet geral)
        const r2 = await fetch(`${SCRIPT_URL}?endpoint=classes&sheet=${encodeURIComponent(SHEET_GERAL)}`);
        const j2 = await r2.json();
        if(j2 && j2.status === 'success' && Array.isArray(j2.classes)) turmas = j2.classes;
        else turmas = Object.keys(_getClassRanges());

        const turmaSel = document.getElementById('turma_select');
        turmaSel.innerHTML = '<option value="">-- selecione --</option>';
        turmas.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; turmaSel.appendChild(o) });
        
        // Reajustar largura ap√≥s carregar professores e turmas
        setTimeout(ajustarLarguraCampos, 100);
      } catch(err){
        console.error('Erro carregar professores/turmas:', err);
        // fallback
        professores = getFallbackProfessores();
        const profSel = document.getElementById('professor_select');
        profSel.innerHTML = '<option value="">-- selecione --</option>';
        professores.forEach(p => { const o = document.createElement('option'); o.value = p; o.textContent = p; profSel.appendChild(o) });
        turmas = Object.keys(_getClassRanges());
        const turmaSel = document.getElementById('turma_select');
        turmaSel.innerHTML = '<option value="">-- selecione --</option>';
        turmas.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; turmaSel.appendChild(o) });
        
        // Reajustar largura ap√≥s carregar professores e turmas
        setTimeout(ajustarLarguraCampos, 100);
      }
    }

    /*******************************
     * GET students by class (consultando BANCODEDADOSGERAL)
     *******************************/
    async function onTurmaChange(){
      const turma = document.getElementById('turma_select').value;
      if(!turma){ alunosDaTurmaAtual = []; renderStudentList([]); return; }
      await carregarAlunosPorTurma(turma);
      renderStudentList(alunosDaTurmaAtual);
      
      // Reajustar largura ap√≥s mudar turma
      setTimeout(ajustarLarguraCampos, 100);
    }

    async function carregarAlunosPorTurma(turma){
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=students&sheet=${encodeURIComponent(SHEET_GERAL)}&turma=${encodeURIComponent(turma)}`);
        const json = await resp.json();
        alunosDaTurmaAtual = json.students || json.studentsList || [];
        if(!Array.isArray(alunosDaTurmaAtual)) alunosDaTurmaAtual = [];
      } catch(err){
        console.error('Erro get students:', err);
        alunosDaTurmaAtual = [];
      }
    }

    /*******************************
     * Modal alunos (professor) - MODIFICADO PARA BOT√ïES FIXOS E SELE√á√ÉO POR NOME
     *******************************/
    function openStudentsModal(){
      if(!alunosDaTurmaAtual || alunosDaTurmaAtual.length === 0){ alert('Nenhum aluno encontrado para a turma selecionada.'); return; }
      document.getElementById('modalRoot').style.display = 'flex';
      renderStudentList(alunosDaTurmaAtual);
      document.getElementById('studentSearch').value = '';
    }
    
    function closeStudentsModal(){ 
      document.getElementById('modalRoot').style.display = 'none'; 
    }

    function renderStudentList(list){
      const container = document.getElementById('studentList'); 
      container.innerHTML = '';
      
      list.forEach(nome => {
        const row = document.createElement('div'); 
        row.className = 'student-row';
        if (alunosSelecionados.includes(nome)) {
          row.classList.add('selected');
        }
        
        const lbl = document.createElement('div'); 
        lbl.className = 'student-name';
        lbl.textContent = nome;
        
        const cb = document.createElement('input'); 
        cb.type='checkbox'; 
        cb.value = nome; 
        cb.checked = alunosSelecionados.includes(nome);
        
        // Evento para alternar sele√ß√£o ao clicar no checkbox
        cb.onchange = (e) => { 
          toggleStudentSelection(nome, e.target.checked);
          updateStudentRowStyle(row, nome);
        };
        
        // Evento para alternar sele√ß√£o ao clicar em qualquer parte da linha
        row.onclick = (e) => {
          // N√£o disparar se o clique foi diretamente no checkbox
          if (e.target !== cb) {
            const newState = !alunosSelecionados.includes(nome);
            cb.checked = newState;
            toggleStudentSelection(nome, newState);
            updateStudentRowStyle(row, nome);
          }
        };
        
        row.appendChild(lbl); 
        row.appendChild(cb); 
        container.appendChild(row);
      });
    }
    
    function toggleStudentSelection(nome, isSelected) {
      if(isSelected){ 
        if(!alunosSelecionados.includes(nome)) alunosSelecionados.push(nome); 
      } else {
        alunosSelecionados = alunosSelecionados.filter(x => x !== nome); 
      }
    }
    
    function updateStudentRowStyle(row, nome) {
      if (alunosSelecionados.includes(nome)) {
        row.classList.add('selected');
      } else {
        row.classList.remove('selected');
      }
    }

    function filterStudentList(){ 
      const q = document.getElementById('studentSearch').value.toLowerCase(); 
      const filtered = alunosDaTurmaAtual.filter(s => s.toLowerCase().includes(q)); 
      renderStudentList(filtered); 
    }

    function confirmStudents(){
      document.getElementById('alunos_selected_input').value = alunosSelecionados.join(', ');
      const pills = document.getElementById('selectedPills'); pills.innerHTML = '';
      alunosSelecionados.forEach(a => { const el = document.createElement('div'); el.className='pill'; el.textContent = a; pills.appendChild(el); });
      closeStudentsModal();
      
      // Reajustar largura ap√≥s confirmar sele√ß√£o de alunos
      setTimeout(ajustarLarguraCampos, 100);
    }

    /*******************************
     * Toggle suspens√£o (gest√£o)
     *******************************/
    function toggleSuspension(area){
      if(area === 'gestao'){ 
        const val = document.getElementById('classificacao_gestao').value; 
        document.getElementById('suspensionRow_gestao').style.display = (val === 'SUSPENS√ÉO') ? 'flex' : 'none'; 
        
        // Se est√° mostrando o campo de data, configurar o evento de clique
        if (val === 'SUSPENS√ÉO') {
          setTimeout(() => {
            const dataRetornoGestao = document.getElementById('dataRetorno_gestao');
            if (dataRetornoGestao) {
              const dataRetornoContainer = dataRetornoGestao.parentElement;
              dataRetornoContainer.addEventListener('click', function() {
                dataRetornoGestao.showPicker();
              });
            }
          }, 100);
        }
      }
      
      // Reajustar largura ap√≥s mudar classifica√ß√£o
      setTimeout(ajustarLarguraCampos, 50);
    }

    /*******************************
     * POST cadastrar ocorr√™ncia (gest√£o) -> grava em BANCODEALUNOS (sheet: SHEET_GESTAO)
     *******************************/
    async function cadastrarOcorrenciaGestao(){
      const alunoSelect = document.getElementById('aluno_gestao');
      const aluno = alunoSelect.value;
      const turmaSelect = document.getElementById('serie_gestao');
      const serie = turmaSelect.value;
      const professor = document.getElementById('professor_gestao').value.trim();
      const disciplina = document.getElementById('disciplina_gestao').value.trim();
      const classificacao = document.getElementById('classificacao_gestao').value;
      const descricao = document.getElementById('descricao_gestao').value.trim();
      const dataRetorno = document.getElementById('dataRetorno_gestao').value || null;
      const ra = document.getElementById('ra_gestao').value;

      if(!aluno || !serie || !professor || !disciplina || !classificacao || !descricao){ alert('Preencha todos os campos obrigat√≥rios.'); return; }
      if(classificacao === 'SUSPENS√ÉO' && !dataRetorno){ alert('Informe data de retorno para suspens√£o.'); return; }

      const payload = {
        sheet: SHEET_GESTAO,           // grava na aba BANCODEALUNOS
        startRow: 2,                  // indica a partir de A2 (o Apps Script deve utilizar isso)
        date: new Date().toISOString().split('T')[0],
        professor: professor,
        studentClass: serie,
        student: aluno,
        ra: ra,
        disciplina: disciplina,
        irregularities: classificacao + (dataRetorno ? (' - retorno: ' + dataRetorno) : ''),
        description: descricao
      };

      try {
        const resp = await fetch(`${SCRIPT_URL}`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const j = await resp.json();
        if(j && j.status === 'success'){
          showNotification('success', 'Ocorr√™ncia registrada com sucesso!');
          // limpar
          document.getElementById('serie_gestao').value = '';
          document.getElementById('aluno_gestao').innerHTML = '<option value="">-- Selecione o aluno --</option>';
          document.getElementById('ra_gestao').value = '';
          document.getElementById('professor_gestao').value = '';
          document.getElementById('disciplina_gestao').value = '';
          document.getElementById('classificacao_gestao').value = '';
          document.getElementById('descricao_gestao').value = '';
          document.getElementById('suspensionRow_gestao').style.display = 'none';
          carregarHistoricoGestao();
          
          // Reajustar largura ap√≥s limpar formul√°rio
          setTimeout(ajustarLarguraCampos, 100);
        } else {
          showNotification('error', j.message || 'Erro ao registrar ocorr√™ncia!');
        }
      } catch(err){
        console.error('Erro POST ocorrencia (gestao):', err);
        showNotification('error', 'Falha na comunica√ß√£o com servidor');
      }
    }

    /*******************************
     * POST registrar ocorr√™ncia (professor) -> grava em OCORRENCIASDOSPROFESSORES (sheet: SHEET_PROF)
     *******************************/
    async function registrarOcorrenciaProfessor(){
      const professor = document.getElementById('professor_select').value;
      const turma = document.getElementById('turma_select').value;
      const dataOc = document.getElementById('data_prof').value;
      const descricao = document.getElementById('descricao_prof').value.trim();
      if(!professor || !turma || !dataOc || alunosSelecionados.length === 0){ alert('Preencha todos os campos obrigat√≥rios e selecione ao menos um aluno.'); return; }
      const irregs = Array.from(document.querySelectorAll('input[name="irreg"]:checked')).map(x=>x.value);
      const payload = { 
        sheet: SHEET_PROF,            // grava na aba OCORRENCIASDOSPROFESSORES
        startRow: 2,                  // gravar a partir de A2 (Apps Script deve respeitar)
        date: dataOc, 
        professor: professor, 
        studentClass: turma, 
        student: alunosSelecionados.join(', '), 
        irregularities: irregs.join(', '), 
        description: descricao 
      };
      try {
        const resp = await fetch(`${SCRIPT_URL}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const j = await resp.json();
        if(j && j.status === 'success'){
          showNotification('success', 'Ocorr√™ncia registrada com sucesso!');
          clearProfessorForm();
          carregarHistoricoProfessor();
          atualizarRegistroTempoReal();
          
          // Reajustar largura ap√≥s limpar formul√°rio
          setTimeout(ajustarLarguraCampos, 100);
        } else {
          showNotification('error', j.message || 'Erro ao registrar ocorr√™ncia!');
        }
      } catch(err){
        console.error('Erro POST ocorrencia (professor):', err);
        showNotification('error', 'Falha na comunica√ß√£o com servidor');
      }
    }

    function clearProfessorForm(){
      document.getElementById('professor_select').value=''; document.getElementById('turma_select').value=''; document.getElementById('alunos_selected_input').value=''; document.getElementById('selectedPills').innerHTML=''; document.getElementById('descricao_prof').value=''; alunosSelecionados = []; Array.from(document.querySelectorAll('input[name="irreg"]')).forEach(cb => cb.checked=false); document.getElementById('data_prof').value = new Date().toISOString().split('T')[0];
      
      // Reajustar largura ap√≥s limpar formul√°rio
      setTimeout(ajustarLarguraCampos, 100);
    }

    /*******************************
     * GET hist√≥rico (consultando BANCODEDADOSGERAL)
     *******************************/
    async function carregarHistoricoGestao(){
      const container = document.getElementById('historyListGestao');
      container.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><div class="loader"></div><div class="muted">Carregando hist√≥rico...</div></div>`;
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=occurrences&sheet=${encodeURIComponent(SHEET_GERAL)}`);
        const json = await resp.json();
        // backend pode retornar json.occurrences ou json.data
        const ocorrs = json.occurrences || json.data || [];
        container.innerHTML = '';
        if(!ocorrs || ocorrs.length === 0){ container.innerHTML = '<div class="muted">Nenhuma ocorr√™ncia encontrada.</div>'; return; }

        // Exibe do mais recente para o mais antigo
        ocorrs.slice().reverse().forEach(r => {
          const id = r.id || r.ID || r.Id || null;
          const date = r.DATA || r.date || r.col1 || '';
          const prof = r.PROFESSOR || r.professor || r.col2 || '';
          const turma = r.TURMA || r.studentClass || r.col3 || '';
          const aluno = r.ALUNO || r.student || r.col4 || '';
          const irreg = r.IRREGULARIDADES || r.irregularities || r.col5 || '';
          const desc = r.DESCRICAO || r.description || r.col6 || '';

          const div = document.createElement('div'); div.className='historyItem';
          const meta = document.createElement('div'); meta.className='meta';
          meta.innerHTML = `<div><strong>${date}</strong> ‚Äî <span class="muted">${prof}</span></div>`;
          const controls = document.createElement('div');
          // bot√£o gerar pdf via backend
          const pdfBtn = document.createElement('button');
          pdfBtn.className='btn-success'; pdfBtn.style.fontSize='12px'; pdfBtn.style.marginLeft='8px';
          pdfBtn.textContent = 'Gerar PDF (template)';
          pdfBtn.onclick = () => generatePdfFromBackend(id);
          // bot√£o excluir
          const delBtn = document.createElement('button');
          delBtn.className='btn-danger'; delBtn.style.fontSize='12px'; delBtn.style.marginLeft='8px';
          delBtn.textContent = 'Excluir';
          delBtn.onclick = () => deleteOccurrence(id);

          controls.appendChild(pdfBtn); controls.appendChild(delBtn);
          meta.appendChild(controls);

          const ddesc = document.createElement('div'); ddesc.className='desc';
          ddesc.innerHTML = `<strong>Aluno(s):</strong> ${aluno || 'N/A'}<br/><strong>Turma:</strong> ${turma || 'N/A'}<br/><strong>Irregularidades:</strong> ${irreg || 'N/A'}<br/><em>${desc || ''}</em>`;

          // adicionar id vis√≠vel (√∫til)
          const idLine = document.createElement('div'); idLine.style.marginTop='8px'; idLine.style.fontSize='12px'; idLine.style.opacity='0.9'; idLine.innerHTML = `ID: <span class="qnum">${id}</span>`;

          div.appendChild(meta); div.appendChild(ddesc); div.appendChild(idLine);
          container.appendChild(div);
        });
      } catch(err){
        console.error('Erro carregarHistorico:', err);
        document.getElementById('historyListGestao').innerHTML = '<div class="muted">Erro ao carregar hist√≥rico (ver console).</div>';
      }
    }

    async function carregarHistoricoProfessor(){
      const container = document.getElementById('historyListProfessor');
      container.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><div class="loader"></div><div class="muted">Carregando hist√≥rico...</div></div>`;
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=occurrences&sheet=${encodeURIComponent(SHEET_GERAL)}`);
        const json = await resp.json();
        const ocorrs = json.occurrences || json.data || [];
        container.innerHTML = '';
        if(!ocorrs || ocorrs.length === 0){ container.innerHTML = '<div class="muted">Nenhuma ocorr√™ncia encontrada.</div>'; return; }

        // Exibe do mais recente para o mais antigo
        ocorrs.slice().reverse().forEach(r => {
          const id = r.id || r.ID || r.Id || null;
          const date = r.DATA || r.date || r.col1 || '';
          const prof = r.PROFESSOR || r.professor || r.col2 || '';
          const turma = r.TURMA || r.studentClass || r.col3 || '';
          const aluno = r.ALUNO || r.student || r.col4 || '';
          const irreg = r.IRREGULARIDADES || r.irregularities || r.col5 || '';
          const desc = r.DESCRICAO || r.description || r.col6 || '';

          const div = document.createElement('div'); div.className='historyItem';
          const meta = document.createElement('div'); meta.className='meta';
          meta.innerHTML = `<div><strong>${date}</strong> ‚Äî <span class="muted">${prof}</span></div>`;
          
          const ddesc = document.createElement('div'); ddesc.className='desc';
          ddesc.innerHTML = `<strong>Aluno(s):</strong> ${aluno || 'N/A'}<br/><strong>Turma:</strong> ${turma || 'N/A'}<br/><strong>Irregularidades:</strong> ${irreg || 'N/A'}<br/><em>${desc || ''}</em>`;

          // adicionar id vis√≠vel (√∫til)
          const idLine = document.createElement('div'); idLine.style.marginTop='8px'; idLine.style.fontSize='12px'; idLine.style.opacity='0.9'; idLine.innerHTML = `ID: <span class="qnum">${id}</span>`;

          div.appendChild(meta); div.appendChild(ddesc); div.appendChild(idLine);
          container.appendChild(div);
        });
      } catch(err){
        console.error('Erro carregarHistorico:', err);
        document.getElementById('historyListProfessor').innerHTML = '<div class="muted">Erro ao carregar hist√≥rico (ver console).</div>';
      }
    }

    /*******************************
     * Registro em tempo real do professor
     *******************************/
    async function atualizarRegistroTempoReal() {
      const container = document.getElementById('realTimeRegister');
      container.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><div class="loader"></div><div class="muted">Carregando registro...</div></div>`;
      
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=occurrences&sheet=${encodeURIComponent(SHEET_GERAL)}`);
        const json = await resp.json();
        const ocorrs = json.occurrences || json.data || [];
        
        // Filtrar ocorr√™ncias do professor logado
        const professorLogado = document.getElementById('professor_select').value;
        const ocorrsProfessor = ocorrs.filter(r => {
          const prof = r.PROFESSOR || r.professor || r.col2 || '';
          return prof === professorLogado;
        });
        
        container.innerHTML = '';
        
        if(ocorrsProfessor.length === 0) {
          container.innerHTML = '<div class="muted" style="text-align: center; padding: 20px;">Nenhum registro em tempo real</div>';
          return;
        }
        
        // Exibir apenas os 5 registros mais recentes
        const registrosRecentes = ocorrsProfessor.slice(-5).reverse();
        
        registrosRecentes.forEach(r => {
          const date = r.DATA || r.date || r.col1 || '';
          const turma = r.TURMA || r.studentClass || r.col3 || '';
          const aluno = r.ALUNO || r.student || r.col4 || '';
          const irreg = r.IRREGULARIDADES || r.irregularities || r.col5 || '';
          const desc = r.DESCRICAO || r.description || r.col6 || '';

          const item = document.createElement('div');
          item.className = 'real-time-item';
          
          const header = document.createElement('div');
          header.style.display = 'flex';
          header.style.justifyContent = 'space-between';
          header.style.marginBottom = '5px';
          
          const dateEl = document.createElement('div');
          dateEl.textContent = date;
          dateEl.style.fontWeight = 'bold';
          dateEl.style.fontSize = '13px';
          
          const classEl = document.createElement('div');
          classEl.textContent = turma;
          classEl.style.fontSize = '12px';
          classEl.style.opacity = '0.8';
          
          header.appendChild(dateEl);
          header.appendChild(classEl);
          
          const content = document.createElement('div');
          content.style.fontSize = '13px';
          content.innerHTML = `<strong>Aluno(s):</strong> ${aluno || 'N/A'}<br/>
                               <strong>Irregularidade:</strong> ${irreg || 'N/A'}<br/>
                               <em>${desc || ''}</em>`;
          
          item.appendChild(header);
          item.appendChild(content);
          container.appendChild(item);
        });
      } catch(err) {
        console.error('Erro ao carregar registro em tempo real:', err);
        container.innerHTML = '<div class="muted">Erro ao carregar registro</div>';
      }
    }

    /*******************************
     * DELETE ocorr√™ncia (POST ?endpoint=delete-occurrence) - envia sheet para contexto
     *******************************/
    async function deleteOccurrence(occurrenceId){
      if(occurrenceId === null || occurrenceId === undefined){ alert('ID inv√°lido para exclus√£o.'); return; }
      if(!confirm('Confirma exclus√£o desta ocorr√™ncia (ID '+occurrenceId+')?')) return;
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=delete-occurrence`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ occurrenceId, sheet: SHEET_PROF })
        });
        const j = await resp.json();
        if(j && j.status === 'success'){ 
          showNotification('success', 'Ocorr√™ncia exclu√≠da com sucesso!');
          carregarHistoricoGestao(); 
        }
        else showNotification('error', j.message || 'Erro ao excluir ocorr√™ncia!');
      } catch(err){ 
        console.error('Erro deleteOccurrence:', err); 
        showNotification('error', 'Falha na comunica√ß√£o com servidor');
      }
    }

    /*******************************
     * Gera√ß√£o de PDF via backend
     *******************************/
    async function generatePdfFromBackend(occurrenceId){
      if(!occurrenceId){ alert('ID inv√°lido para gera√ß√£o de PDF.'); return; }
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=generate-pdf`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ occurrenceId, sheet: SHEET_PROF })
        });
        const j = await resp.json();
        if(j && j.status === 'success' && j.pdfUrl){
          // abrir link em nova aba
          window.open(j.pdfUrl, '_blank');
        } else {
          showNotification('error', j.message || 'Erro ao gerar PDF!');
        }
      } catch(err){
        console.error('Erro generatePdfFromBackend:', err);
        showNotification('error', 'Falha na comunica√ß√£o com servidor');
      }
    }

    /*******************************
     * fallback: gerar PDF localmente (apenas conte√∫do simples)
     *******************************/
    function generatePDFLocal(){
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text('Registro de Ocorr√™ncia', 14, 20);
        const aluno = document.getElementById('aluno_gestao').value || '';
        const turma = document.getElementById('serie_gestao').value || '';
        const prof = document.getElementById('professor_gestao').value || '';
        const desc = document.getElementById('descricao_gestao').value || '';
        let y = 36;
        if(aluno){ doc.text(`Aluno: ${aluno}`, 14, y); y+=8; }
        if(turma){ doc.text(`Turma: ${turma}`, 14, y); y+=8; }
        if(prof){ doc.text(`Professor: ${prof}`, 14, y); y+=8; }
        doc.text('Descri√ß√£o:', 14, y); y+=8;
        const split = doc.splitTextToSize(desc || 'Sem descri√ß√£o', 180);
        doc.text(split, 14, y);
        doc.save(`ocorrencia_${Date.now()}.pdf`);
      } catch(err){ console.error('Erro gerar PDF local:', err); alert('Erro ao gerar PDF local (ver console).'); }
    }

    /*******************************
     * utilit√°rios / fallbacks
     *******************************/
    function _getClassRanges(){ return {
      "6¬∞ ANO A MANHA":"C3:C46","6¬∞ ANO B MANHA":"H3:H46","6¬∞ ANO C MANHA":"M3:M46","6¬∞ ANO D MANHA":"R3:R46",
      "6¬∞ ANO E TARDE":"W3:W46","6¬∞ ANO F TARDE":"AB3:AB46","7¬∞ ANO A TARDE":"AG3:AG46","7¬∞ ANO B TARDE":"AL3:AL46",
      "7¬∞ ANO C TARDE":"AQ3:AQ46","7¬∞ ANO D TARDE":"AV3:AV46","7¬∞ ANO E TARDE":"BA3:BA46","7¬∞ ANO F TARDE":"BF3:BF46",
      "8¬∞ ANO A TARDE":"BK3:BK46","8¬∞ ANO B TARDE":"BP3:BP46","8¬∞ ANO C TARDE":"BU3:BU46","8¬∞ ANO D TARDE":"BZ3:B46",
      "9¬∞ ANO A TARDE":"CE3:CE46","9¬∞ ANO B TARDE":"CJ3:CJ46","9¬∞ ANO C TARDE":"CO3:CO46","9¬∞ ANO D TARDE":"CT3:CT46",
      "1¬™ SERIE A MANHA":"CY3:CY46","1¬™ SERIE B MANHA":"DD3:DD46","1¬™ SERIE C MANHA":"DI3:DI46","1¬™ SERIE D MANHA":"DN3:DN46",
      "1¬™ SERIE E MANHA":"DS3:DS46","1¬™ SERIE F MANHA":"DX3:DX46","1¬™ SERIE G TARDE":"EC3:EC46","1¬™ SERIE H NOITE":"EH3:EH46",
      "1¬™ SERIE I NOITE":"EM3:EM46","2¬™ SERIE A MANHA":"ER3:ER46","2¬™ SERIE B MANHA":"EW3:EW46","2¬™ SERIE C MANHA":"FB3:FB46",
      "2¬™ SERIE D MANHA":"FG3:FG46","2¬™ SERIE E MANHA":"FL3:FL46","2¬™ SERIE F NOITE":"FQ3:FQ46","2¬™ SERIE G NOITE":"FV3:FV46",
      "2¬™ SERIE H NOITE":"GA3:GA46","3¬™ SERIE A MANHA":"GK3:GK46","3¬™ SERIE B MANHA":"GP3:GP46","3¬™ SERIE C MANHA":"GU3:GU46",
      "3¬™ SERIE D NOITE":"GZ3:GZ46","3¬™ SERIE E NOITE":"HE3:HE46","3¬™ SERIE F NOITE":"HJ3:HJ46"
    };}

    function getFallbackProfessores(){
      return [
        "ALEX LUTH PEREIRA MARANHAO","ALEXSANDRA PAULA VARELLA DE SOUZA","ALISON VASCONCELOS BESERRA","AMAURI TEODORO DE OLIVEIRA",
        "ANA PAULA DOS SANTOS","ANDREIA DOS SANTOS FREITAS","ANDREIA MADUREIRA REIS","ANTONIO CARLOS DE OLIVEIRA",
        "ANTONIO RAMS DE ARAUJO","ANTONIO WILTON WANDERLEY CABRAL","AUGUSTO LINO PESSOA NETO","AUREA MARIA DE JESUS MARQUES",
        "CAROLINA PERNOMIAN PARUSSOLOLO","CASSIA OLIVEIRA ANTONIAZI","CLAUDINEIA DE AGUIAR LIMA","DANIEL DE FREITAS ALMEIDA",
        "DANIEL LOPES BARBOSA","DANIELA FERREIRA LIMA","DANIELLE LUCIA BATISTA DE ALMEIDA","EDIANE VIEIRA DA SILVA",
        "EDILEUSA NUNES PEREIRA","EDUARDO HENRIQUE DA FONSECA","ELIANE SANTOS SILVA","ELIAS MONTEIRO DA SILVERA",
        "ELISABETE APARECIDA PIRES","ELZA DE FARIA PEREIRA","EMERSON GABLER DE ALMEIDA","EUZELI ARAUJO DE OLIVEIRA",
        "FABIANO AUGUSTO PIEDADE","FABIO CAMILO","FERNANDO JOSE DA SILVA FILHO","FLAVIA CRISTINA APARECIDA BICHLER",
        "FLAVIO CARDOSO FLEURY","FRANCISCA EDIVANIA DE MORAIS COSTA","GABRIELA SERIGHELLI DE MELO","GELSON DE ALMEIDA BATISTA",
        "GENILTON DE OLIVEIRA SILVA","GIANI CRISTINA DO PRADO","INGRYD CAROLINA SUGUIMOTO VIEIRA","IVANILDES DOS SANTOS OSHIKAWA",
        "JANINA DOS PASSOS BRAGA DE ALMEIDA","JOSE APARECIDO DA SILVA","JUAREZ GOMES DE MAGALHAES FILHO","JUREMA SOLEDADE FURINI SANTOS",
        "KATIUSCIA ALVES BOMFIM","LUANA CAROLINE ALVES LIMA","LUANA DE FREITAS SILVA","LUCIANA NOVAIS CORREIA SANTOS",
        "LUCIANO MOREIRA DE AZEVEDO","MARCIEL DA SILVA","MARIA HELENA CUNHA MORO","MARIA QUIT√âRIA FERREIRA DOS SANTOS",
        "MARINA DA CONCEICAO FRANCISCO SILVA","MAURICIO DE BARROS SANTOS","MICHELE DE PINHO MORAES","MOISES ANTONIO DE BARROS",
        "PAULA ARMANI VILA","PAULO ROBERTO DA SILVA ITO","PEDRO ZANOTTI FILHO","RAUL PEREIRA VILERA JUNIOR",
        "REGIANE CURTI DE SOUZA OLIVEIRA","REGINA DA SILSA CASTRO","RICARDO AMERICO DA SILVA","ROBERTO SALGADO",
        "RODRIGO VIEIRA","ROSANGELA CAFASSO MOREIRA","ROSIMERY DE SOUZA PESSOA","ROSMARA DA SILSA CARDOSO",
        "SANDRA CRISTINA MACEDO MORAES","SELMA GOMES DA SILSA","SERGIO AGRIPINO VILLA NOVA","SOLANGE ALMEIDA DA SILSA",
        "SUZINEIDE SILSA DE FREITAS","THIAGO FABIANO BRITO","TITTO AUGUSTO NASCIMENTO SILSA","VANDERSON HYPPOLITO",
        "VANESSA IVETE GOMES DOS SANTOS","VANIA PENHA DE BARROS","VIVIANE LEAL CAMERA DE MORAES","WILSON RODRIGUES MOTA"
      ];
    }

  </script>
</body>
</html>
