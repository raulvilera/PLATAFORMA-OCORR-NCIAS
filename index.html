<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cadastro de Ocorr√™ncias - 2025</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* (MANTIDO O MESMO CSS ANTERIOR) */
    * { box-sizing: border-box; margin:0; padding:0; }
    html,body{height:100%}
    body{
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(135deg,#9fe7ff 0%, #b9f7c9 60%, #baf3ff 100%);
      color:#fff; font-weight:800; padding:18px;
    }
    .app{max-width:1400px;margin:0 auto;display:flex;flex-direction:column;gap:18px}
    header{display:flex;align-items:center;justify-content:space-between;padding:18px;border-radius:14px;background:linear-gradient(90deg,rgba(0,31,63,0.95),rgba(0,78,120,0.95));box-shadow:0 8px 30px rgba(0,0,0,0.15)}
    header h1{font-size:20px;margin:0}
    .header-controls{display:flex;gap:10px;align-items:center}
    .card{background:#2f3336;padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.15)}
    .flex{display:flex;gap:18px;align-items:flex-start}
    .col{display:flex;flex-direction:column;gap:12px}
    label{display:block;margin-bottom:6px;font-size:13px}
    input[type="text"],input[type="email"],input[type="password"],select,textarea,input[type="date"]{
      min-width: 120px; padding:10px 12px;border-radius:8px;border:none;font-weight:800;font-size:14px;color:#111;
      width: auto; max-width: 100%;
    }
    .date-field-container { position: relative; display: flex; align-items: center; }
    .date-field-container input[type="date"] { flex: 1; }
    .date-field-container::after { content: "üìÖ"; position: absolute; right: 12px; pointer-events: none; }
    textarea{min-height:110px;resize:vertical;padding-top:12px; width: 100%;}
    button{cursor:pointer;border:none;padding:10px 14px;border-radius:8px;font-weight:900;box-shadow:0 6px 18px rgba(0,0,0,0.15)}
    .btn-primary{background:linear-gradient(90deg,#1e3c72,#2a5298);color:#fff}
    .btn-danger{background:linear-gradient(90deg,#e94b4b,#c62828);color:#fff}
    .btn-success{background:linear-gradient(90deg,#4CAF50,#2E7D32);color:#fff}
    .subtitle{font-size:14px;color:#d9f2ff;margin-bottom:6px}
    .historyList{max-height:420px;overflow:auto;display:flex;flex-direction:column;gap:10px;padding-right:6px}
    .historyItem{background:rgba(255,255,255,0.06);border-left:5px solid rgba(255,255,255,0.06);padding:12px;border-radius:8px;color:#fff;font-weight:700}
    .historyItem .meta{font-size:13px;color:#dbefff;font-weight:800;display:flex;justify-content:space-between;gap:8px;align-items:center}
    .historyItem .desc{margin-top:8px;color:#e7f7ff;font-weight:600;font-size:14px}
    .form-row {display: flex; gap: 12px; margin-bottom: 12px; align-items: flex-start;}
    .form-group {display: flex; flex-direction:column; flex: 1 1 auto;}
    .form-group label {margin-bottom: 6px;}
    .gestao-form .form-group {flex: 1;}
    .gestao-form .form-row {margin-bottom: 15px;}
    .gestao-form input, .gestao-form select, .gestao-form textarea { width: auto; min-width: 150px; padding: 12px; font-size: 15px; }
    .gestao-form .form-row.double { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .gestao-form .form-row.triple { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .gestao-form .form-row.full { display: block; }
    .checkbox-group {display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;}
    .checkbox-item {background: #efefef; color: #111; padding: 6px 10px; border-radius: 999px; display: inline-flex; align-items: center;}
    .checkbox-item input {margin-right: 4px;}
    .modal-root{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:2000}
    .modal{width:92%;max-width:780px;background:#fff;color:#111;border-radius:12px;padding:14px;max-height:84vh;overflow:auto}
    .studentList{display:flex;flex-direction:column;gap:8px}
    .pill{background:linear-gradient(90deg,#2a5298,#3a6bd1);color:#fff;padding:6px 10px;border-radius:999px;font-weight:800;display:inline-block}
    .muted{opacity:.9;font-weight:700;color:#e7f7ff}
    .notification {
      position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 8px; color: white; font-weight: 700; z-index: 10000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.3s ease;
    }
    .notification.success { background: linear-gradient(90deg, #4CAF50, #2E7D32); }
    .notification.error { background: linear-gradient(90deg, #e94b4b, #c62828); }
    @media(max-width:980px){
      .flex{flex-direction:column}
      header{flex-direction:column;gap:8px;align-items:flex-start} 
      .form-row {flex-direction: column;}
      .gestao-form .form-row {flex-direction: column;}
      .gestao-form .form-row.double, .gestao-form .form-row.triple { grid-template-columns: 1fr; }
      input[type="text"],input[type="email"],input[type="password"],select,textarea,input[type="date"] { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="app">

    <header>
      <h1>2025 ‚Äî Cadastro de Ocorr√™ncias</h1>
      <div class="header-controls">
        <div id="userDisplay" class="muted">N√£o autenticado</div>
        <button id="btnLogout" class="btn-danger" style="display:none" onclick="logout()">Sair</button>
      </div>
    </header>

    <!-- LOGIN UNIFICADO -->
    <div id="loginScreen" class="card" style="display:block">
      <div style="max-width: 480px; margin: 0 auto;">
        <div class="subtitle">Acesso ao Sistema</div>
        <div class="form-row">
          <div class="form-group" style="flex: 1;">
            <label for="emailLogin">E-mail</label>
            <input id="emailLogin" type="email" placeholder="seu.email@escola.com">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group" style="flex: 1;">
            <label for="passwordLogin">Senha</label>
            <input id="passwordLogin" type="password" placeholder="senha">
          </div>
        </div>
        <div class="form-row">
          <button class="btn-primary" onclick="login()">Entrar</button>
        </div>
      </div>
    </div>

    <!-- MAIN APP - GEST√ÉO -->
    <div id="mainAppGestao" style="display:none;flex-direction:column;gap:14px">
      <div class="flex">
        <div class="card col" style="flex:1">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
            <div style="font-size:18px;font-weight:800">CADASTRO ‚Äî GEST√ÉO</div>
          </div>
          <div class="col gestao-form">
            <div class="form-row double">
              <div class="form-group">
                <label>S√©rie / Turma</label>
                <select id="serie_gestao" onchange="carregarAlunosPorTurmaGestao(this.value)">
                  <option value="">-- Selecione a turma --</option>
                </select>
              </div>
              <div class="form-group">
                <label>Aluno</label>
                <select id="aluno_gestao" onchange="preencherRAGestao()">
                  <option value="">-- Selecione o aluno --</option>
                </select>
              </div>
            </div>
            
            <div class="form-row triple">
              <div class="form-group">
                <label>RA</label>
                <input id="ra_gestao" type="text" readonly>
              </div>
              <div class="form-group">
                <label>Professor</label>
                <input id="professor_gestao" type="text">
              </div>
              <div class="form-group">
                <label>Disciplina</label>
                <input id="disciplina_gestao" type="text">
              </div>
            </div>
            
            <div class="form-row double">
              <div class="form-group">
                <label>Classifica√ß√£o</label>
                <select id="classificacao_gestao" onchange="toggleSuspension('gestao')">
                  <option value="">Selecione</option>
                  <option value="OCORR√äNCIA">OCORR√äNCIA</option>
                  <option value="SUSPENS√ÉO">SUSPENS√ÉO</option>
                </select>
              </div>
              <div class="form-group" style="display:none" id="suspensionRow_gestao">
                <label>Data de retorno</label>
                <div class="date-field-container">
                  <input id="dataRetorno_gestao" type="date">
                </div>
              </div>
            </div>
            
            <div class="form-row full">
              <div class="form-group">
                <label>Descri√ß√£o</label>
                <textarea id="descricao_gestao" placeholder="Descri√ß√£o detalhada"></textarea>
              </div>
            </div>

            <div class="form-row">
              <button class="btn-primary" onclick="cadastrarOcorrenciaGestao()">Registrar (Gest√£o)</button>
              <button class="btn-success" onclick="generatePDFLocal()">Gerar PDF (local)</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="subtitle">HIST√ìRICO DE OCORR√äNCIAS - GEST√ÉO</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn-primary" onclick="carregarHistoricoGestao()">Atualizar</button>
          </div>
        </div>
        <div style="margin-top:12px" id="historyListGestao" class="historyList"></div>
      </div>
    </div>

    <!-- MAIN APP - PROFESSOR -->
    <div id="mainAppProfessor" style="display:none;flex-direction:column;gap:14px">
      <div class="flex">
        <div class="card col" style="flex:1">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
            <div style="font-size:18px;font-weight:800">REGISTRO ‚Äî PROFESSOR</div>
          </div>
          <div class="col">
            <div class="form-row double">
              <div class="form-group">
                <label>Professor</label>
                <select id="professor_select"></select>
              </div>
              <div class="form-group">
                <label>Turma</label>
                <select id="turma_select" onchange="onTurmaChange()"></select>
              </div>
            </div>

            <div class="form-row double">
              <div class="form-group">
                <label>Alunos (clique para selecionar)</label>
                <input id="alunos_selected_input" type="text" readonly placeholder="Clique para selecionar" onclick="openStudentsModal()">
                <div id="selectedPills" style="margin-top:8px"></div>
              </div>
              <div class="form-group">
                <label>Data</label>
                <div class="date-field-container">
                  <input id="data_prof" type="date">
                </div>
              </div>
            </div>

            <div class="form-row full">
              <div class="form-group">
                <label>Irregularidades</label>
                <div class="checkbox-group">
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Agress√£o"> Agress√£o</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Danos ao patrim√¥nio"> Danos ao patrim√¥nio</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Desacato"> Desacato</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Estava fora da sala"> Estava fora da sala</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Falta de material"> Falta de material</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Indisciplina"> Indisciplina</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="N√£o realiza as atividades"> N√£o realiza as atividades</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Saiu da sala sem autoriza√ß√£o"> Saiu da sala sem autoriza√ß√£o</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Uso de celular"> Uso de celular</label>
                </div>
              </div>
            </div>

            <div class="form-row full">
              <div class="form-group">
                <label>Descri√ß√£o</label>
                <textarea id="descricao_prof" placeholder="Descreva a ocorr√™ncia..."></textarea>
              </div>
            </div>

            <div class="form-row">
              <button class="btn-primary" onclick="registrarOcorrenciaProfessor()">Registrar (Professor)</button>
              <button class="btn-danger" onclick="clearProfessorForm()">Limpar</button>
            </div>
          </div>
        </div>
      </div>

      <div class="flex">
        <div class="card" style="flex: 1">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="subtitle">HIST√ìRICO DE OCORR√äNCIAS - PROFESSOR</div>
            <button class="btn-primary" onclick="carregarHistoricoProfessor()">Atualizar</button>
          </div>
          <div style="margin-top:12px" id="historyListProfessor" class="historyList"></div>
        </div>
      </div>
    </div>

    <!-- MODAL SELE√á√ÉO ALUNOS -->
    <div id="modalRoot" class="modal-root">
      <div class="modal">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #eee">
          <strong>Selecionar alunos</strong>
          <button onclick="closeStudentsModal()" style="background:transparent;border:none;font-weight:900;cursor:pointer">‚úï</button>
        </div>
        <div style="max-height:60vh;overflow-y:auto;margin-bottom:15px">
          <input id="studentSearch" type="text" placeholder="Filtrar alunos..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:10px" oninput="filterStudentList()">
          <div id="studentList" class="studentList"></div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;padding-top:15px;border-top:1px solid #eee">
          <button class="btn-primary" onclick="confirmStudents()">Confirmar</button>
          <button class="btn-danger" onclick="closeStudentsModal()">Cancelar</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    /*******************************
     * CONFIGURA√á√ïES
     *******************************/
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwFdUBE637Uk69XFK6elC_nNxxGQsM1bc8OlmRCnHuaNF4nbf5BXd7QO3X-MHRLCl8SUQ/exec';
    
    // Nomes das abas
    const SHEET_GERAL = 'BANCODEDADOSGERAL';
    const SHEET_PROF = 'OCORRENCIASDOSPROFESSORES';
    const SHEET_GESTAO = 'BANCODEALUNOS';

    // estado
    let alunosDaTurmaAtual = [];
    let alunosSelecionados = [];
    let professores = [];
    let turmas = [];
    let currentUserRole = null;
    let alunosComRA = [];

    // inicial
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('data_prof').value = new Date().toISOString().split('T')[0];
      carregarTurmasGestao();
    });

    // Fun√ß√£o para exibir notifica√ß√µes
    function showNotification(type, message) {
      const existingNotifications = document.querySelectorAll('.notification');
      existingNotifications.forEach(notification => notification.remove());
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 5000);
    }

    // Login unificado
    function login(){
      const email = document.getElementById('emailLogin').value.trim();
      const password = document.getElementById('passwordLogin').value.trim();
      
      if(email === 'gestao@escola.com' && password === 'gestao123'){
        showAppAs('gestao', email);
      } else if(email === 'professor@escola.com' && password === 'prof123'){
        showAppAs('professor', email);
      } else {
        alert('E-mail ou senha incorretos.');
      }
    }

    function showAppAs(role, email){
      currentUserRole = role;
      document.getElementById('loginScreen').style.display = 'none';
      
      if (role === 'gestao') {
        document.getElementById('mainAppGestao').style.display = 'flex';
        document.getElementById('mainAppProfessor').style.display = 'none';
        carregarHistoricoGestao();
      } else {
        document.getElementById('mainAppGestao').style.display = 'none';
        document.getElementById('mainAppProfessor').style.display = 'flex';
        carregarProfessoresETurmas();
        carregarHistoricoProfessor();
      }
      
      document.getElementById('userDisplay').textContent = email + (role==='gestao'?' (Gest√£o)':' (Professor)');
      document.getElementById('btnLogout').style.display = 'inline-block';
    }

    function logout(){
      currentUserRole = null;
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('mainAppGestao').style.display = 'none';
      document.getElementById('mainAppProfessor').style.display = 'none';
      document.getElementById('userDisplay').textContent = 'N√£o autenticado';
      document.getElementById('btnLogout').style.display = 'none';
      alunosDaTurmaAtual = []; 
      alunosSelecionados = []; 
      document.getElementById('selectedPills').innerHTML='';
      
      document.getElementById('emailLogin').value = '';
      document.getElementById('passwordLogin').value = '';
    }

    /*******************************
     * √ÅREA DE GEST√ÉO - COMPLETA
     *******************************/
    
    // Carregar turmas para a √°rea de gest√£o
    async function carregarTurmasGestao() {
      try {
        const r = await fetch(`${SCRIPT_URL}?endpoint=classes`);
        const j = await r.json();
        
        if(j && j.status === 'success' && Array.isArray(j.classes)) {
          turmas = j.classes;
        } else {
          turmas = Object.keys(_getClassRanges());
        }
        
        const turmaSelect = document.getElementById('serie_gestao');
        turmaSelect.innerHTML = '<option value="">-- Selecione a turma --</option>';
        turmas.forEach(t => {
          const option = document.createElement('option');
          option.value = t;
          option.textContent = t;
          turmaSelect.appendChild(option);
        });
        
        console.log(`Carregadas ${turmas.length} turmas`);
      } catch(err) {
        console.error('Erro ao carregar turmas (gest√£o):', err);
        turmas = Object.keys(_getClassRanges());
        const turmaSelect = document.getElementById('serie_gestao');
        turmaSelect.innerHTML = '<option value="">-- Selecione a turma --</option>';
        turmas.forEach(t => {
          const option = document.createElement('option');
          option.value = t;
          option.textContent = t;
          turmaSelect.appendChild(option);
        });
      }
    }
    
    // CORRE√á√ÉO: Carregar alunos por turma na √°rea de gest√£o
    async function carregarAlunosPorTurmaGestao(turma) {
      if (!turma) {
        document.getElementById('aluno_gestao').innerHTML = '<option value="">-- Selecione o aluno --</option>';
        document.getElementById('ra_gestao').value = '';
        return;
      }
      
      console.log('Carregando alunos para turma:', turma);

      try {
        // Mostrar loading
        const alunoSelect = document.getElementById('aluno_gestao');
        alunoSelect.innerHTML = '<option value="">Carregando alunos...</option>';
        
        const resp = await fetch(`${SCRIPT_URL}?endpoint=students&turma=${encodeURIComponent(turma)}`);
        const json = await resp.json();
        
        console.log('Resposta completa do backend:', json);

        // CORRE√á√ÉO: Verificar a estrutura da resposta
        if (json.status === 'success') {
          if (json.studentsList && Array.isArray(json.studentsList)) {
            alunosComRA = json.studentsList;
          } else {
            alunosComRA = [];
          }
          
          alunoSelect.innerHTML = '<option value="">-- Selecione o aluno --</option>';
          
          if (alunosComRA.length > 0) {
            alunosComRA.forEach(aluno => {
              const option = document.createElement('option');
              option.value = aluno.nome;
              option.textContent = aluno.nome;
              option.setAttribute('data-ra', aluno.ra || '');
              alunoSelect.appendChild(option);
            });
            console.log(`Carregados ${alunosComRA.length} alunos`);
          } else {
            alunoSelect.innerHTML = '<option value="">Nenhum aluno encontrado</option>';
            showNotification('error', 'Nenhum aluno encontrado para esta turma');
          }
        } else {
          // CORRE√á√ÉO: Mostrar mensagem de erro espec√≠fica
          alunoSelect.innerHTML = '<option value="">Erro ao carregar</option>';
          const errorMsg = json.message || 'Erro desconhecido';
          showNotification('error', `Erro: ${errorMsg}`);
          console.error('Erro na resposta:', json);
        }
        
      } catch(err) {
        console.error('Erro ao carregar alunos (gest√£o):', err);
        document.getElementById('aluno_gestao').innerHTML = '<option value="">Erro ao carregar</option>';
        showNotification('error', 'Erro de conex√£o ao carregar alunos');
      }
    }
    
    // CORRE√á√ÉO: Preencher RA quando selecionar um aluno
    function preencherRAGestao() {
      const alunoSelect = document.getElementById('aluno_gestao');
      const selectedOption = alunoSelect.options[alunoSelect.selectedIndex];
      
      if (selectedOption && selectedOption.value) {
        // CORRE√á√ÉO: Pegar o RA do atributo data-ra
        const ra = selectedOption.getAttribute('data-ra') || '';
        document.getElementById('ra_gestao').value = ra;
        console.log('RA preenchido:', ra);
      } else {
        document.getElementById('ra_gestao').value = '';
      }
    }

    /*******************************
     * POST cadastrar ocorr√™ncia (gest√£o) - CORRIGIDO
     *******************************/
    async function cadastrarOcorrenciaGestao(){
      const aluno = document.getElementById('aluno_gestao').value;
      const serie = document.getElementById('serie_gestao').value;
      const professor = document.getElementById('professor_gestao').value.trim();
      const disciplina = document.getElementById('disciplina_gestao').value.trim();
      const classificacao = document.getElementById('classificacao_gestao').value;
      const descricao = document.getElementById('descricao_gestao').value.trim();
      const dataRetorno = document.getElementById('dataRetorno_gestao').value || '';
      const ra = document.getElementById('ra_gestao').value;

      // Valida√ß√£o
      if(!aluno || !serie || !professor || !disciplina || !classificacao || !descricao){ 
        showNotification('error', 'Preencha todos os campos obrigat√≥rios.');
        return; 
      }
      if(classificacao === 'SUSPENS√ÉO' && !dataRetorno){ 
        showNotification('error', 'Informe data de retorno para suspens√£o.');
        return; 
      }

      // CORRE√á√ÉO: Payload simplificado e correto
      const payload = {
        endpoint: 'create-occurrence',
        sheet: SHEET_GESTAO,
        date: new Date().toISOString().split('T')[0],
        professor: professor,
        studentClass: serie,
        student: aluno,
        ra: ra,
        disciplina: disciplina,
        irregularities: classificacao + (dataRetorno ? (' - retorno: ' + dataRetorno) : ''),
        description: descricao
      };

      console.log('Enviando payload gest√£o:', payload);

      try {
        const resp = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        
        const j = await resp.json();
        console.log('Resposta backend gest√£o:', j);
        
        if(j && j.status === 'success'){
          showNotification('success', 'Ocorr√™ncia registrada com sucesso!');
          // Limpar formul√°rio
          document.getElementById('serie_gestao').value = '';
          document.getElementById('aluno_gestao').innerHTML = '<option value="">-- Selecione o aluno --</option>';
          document.getElementById('ra_gestao').value = '';
          document.getElementById('professor_gestao').value = '';
          document.getElementById('disciplina_gestao').value = '';
          document.getElementById('classificacao_gestao').value = '';
          document.getElementById('descricao_gestao').value = '';
          document.getElementById('dataRetorno_gestao').value = '';
          document.getElementById('suspensionRow_gestao').style.display = 'none';
          
          // Recarregar hist√≥rico
          setTimeout(() => carregarHistoricoGestao(), 1000);
        } else {
          showNotification('error', j.message || 'Erro ao registrar ocorr√™ncia!');
        }
      } catch(err){
        console.error('Erro POST ocorrencia (gestao):', err);
        showNotification('error', 'Falha na comunica√ß√£o com servidor');
      }
    }

    /*******************************
     * √ÅREA DO PROFESSOR - COMPLETA
     *******************************/

    async function carregarProfessoresETurmas(){
      try {
        // Carregar professores
        const r1 = await fetch(`${SCRIPT_URL}?endpoint=teachers`);
        const j1 = await r1.json();
        if(j1 && j1.status === 'success' && Array.isArray(j1.teachers)) {
          professores = j1.teachers;
        } else {
          professores = getFallbackProfessores();
        }

        const profSel = document.getElementById('professor_select');
        profSel.innerHTML = '<option value="">-- selecione --</option>';
        professores.forEach(p => { 
          const o = document.createElement('option'); 
          o.value = p; 
          o.textContent = p; 
          profSel.appendChild(o); 
        });

        // Carregar turmas
        const r2 = await fetch(`${SCRIPT_URL}?endpoint=classes`);
        const j2 = await r2.json();
        if(j2 && j2.status === 'success' && Array.isArray(j2.classes)) {
          turmas = j2.classes;
        } else {
          turmas = Object.keys(_getClassRanges());
        }

        const turmaSel = document.getElementById('turma_select');
        turmaSel.innerHTML = '<option value="">-- selecione --</option>';
        turmas.forEach(t => { 
          const o = document.createElement('option'); 
          o.value = t; 
          o.textContent = t; 
          turmaSel.appendChild(o); 
        });
        
      } catch(err){
        console.error('Erro carregar professores/turmas:', err);
        // fallback
        professores = getFallbackProfessores();
        turmas = Object.keys(_getClassRanges());
        
        const profSel = document.getElementById('professor_select');
        profSel.innerHTML = '<option value="">-- selecione --</option>';
        professores.forEach(p => { 
          const o = document.createElement('option'); 
          o.value = p; 
          o.textContent = p; 
          profSel.appendChild(o); 
        });
        
        const turmaSel = document.getElementById('turma_select');
        turmaSel.innerHTML = '<option value="">-- selecione --</option>';
        turmas.forEach(t => { 
          const o = document.createElement('option'); 
          o.value = t; 
          o.textContent = t; 
          turmaSel.appendChild(o); 
        });
      }
    }

    async function onTurmaChange(){
      const turma = document.getElementById('turma_select').value;
      if(!turma){ 
        alunosDaTurmaAtual = []; 
        return; 
      }
      await carregarAlunosPorTurma(turma);
    }

    // CORRE√á√ÉO: Fun√ß√£o para carregar alunos do professor
    async function carregarAlunosPorTurma(turma){
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=students&turma=${encodeURIComponent(turma)}`);
        const json = await resp.json();
        
        console.log('Resposta alunos professor:', json);
        
        if (json.status === 'success') {
          // Usar students para professores (apenas nomes)
          alunosDaTurmaAtual = json.students || [];
          console.log(`Carregados ${alunosDaTurmaAtual.length} alunos para professor`);
        } else {
          alunosDaTurmaAtual = [];
          console.error('Erro ao carregar alunos:', json.message);
          showNotification('error', `Erro ao carregar alunos: ${json.message}`);
        }
      } catch(err){
        console.error('Erro get students:', err);
        alunosDaTurmaAtual = [];
        showNotification('error', 'Erro de conex√£o ao carregar alunos');
      }
    }

    /*******************************
     * Modal alunos (professor) - COMPLETO
     *******************************/
    function openStudentsModal(){
      if(!alunosDaTurmaAtual || alunosDaTurmaAtual.length === 0){ 
        showNotification('error', 'Nenhum aluno encontrado para a turma selecionada.'); 
        return; 
      }
      document.getElementById('modalRoot').style.display = 'flex';
      renderStudentList(alunosDaTurmaAtual);
      document.getElementById('studentSearch').value = '';
    }
    
    function closeStudentsModal(){ 
      document.getElementById('modalRoot').style.display = 'none'; 
    }

    function renderStudentList(list){
      const container = document.getElementById('studentList'); 
      container.innerHTML = '';
      
      list.forEach(nome => {
        const row = document.createElement('div'); 
        row.className = 'student-row';
        if (alunosSelecionados.includes(nome)) {
          row.classList.add('selected');
        }
        
        const lbl = document.createElement('div'); 
        lbl.className = 'student-name';
        lbl.textContent = nome;
        
        const cb = document.createElement('input'); 
        cb.type='checkbox'; 
        cb.value = nome; 
        cb.checked = alunosSelecionados.includes(nome);
        
        cb.onchange = (e) => { 
          toggleStudentSelection(nome, e.target.checked);
          updateStudentRowStyle(row, nome);
        };
        
        row.onclick = (e) => {
          if (e.target !== cb) {
            const newState = !alunosSelecionados.includes(nome);
            cb.checked = newState;
            toggleStudentSelection(nome, newState);
            updateStudentRowStyle(row, nome);
          }
        };
        
        row.appendChild(lbl); 
        row.appendChild(cb); 
        container.appendChild(row);
      });
    }
    
    function toggleStudentSelection(nome, isSelected) {
      if(isSelected){ 
        if(!alunosSelecionados.includes(nome)) alunosSelecionados.push(nome); 
      } else {
        alunosSelecionados = alunosSelecionados.filter(x => x !== nome); 
      }
    }
    
    function updateStudentRowStyle(row, nome) {
      if (alunosSelecionados.includes(nome)) {
        row.classList.add('selected');
      } else {
        row.classList.remove('selected');
      }
    }

    function filterStudentList(){ 
      const q = document.getElementById('studentSearch').value.toLowerCase(); 
      const filtered = alunosDaTurmaAtual.filter(s => s.toLowerCase().includes(q)); 
      renderStudentList(filtered); 
    }

    function confirmStudents(){
      document.getElementById('alunos_selected_input').value = alunosSelecionados.join(', ');
      const pills = document.getElementById('selectedPills'); 
      pills.innerHTML = '';
      alunosSelecionados.forEach(a => { 
        const el = document.createElement('div'); 
        el.className='pill'; 
        el.textContent = a; 
        pills.appendChild(el); 
      });
      closeStudentsModal();
    }

    /*******************************
     * POST registrar ocorr√™ncia (professor) - CORRIGIDO
     *******************************/
    async function registrarOcorrenciaProfessor(){
      const professor = document.getElementById('professor_select').value;
      const turma = document.getElementById('turma_select').value;
      const dataOc = document.getElementById('data_prof').value;
      const descricao = document.getElementById('descricao_prof').value.trim();
      
      if(!professor || !turma || !dataOc || alunosSelecionados.length === 0){ 
        showNotification('error', 'Preencha todos os campos obrigat√≥rios e selecione ao menos um aluno.');
        return; 
      }
      
      const irregs = Array.from(document.querySelectorAll('input[name="irreg"]:checked')).map(x=>x.value);
      
      // CORRE√á√ÉO: Payload simplificado e correto
      const payload = { 
        endpoint: 'create-occurrence',
        sheet: SHEET_PROF,
        date: dataOc, 
        professor: professor, 
        studentClass: turma, 
        student: alunosSelecionados.join(', '), 
        irregularities: irregs.join(', '), 
        description: descricao 
      };
      
      console.log('Enviando payload professor:', payload);

      try {
        const resp = await fetch(SCRIPT_URL, { 
          method: 'POST', 
          headers: {'Content-Type': 'application/json'}, 
          body: JSON.stringify(payload) 
        });
        
        const j = await resp.json();
        console.log('Resposta backend professor:', j);
        
        if(j && j.status === 'success'){
          showNotification('success', 'Ocorr√™ncia registrada com sucesso!');
          clearProfessorForm();
          setTimeout(() => carregarHistoricoProfessor(), 1000);
        } else {
          showNotification('error', j.message || 'Erro ao registrar ocorr√™ncia!');
        }
      } catch(err){
        console.error('Erro POST ocorrencia (professor):', err);
        showNotification('error', 'Falha na comunica√ß√£o com servidor');
      }
    }

    function clearProfessorForm(){
      document.getElementById('professor_select').value = ''; 
      document.getElementById('turma_select').value = ''; 
      document.getElementById('alunos_selected_input').value = ''; 
      document.getElementById('selectedPills').innerHTML = ''; 
      document.getElementById('descricao_prof').value = ''; 
      alunosSelecionados = []; 
      Array.from(document.querySelectorAll('input[name="irreg"]')).forEach(cb => cb.checked = false); 
      document.getElementById('data_prof').value = new Date().toISOString().split('T')[0];
    }

    /*******************************
     * Toggle suspens√£o (gest√£o)
     *******************************/
    function toggleSuspension(area){
      if(area === 'gestao'){ 
        const val = document.getElementById('classificacao_gestao').value; 
        document.getElementById('suspensionRow_gestao').style.display = (val === 'SUSPENS√ÉO') ? 'flex' : 'none'; 
      }
    }

    /*******************************
     * Hist√≥ricos - COMPLETOS
     *******************************/
    async function carregarHistoricoGestao(){
      const container = document.getElementById('historyListGestao');
      container.innerHTML = `<div style="display:flex;align-items:center;gap:8px">Carregando hist√≥rico...</div>`;
      
      try {
        // CORRE√á√ÉO: Especificar a aba correta
        const resp = await fetch(`${SCRIPT_URL}?endpoint=occurrences&sheet=${SHEET_GESTAO}`);
        const json = await resp.json();
        const ocorrs = json.occurrences || [];
        
        container.innerHTML = '';
        if(!ocorrs || ocorrs.length === 0){ 
          container.innerHTML = '<div class="muted">Nenhuma ocorr√™ncia encontrada.</div>'; 
          return; 
        }

        ocorrs.slice().reverse().forEach(r => {
          const id = r.id || '';
          const date = r.data || r.DATA || '';
          const prof = r.professor || r.PROFESSOR || '';
          const turma = r.studentclass || r.TURMA || '';
          const aluno = r.student || r.ALUNO || '';
          const irreg = r.irregularities || r.IRREGULARIDADES || '';
          const desc = r.description || r.DESCRICAO || '';

          const div = document.createElement('div'); 
          div.className='historyItem';
          
          const meta = document.createElement('div'); 
          meta.className='meta';
          meta.innerHTML = `<div><strong>${date}</strong> ‚Äî <span class="muted">${prof}</span></div>`;
          
          const ddesc = document.createElement('div'); 
          ddesc.className='desc';
          ddesc.innerHTML = `
            <strong>Aluno(s):</strong> ${aluno || 'N/A'}<br/>
            <strong>Turma:</strong> ${turma || 'N/A'}<br/>
            <strong>Irregularidades:</strong> ${irreg || 'N/A'}<br/>
            <em>${desc || ''}</em>
          `;

          div.appendChild(meta); 
          div.appendChild(ddesc);
          container.appendChild(div);
        });
      } catch(err){
        console.error('Erro carregarHistoricoGestao:', err);
        container.innerHTML = '<div class="muted">Erro ao carregar hist√≥rico</div>';
      }
    }

    async function carregarHistoricoProfessor(){
      const container = document.getElementById('historyListProfessor');
      container.innerHTML = `<div style="display:flex;align-items:center;gap:8px">Carregando hist√≥rico...</div>`;
      
      try {
        // CORRE√á√ÉO: Especificar a aba correta
        const resp = await fetch(`${SCRIPT_URL}?endpoint=occurrences&sheet=${SHEET_PROF}`);
        const json = await resp.json();
        const ocorrs = json.occurrences || [];
        
        container.innerHTML = '';
        if(!ocorrs || ocorrs.length === 0){ 
          container.innerHTML = '<div class="muted">Nenhuma ocorr√™ncia encontrada.</div>'; 
          return; 
        }

        ocorrs.slice().reverse().forEach(r => {
          const id = r.id || '';
          const date = r.data || r.DATA || '';
          const prof = r.professor || r.PROFESSOR || '';
          const turma = r.studentclass || r.TURMA || '';
          const aluno = r.student || r.ALUNO || '';
          const irreg = r.irregularities || r.IRREGULARIDADES || '';
          const desc = r.description || r.DESCRICAO || '';

          const div = document.createElement('div'); 
          div.className='historyItem';
          
          const meta = document.createElement('div'); 
          meta.className='meta';
          meta.innerHTML = `<div><strong>${date}</strong> ‚Äî <span class="muted">${prof}</span></div>`;
          
          const ddesc = document.createElement('div'); 
          ddesc.className='desc';
          ddesc.innerHTML = `
            <strong>Aluno(s):</strong> ${aluno || 'N/A'}<br/>
            <strong>Turma:</strong> ${turma || 'N/A'}<br/>
            <strong>Irregularidades:</strong> ${irreg || 'N/A'}<br/>
            <em>${desc || ''}</em>
          `;

          div.appendChild(meta); 
          div.appendChild(ddesc);
          container.appendChild(div);
        });
      } catch(err){
        console.error('Erro carregarHistoricoProfessor:', err);
        container.innerHTML = '<div class="muted">Erro ao carregar hist√≥rico</div>';
      }
    }

    /*******************************
     * Gera√ß√£o de PDF local
     *******************************/
    function generatePDFLocal(){
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text('Registro de Ocorr√™ncia', 14, 20);
        const aluno = document.getElementById('aluno_gestao').value || '';
        const turma = document.getElementById('serie_gestao').value || '';
        const prof = document.getElementById('professor_gestao').value || '';
        const desc = document.getElementById('descricao_gestao').value || '';
        let y = 36;
        if(aluno){ doc.text(`Aluno: ${aluno}`, 14, y); y+=8; }
        if(turma){ doc.text(`Turma: ${turma}`, 14, y); y+=8; }
        if(prof){ doc.text(`Professor: ${prof}`, 14, y); y+=8; }
        doc.text('Descri√ß√£o:', 14, y); y+=8;
        const split = doc.splitTextToSize(desc || 'Sem descri√ß√£o', 180);
        doc.text(split, 14, y);
        doc.save(`ocorrencia_${Date.now()}.pdf`);
      } catch(err){ 
        console.error('Erro gerar PDF local:', err); 
        showNotification('error', 'Erro ao gerar PDF local');
      }
    }

    /*******************************
     * utilit√°rios / fallbacks - COMPLETOS
     *******************************/
    function _getClassRanges() {
      return {
        "6¬∞ ANO A MANHA":"6¬∞ ANO A MANHA","6¬∞ ANO B MANHA":"6¬∞ ANO B MANHA",
        "6¬∞ ANO C MANHA":"6¬∞ ANO C MANHA","6¬∞ ANO D MANHA":"6¬∞ ANO D MANHA",
        "6¬∞ ANO E TARDE":"6¬∞ ANO E TARDE","6¬∞ ANO F TARDE":"6¬∞ ANO F TARDE",
        "7¬∞ ANO A TARDE":"7¬∞ ANO A TARDE","7¬∞ ANO B TARDE":"7¬∞ ANO B TARDE",
        "7¬∞ ANO C TARDE":"7¬∞ ANO C TARDE","7¬∞ ANO D TARDE":"7¬∞ ANO D TARDE",
        "7¬∞ ANO E TARDE":"7¬∞ ANO E TARDE","7¬∞ ANO F TARDE":"7¬∞ ANO F TARDE",
        "8¬∞ ANO A TARDE":"8¬∞ ANO A TARDE","8¬∞ ANO B TARDE":"8¬∞ ANO B TARDE",
        "8¬∞ ANO C TARDE":"8¬∞ ANO C TARDE","8¬∞ ANO D TARDE":"8¬∞ ANO D TARDE",
        "9¬∞ ANO A TARDE":"9¬∞ ANO A TARDE","9¬∞ ANO B TARDE":"9¬∞ ANO B TARDE",
        "9¬∞ ANO C TARDE":"9¬∞ ANO C TARDE","9¬∞ ANO D TARDE":"9¬∞ ANO D TARDE",
        "1¬™ SERIE A MANHA":"1¬™ SERIE A MANHA","1¬™ SERIE B MANHA":"1¬™ SERIE B MANHA",
        "1¬™ SERIE C MANHA":"1¬™ SERIE C MANHA","1¬™ SERIE D MANHA":"1¬™ SERIE D MANHA",
        "1¬™ SERIE E MANHA":"1¬™ SERIE E MANHA","1¬™ SERIE F MANHA":"1¬™ SERIE F MANHA",
        "1¬™ SERIE G TARDE":"1¬™ SERIE G TARDE","1¬™ SERIE H NOITE":"1¬™ SERIE H NOITE",
        "1¬™ SERIE I NOITE":"1¬™ SERIE I NOITE","2¬™ SERIE A MANHA":"2¬™ SERIE A MANHA",
        "2¬™ SERIE B MANHA":"2¬™ SERIE B MANHA","2¬™ SERIE C MANHA":"2¬™ SERIE C MANHA",
        "2¬™ SERIE D MANHA":"2¬™ SERIE D MANHA","2¬™ SERIE E MANHA":"2¬™ SERIE E MANHA",
        "2¬™ SERIE F NOITE":"2¬™ SERIE F NOITE","2¬™ SERIE G NOITE":"2¬™ SERIE G NOITE",
        "2¬™ SERIE H NOITE":"2¬™ SERIE H NOITE","3¬™ SERIE A MANHA":"3¬™ SERIE A MANHA",
        "3¬™ SERIE B MANHA":"3¬™ SERIE B MANHA","3¬™ SERIE C MANHA":"3¬™ SERIE C MANHA",
        "3¬™ SERIE D NOITE":"3¬™ SERIE D NOITE","3¬™ SERIE E NOITE":"3¬™ SERIE E NOITE",
        "3¬™ SERIE F NOITE":"3¬™ SERIE F NOITE"
      };
    }

    function getFallbackProfessores(){
      return [
        "ALEX LUTH PEREIRA MARANHAO","ALEXSANDRA PAULA VARELLA DE SOUZA","ALISON VASCONCELOS BESERRA","AMAURI TEODORO DE OLIVEIRA",
        "ANA PAULA DOS SANTOS","ANDREIA DOS SANTOS FREITAS","ANDREIA MADUREIRA REIS","ANTONIO CARLOS DE OLIVEIRA",
        "ANTONIO RAMS DE ARAUJO","ANTONIO WILTON WANDERLEY CABRAL","AUGUSTO LINO PESSOA NETO","AUREA MARIA DE JESUS MARQUES",
        "CAROLINA PERNOMIAN PARUSSOLOLO","CASSIA OLIVEIRA ANTONIAZI","CLAUDINEIA DE AGUIAR LIMA","DANIEL DE FREITAS ALMEIDA",
        "DANIEL LOPES BARBOSA","DANIELA FERREIRA LIMA","DANIELLE LUCIA BATISTA DE ALMEIDA","EDIANE VIEIRA DA SILVA",
        "EDILEUSA NUNES PEREIRA","EDUARDO HENRIQUE DA FONSECA","ELIANE SANTOS SILVA","ELIAS MONTEIRO DA SILVERA",
        "ELISABETE APARECIDA PIRES","ELZA DE FARIA PEREIRA","EMERSON GABLER DE ALMEIDA","EUZELI ARAUJO DE OLIVEIRA",
        "FABIANO AUGUSTO PIEDADE","FABIO CAMILO","FERNANDO JOSE DA SILVA FILHO","FLAVIA CRISTINA APARECIDA BICHLER",
        "FLAVIO CARDOSO FLEURY","FRANCISCA EDIVANIA DE MORAIS COSTA","GABRIELA SERIGHELLI DE MELO","GELSON DE ALMEIDA BATISTA",
        "GENILTON DE OLIVEIRA SILVA","GIANI CRISTINA DO PRADO","INGRYD CAROLINA SUGUIMOTO VIEIRA","IVANILDES DOS SANTOS OSHIKAWA",
        "JANINA DOS PASSOS BRAGA DE ALMEIDA","JOSE APARECIDO DA SILVA","JUAREZ GOMES DE MAGALHAES FILHO","JUREMA SOLEDADE FURINI SANTOS",
        "KATIUSCIA ALVES BOMFIM","LUANA CAROLINE ALVES LIMA","LUANA DE FREITAS SILVA","LUCIANA NOVAIS CORREIA SANTOS",
        "LUCIANO MOREIRA DE AZEVEDO","MARCIEL DA SILVA","MARIA HELENA CUNHA MORO","MARIA QUIT√âRIA FERREIRA DOS SANTOS",
        "MARINA DA CONCEICAO FRANCISCO SILVA","MAURICIO DE BARROS SANTOS","MICHELE DE PINHO MORAES","MOISES ANTONIO DE BARROS",
        "PAULA ARMANI VILA","PAULO ROBERTO DA SILVA ITO","PEDRO ZANOTTI FILHO","RAUL PEREIRA VILERA JUNIOR",
        "REGIANE CURTI DE SOUZA OLIVEIRA","REGINA DA SILSA CASTRO","RICARDO AMERICO DA SILVA","ROBERTO SALGADO",
        "RODRIGO VIEIRA","ROSANGELA CAFASSO MOREIRA","ROSIMERY DE SOUZA PESSOA","ROSMARA DA SILSA CARDOSO",
        "SANDRA CRISTINA MACEDO MORAES","SELMA GOMES DA SILSA","SERGIO AGRIPINO VILLA NOVA","SOLANGE ALMEIDA DA SILSA",
        "SUZINEIDE SILSA DE FREITAS","THIAGO FABIANO BRITO","TITTO AUGUSTO NASCIMENTO SILSA","VANDERSON HYPPOLITO",
        "VANESSA IVETE GOMES DOS SANTOS","VANIA PENHA DE BARROS","VIVIANE LEAL CAMERA DE MORAES","WILSON RODRIGUES MOTA"
      ];
    }

  </script>
</body>
</html>
