<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cadastro de Ocorrências - 2025</title>

  <!-- jsPDF para geração local de PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* ===== Reset/Base ===== */
    * { box-sizing: border-box; margin:0; padding:0; }
    html,body{height:100%}
    body{
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #e6f2ff 0%, #e6ffe6 60%, #e6f9ff 100%);
      color:#333; font-weight:500; padding:20px;
    }
    .app{max-width:1200px;margin:0 auto;display:flex;flex-direction:column;gap:20px}
    
    /* Header Styles */
    header{
      display:flex;align-items:center;justify-content:space-between;padding:20px;
      border-radius:12px;background:linear-gradient(90deg,rgba(0,31,63,0.95),rgba(0,78,120,0.95));
      box-shadow:0 8px 30px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.1);
    }
    header h1{font-size:22px;margin:0;color:#fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2);}
    .header-controls{display:flex;gap:12px;align-items:center}
    
    /* Card Styles */
    .card{
      background:#fff;padding:24px;border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.1);border:1px solid #e0e0e0;
    }
    
    /* Layout */
    .flex-row{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap;}
    .flex-col{display:flex;flex-direction:column;gap:14px;}
    
    /* Form Sections with Gray Background and 3D effect */
    .form-section{
      background-color: #f0f0f0;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 18px;
      box-shadow: 
        inset 0 2px 4px rgba(0,0,0,0.05),
        0 4px 8px rgba(0,0,0,0.1);
      border: 1px solid #d0d0d0;
    }
    
    /* Form Elements */
    label{display:block;margin-bottom:8px;font-size:14px;font-weight:600;color:#444;}
    input[type="text"],input[type="email"],input[type="password"],select,textarea,input[type="date"]{
      width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;font-size:14px;color:#333;
      background-color: #ffffff;
      transition:border-color 0.3s, box-shadow 0.3s;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, 
    select:focus, textarea:focus, input[type="date"]:focus {
      border-color: #2a5298;
      outline: none;
      box-shadow: 0 0 0 2px rgba(42, 82, 152, 0.2), inset 0 1px 3px rgba(0,0,0,0.1);
    }
    textarea{min-height:110px;resize:vertical;padding-top:12px}
    
    /* Buttons */
    button{
      cursor:pointer;border:none;padding:12px 18px;border-radius:8px;font-weight:600;transition:all 0.2s;
      box-shadow: 0 3px 6px rgba(0,0,0,0.16);
    }
    .btn-primary{background:linear-gradient(90deg,#1e3c72,#2a5298);color:#fff;}
    .btn-primary:hover{background:linear-gradient(90deg,#2a5298,#3a6bd1);transform:translateY(-2px);box-shadow: 0 5px 10px rgba(0,0,0,0.2);}
    .btn-danger{background:linear-gradient(90deg,#e94b4b,#c62828);color:#fff;}
    .btn-danger:hover{background:linear-gradient(90deg,#c62828,#d32f2f);transform:translateY(-2px);box-shadow: 0 5px 10px rgba(0,0,0,0.2);}
    .btn-success{background:linear-gradient(90deg,#4CAF50,#2E7D32);color:#fff;}
    .btn-success:hover{background:linear-gradient(90deg,#2E7D32,#388E3C);transform:translateY(-2px);box-shadow: 0 5px 10px rgba(0,0,0,0.2);}
    .btn-secondary{background:linear-gradient(90deg,#6c757d,#5a6268);color:#fff;}
    .btn-secondary:hover{background:linear-gradient(90deg,#5a6268,#6c757d);transform:translateY(-2px);box-shadow: 0 5px 10px rgba(0,0,0,0.2);}
    
    /* Text Elements */
    .subtitle{
      font-size:18px;color:#2a5298;margin-bottom:14px;font-weight:600;padding-bottom:8px;
      border-bottom:2px solid #2a5298; text-shadow: 0 1px 1px rgba(0,0,0,0.05);
    }
    .section-title{font-size:15px;color:#2a5298;margin:15px 0 10px;font-weight:600;}
    
    /* History List */
    .historyList{max-height:420px;overflow:auto;display:flex;flex-direction:column;gap:12px;padding-right:8px}
    .historyItem{
      background:#f9f9f9;border-left:4px solid #2a5298;padding:18px;border-radius:8px;color:#333;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .historyItem .meta{font-size:14px;color:#666;font-weight:600;display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:10px;}
    .historyItem .desc{margin-top:10px;color:#555;font-weight:400;font-size:14px;line-height:1.5;}
    
    /* Modal */
    .modal-root{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:2000;}
    .modal{
      width:92%;max-width:780px;background:#fff;color:#333;border-radius:12px;padding:24px;
      max-height:84vh;overflow:auto;box-shadow:0 12px 36px rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);
    }
    .studentList{display:flex;flex-direction:column;gap:10px;}
    
    /* Pills and Tags */
    .pill{
      background:linear-gradient(90deg,#2a5298,#3a6bd1);color:#fff;padding:6px 14px;border-radius:20px;
      font-weight:600;display:inline-block;margin:0 6px 6px 0;font-size:13px;box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
    .muted{opacity:.7;font-weight:500;color:#666;}
    .qnum{color:#e53935;font-weight:700;}
    
    /* Login Options */
    .login-options {display: flex; gap: 14px; margin-bottom: 20px;}
    .login-option {
      flex: 1; text-align: center; padding: 18px; border-radius: 10px; cursor: pointer; 
      background: rgba(255,255,255,0.2); border: 2px solid transparent; transition: all 0.2s;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    .login-option.active {
      background: linear-gradient(90deg, rgba(0,78,120,0.8), rgba(0,120,120,0.8)); 
      color: #fff; border-color: #fff; box-shadow: 0 5px 12px rgba(0,0,0,0.2);
    }
    .login-option:hover {background: rgba(255,255,255,0.3); box-shadow: 0 4px 10px rgba(0,0,0,0.15);}
    .access-area {display: none;}
    
    /* Checkbox Styles */
    .checkbox-group {display: flex; flex-wrap: wrap; gap: 12px; margin: 12px 0;}
    .checkbox-item {
      display: flex; align-items: center; background: #f5f5f5; padding: 10px 14px; 
      border-radius: 20px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    .checkbox-item:hover {background: #e9e9e9; box-shadow: 0 3px 6px rgba(0,0,0,0.12);}
    .checkbox-item input {margin-right: 8px;}
    
    /* Form Groups */
    .form-group {margin-bottom: 18px; flex: 1;}
    .form-group-half {flex: 0 0 calc(50% - 12px);}
    .form-group-third {flex: 0 0 calc(33.333% - 12px);}
    .form-group-quarter {flex: 0 0 calc(25% - 12px);}
    
    /* Student Selection */
    .student-selector {
      padding: 14px; border: 1px solid #ddd; border-radius: 8px; background: #fff; 
      cursor: pointer; transition: all 0.2s; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    .student-selector:hover {background: #f0f0f0; border-color: #2a5298; box-shadow: inset 0 1px 4px rgba(0,0,0,0.15);}
    
    /* Responsive */
    @media(max-width:980px){
      .flex-row{flex-direction:column; gap: 12px;}
      header{flex-direction:column;gap:14px;align-items:flex-start;} 
      .login-options {flex-direction: column;}
      .form-group-half, .form-group-third, .form-group-quarter {flex: 1;}
      .card {padding: 18px;}
    }
    
    /* Loader animation */
    @keyframes spin{to{transform:rotate(360deg)}}
    .loader{width:20px;height:20px;border:3px solid rgba(0,0,0,0.1);border-top-color:#2a5298;border-radius:50%;animation:spin 1s linear infinite;display:inline-block}
    
    /* Student checkbox in modal */
    .student-checkbox {
      display: flex; align-items: center; padding: 14px; border-bottom: 1px solid #eee; 
      cursor: pointer; transition: background 0.2s; border-radius: 6px;
    }
    .student-checkbox:hover {background: #f0f4ff; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
    .student-checkbox input[type="checkbox"] {margin-right: 14px; transform: scale(1.3);}
    
    /* Custom styles for the redesign */
    .form-row {
      display: flex;
      gap: 18px;
      margin-bottom: 18px;
      align-items: flex-start;
    }
    
    .field-group {
      display: flex;
      flex-direction: column;
      flex: 1;
    }
    
    .date-field {
      cursor: pointer;
    }
    
    .date-field::-webkit-calendar-picker-indicator {
      cursor: pointer;
      padding: 5px;
      border-radius: 3px;
    }
    
    /* Success message */
    .success-message {
      display:none;margin-top:12px;background:linear-gradient(90deg,#4CAF50,#2E7D32);
      padding:14px;border-radius:8px;color:#fff;font-weight:600; box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- HEADER -->
    <header>
      <h1>2025 — Cadastro de Ocorrências</h1>
      <div class="header-controls">
        <div id="userDisplay" class="muted">Não autenticado</div>
        <button id="btnLogout" class="btn-danger" style="display:none" onclick="logout()">Sair</button>
        <button id="btnDownloadPdf" class="btn-success" style="display:none" onclick="downloadDocument()">Baixar Template</button>
      </div>
    </header>

    <!-- LOGIN -->
    <div id="loginScreen" class="card" style="display:block">
      <div style="max-width:500px;margin:0 auto">
        <div class="subtitle">Selecione o tipo de acesso</div>
        
        <div class="login-options">
          <div class="login-option active" id="optionGestao" onclick="selectLoginOption('gestao')">
            Acesso Gestão
          </div>
          <div class="login-option" id="optionProfessor" onclick="selectLoginOption('professor')">
            Acesso Professor
          </div>
        </div>
        
        <div id="loginFormGestao" class="access-area">
          <div class="form-section">
            <div class="form-row">
              <div class="field-group">
                <label for="emailGestao">E-mail Gestão</label>
                <input id="emailGestao" type="email" placeholder="gestao@escola.com">
              </div>
              <div class="field-group">
                <label for="passwordGestao">Senha</label>
                <input id="passwordGestao" type="password" placeholder="senha">
              </div>
            </div>
          </div>
          
          <div class="flex-row">
            <button class="btn-primary" onclick="login('gestao')">Entrar como Gestão</button>
            <button class="btn-danger" onclick="fillDemo('gestao')">Demo Gestão</button>
          </div>
        </div>
        
        <div id="loginFormProfessor" class="access-area">
          <div class="form-section">
            <div class="form-row">
              <div class="field-group">
                <label for="emailProfessor">E-mail Professor</label>
                <input id="emailProfessor" type="email" placeholder="professor@escola.com">
              </div>
              <div class="field-group">
                <label for="passwordProfessor">Senha</label>
                <input id="passwordProfessor" type="password" placeholder="senha">
              </div>
            </div>
          </div>
          
          <div class="flex-row">
            <button class="btn-primary" onclick="login('professor')">Entrar como Professor</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN APP - GESTÃO -->
    <div id="mainAppGestao" style="display:none;flex-direction:column;gap:16px">
      <div class="flex-row">
        <!-- GESTÃO -->
        <div class="card flex-col" style="flex:1">
          <div class="subtitle">CADASTRO — GESTÃO</div>
          
          <div class="form-section">
            <div class="form-row">
              <div class="field-group">
                <label>Série / Turma</label>
                <select id="serie_gestao" onchange="carregarAlunosPorTurmaGestao(this.value)">
                  <option value="">Selecione a turma</option>
                  <option value="6° ANO A MANHA">6° ANO A MANHA</option>
                  <option value="6° ANO B MANHA">6° ANO B MANHA</option>
                  <option value="6° ANO C MANHA">6° ANO C MANHA</option>
                  <option value="6° ANO D MANHA">6° ANO D MANHA</option>
                  <option value="6° ANO E TARDE">6° ANO E TARDE</option>
                  <option value="6° ANO F TARDE">6° ANO F TARDE</option>
                  <option value="7° ANO A TARDE">7° ANO A TARDE</option>
                  <option value="7° ANO B TARDE">7° ANO B TARDE</option>
                  <option value="7° ANO C TARDE">7° ANO C TARDE</option>
                  <option value="7° ANO D TARDE">7° ANO D TARDE</option>
                  <option value="7° ANO E TARDE">7° ANO E TARDE</option>
                  <option value="7° ANO F TARDE">7° ANO F TARDE</option>
                  <option value="8° ANO A TARDE">8° ANO A TARDE</option>
                  <option value="8° ANO B TARDE">8° ANO B TARDE</option>
                  <option value="8° ANO C TARDE">8° ANO C TARDE</option>
                  <option value="8° ANO D TARDE">8° ANO D TARDE</option>
                  <option value="8° ANO E TARDE">8° ANO E TARDE</option>
                  <option value="9° ANO A TARDE">9° ANO A TARDE</option>
                  <option value="9° ANO B TARDE">9° ANO B TARDE</option>
                  <option value="9° ANO C TARDE">9° ANO C TARDE</option>
                  <option value="9° ANO D TARDE">9° ANO D TARDE</option>
                  <option value="1ª SERIE A MANHA">1ª SERIE A MANHA</option>
                  <option value="1ª SERIE B MANHA">1ª SERIE B MANHA</option>
                  <option value="1ª SERIE C MANHA">1ª SERIE C MANHA</option>
                  <option value="1ª SERIE D MANHA">1ª SERIE D MANHA</option>
                  <option value="1ª SERIE E MANHA">1ª SERIE E MANHA</option>
                  <option value="1ª SERIE F MANHA">1ª SERIE F MANHA</option>
                  <option value="1ª SERIE G TARDE">1ª SERIE G TARDE</option>
                  <option value="1ª SERIE H NOITE">1ª SERIE H NOITE</option>
                  <option value="1ª SERIE I NOITE">1ª SERIE I NOITE</option>
                  <option value="2ª SERIE A MANHA">2ª SERIE A MANHA</option>
                  <option value="2ª SERIE B MANHA">2ª SERIE B MANHA</option>
                  <option value="2ª SERIE C MANHA">2ª SERIE C MANHA</option>
                  <option value="2ª SERIE D MANHA">2ª SERIE D MANHA</option>
                  <option value="2ª SERIE E MANHA">2ª SERIE E MANHA</option>
                  <option value="2ª SERIE F NOITE">2ª SERIE F NOITE</option>
                  <option value="2ª SERIE G NOITE">2ª SERIE G NOITE</option>
                  <option value="2ª SERIE H NOITE">2ª SERIE H NOITE</option>
                  <option value="3ª SERIE A MANHA">3ª SERIE A MANHA</option>
                  <option value="3ª SERIE B MANHA">3ª SERIE B MANHA</option>
                  <option value="3ª SERIE C MANHA">3ª SERIE C MANHA</option>
                  <option value="3ª SERIE D NOITE">3ª SERIE D NOITE</option>
                  <option value="3ª SERIE E NOITE">3ª SERIE E NOITE</option>
                  <option value="3ª SERIE F NOITE">3ª SERIE F NOITE</option>
                  <option value="3ª SERIE G NOITE">3ª SERIE G NOITE</option>
                </select>
              </div>
              
              <div class="field-group">
                <label>Aluno(s)</label>
                <div class="student-selector" onclick="openStudentsModalGestao()">
                  <span id="aluno_gestao_placeholder">Selecione a turma e depois clique para escolher os alunos</span>
                </div>
                <div id="selectedPillsGestao" style="margin-top:10px"></div>
              </div>
            </div>
            
            <div class="form-row">
              <div class="field-group">
                <label>RA(s)</label>
                <input id="ra_gestao" type="text" readonly>
              </div>
            </div>
          </div>
          
          <div class="form-section">
            <div class="form-row">
              <div class="field-group">
                <label>Professor</label>
                <input id="professor_gestao" type="text" placeholder="Nome do professor">
              </div>
              
              <div class="field-group">
                <label>Disciplina</label>
                <input id="disciplina_gestao" type="text" placeholder="Disciplina">
              </div>
            </div>
            
            <div class="form-row">
              <div class="field-group">
                <label>Classificação</label>
                <select id="classificacao_gestao">
                  <option value="">Selecione a classificação</option>
                  <option value="LEVE">LEVE</option>
                  <option value="MODERADA">MODERADA</option>
                  <option value="GRAVE">GRAVE</option>
                  <option value="GRAVÍSSIMA">GRAVÍSSIMA</option>
                </select>
              </div>
              
              <div class="field-group">
                <label>Data</label>
                <input id="data_gestao" type="date" class="date-field">
              </div>
            </div>
          </div>
          
          <div class="form-section">
            <label>Irregularidades</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" name="irreg_gestao" value="Agressão física">
                <span>Agressão física</span>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" name="irreg_gestao" value="Agressão verbal">
                <span>Agressão verbal</span>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" name="irreg_gestao" value="Desrespeito">
                <span>Desrespeito</span>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" name="irreg_gestao" value="Indisciplina">
                <span>Indisciplina</span>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" name="irreg_gestao" value="Falta de material">
                <span>Falta de material</span>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" name="irreg_gestao" value="Não fez atividade">
                <span>Não fez atividade</span>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" name="irreg_gestao" value="Uso de celular">
                <span>Uso de celular</span>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" name="irreg_gestao" value="Conversa excessiva">
                <span>Conversa excessiva</span>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" name="irreg_gestao" value="Saída sem autorização">
                <span>Saída sem autorização</span>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" name="irreg_gestao" value="Outros">
                <span>Outros</span>
              </div>
            </div>
          </div>
          
          <div class="form-section">
            <label>Descrição detalhada</label>
            <textarea id="descricao_gestao" placeholder="Descreva detalhadamente a ocorrência..."></textarea>
          </div>
          
          <div class="flex-row">
            <button class="btn-primary" onclick="registrarOcorrenciaGestao()">Registrar Ocorrência</button>
            <button class="btn-secondary" onclick="clearGestaoForm()">Limpar Formulário</button>
          </div>
          
          <div id="successMessageGestao" class="success-message">
            Ocorrência registrada com sucesso!
          </div>
        </div>
      </div>

      <!-- HISTÓRICO GESTÃO -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
          <div class="subtitle">HISTÓRICO DE OCORRÊNCIAS - GESTÃO</div>
          <div style="display:flex;gap:10px;align-items:center">
            <button class="btn-primary" onclick="carregarHistoricoGestao()">Atualizar</button>
          </div>
        </div>
        <div id="historyListGestao" class="historyList"></div>
      </div>
    </div> <!-- mainAppGestao -->

    <!-- MAIN APP - PROFESSOR -->
    <div id="mainAppProfessor" style="display:none;flex-direction:column;gap:16px">
      <div class="flex-row">
        <!-- PROFESSOR -->
        <div class="card flex-col" style="flex:1">
          <div class="subtitle">CADASTRO — PROFESSOR</div>
          
          <div class="form-section">
            <div class="form-row">
              <div class="field-group">
                <label>Professor</label>
                <select id="professor_select">
                  <option value="">-- selecione --</option>
                </select>
              </div>
              
              <div class="field-group">
                <label>Turma</label>
                <select id="turma_select" onchange="onTurmaChange()">
                  <option value="">-- selecione --</option>
                </select>
              </div>
            </div>
            
            <div class="form-row">
              <div class="field-group">
                <label>Aluno(s)</label>
                <div class="student-selector" onclick="openStudentsModal()">
                  <span id="alunos_selected_placeholder">Clique para selecionar</span>
                </div>
                <div id="selectedPills" style="margin-top:10px"></div>
              </div>
              
              <div class="field-group">
                <label>Data</label>
                <input id="data_prof" type="date" class="date-field">
              </div>
            </div>
          </div>
          
          <div class="form-section">
            <label>Irregularidades</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" name="irreg" value="Agressão física">
                <span>Agressão física</span>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" name="irreg" value="Agressão verbal">
                <span>Agressão verbal</span>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" name="irreg" value="Desrespeito">
                <span>Desrespeito</span>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" name="irreg" value="Indisciplina">
                <span>Indisciplina</span>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" name="irreg" value="Falta de material">
                <span>Falta de material</span>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" name="irreg" value="Não fez atividade">
                <span>Não fez atividade</span>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" name="irreg" value="Uso de celular">
                <span>Uso de celular</span>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" name="irreg" value="Conversa excessiva">
                <span>Conversa excessiva</span>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" name="irreg" value="Saída sem autorização">
                <span>Saída sem autorização</span>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" name="irreg" value="Outros">
                <span>Outros</span>
              </div>
            </div>
          </div>
          
          <div class="form-section">
            <label>Descrição detalhada</label>
            <textarea id="descricao_prof" placeholder="Descreva detalhadamente a ocorrência..."></textarea>
          </div>
          
          <div class="flex-row">
            <button class="btn-primary" onclick="registrarOcorrenciaProfessor()">Registrar Ocorrência</button>
            <button class="btn-secondary" onclick="clearProfessorForm()">Limpar Formulário</button>
          </div>
          
          <div id="successMessageProfessor" class="success-message">
            Ocorrência registrada com sucesso!
          </div>
        </div>
      </div>

      <!-- HISTÓRICO PROFESSOR -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
          <div class="subtitle">HISTÓRICO DE OCORRÊNCIAS - PROFESSOR</div>
          <div style="display:flex;gap:10px;align-items:center">
            <button class="btn-primary" onclick="carregarHistoricoProfessor()">Atualizar</button>
          </div>
        </div>
        <div id="historyListProfessor" class="historyList"></div>
      </div>
    </div> <!-- mainAppProfessor -->

    <!-- MODAL SELEÇÃO ALUNOS PROFESSOR -->
    <div id="modalRoot" class="modal-root">
      <div class="modal">
        <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
          <strong>Selecionar alunos</strong>
          <button onclick="closeStudentsModal()" style="background:transparent;border:none;font-weight:700;cursor:pointer;font-size:20px">✕</button>
        </header>

        <div>
          <input id="studentSearch" type="text" placeholder="Filtrar alunos..." style="width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;margin-bottom:18px" oninput="filterStudentList()">
          <div id="studentList" class="studentList"></div>
        </div>

        <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:18px">
          <button class="btn-primary" onclick="confirmStudents()">Confirmar</button>
          <button class="btn-danger" onclick="closeStudentsModal()">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- MODAL SELEÇÃO ALUNOS GESTÃO -->
    <div id="modalRootGestao" class="modal-root">
      <div class="modal">
        <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
          <strong>Selecionar alunos</strong>
          <button onclick="closeStudentsModalGestao()" style="background:transparent;border:none;font-weight:700;cursor:pointer;font-size:20px">✕</button>
        </header>

        <div>
          <input id="studentSearchGestao" type="text" placeholder="Filtrar alunos..." style="width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;margin-bottom:18px" oninput="filterStudentListGestao()">
          <div id="studentListGestao" class="studentList"></div>
        </div>

        <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:18px">
          <button class="btn-primary" onclick="confirmStudentsGestao()">Confirmar</button>
          <button class="btn-danger" onclick="closeStudentsModalGestao()">Cancelar</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    /*******************************
     * CONFIGURAÇÕES
     *******************************/
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxjonOBO3OZrn4pxs4Zkj_TGjwinO_XZfTZ7AlQSKvultZj7gzGQemU7GkFhatLMagS/exec';
    const SPREADSHEET_ID = '1u7qMsMHkZT47OZdar5qvshQDRA8XJrLgDjAZVOViAio';

    // nomes de abas (front-end manda "sheet" para o Apps Script)
    const SHEET_GERAL = 'BANCODEDADOSGERAL';
    const SHEET_PROF = 'OCORRENCIASDOSPROFESSORES'; // onde professores gravam (a partir de A2)
    const SHEET_GESTAO = 'BANCODEALUNOS'; // onde gestão grava (a partir de A2)

    // estado
    let allAlunos = [];
    let alunosDaTurmaAtual = [];
    let alunosSelecionados = [];
    let alunosDaTurmaAtualGestao = [];
    let alunosSelecionadosGestao = [];
    let alunosComRA = []; // Para armazenar alunos com seus RAs
    let alunosComRAGestao = []; // Para armazenar alunos com seus RAs (gestão)
    let professores = [];
    let turmas = [];
    let currentUserRole = null;

    // inicial
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('data_prof').value = new Date().toISOString().split('T')[0];
      document.getElementById('data_gestao').value = new Date().toISOString().split('T')[0];
      // Mostrar formulário de gestão por padrão
      selectLoginOption('gestao');
      
      // Adicionar placeholders para os seletores de alunos
      document.getElementById('aluno_gestao_placeholder').textContent = "Selecione a turma e depois clique para escolher os alunos";
      document.getElementById('alunos_selected_placeholder').textContent = "Clique para selecionar";
    });

    // Selecionar opção de login
    function selectLoginOption(role) {
      document.querySelectorAll('.login-option').forEach(opt => opt.classList.remove('active'));
      document.getElementById(`option${role.charAt(0).toUpperCase() + role.slice(1)}`).classList.add('active');
      
      document.querySelectorAll('.access-area').forEach(area => area.style.display = 'none');
      document.getElementById(`loginForm${role.charAt(0).toUpperCase() + role.slice(1)}`).style.display = 'block';
    }

    // login por tipo de usuário
    function login(role){
      let email, password;
      
      if (role === 'gestao') {
        email = document.getElementById('emailGestao').value.trim();
        password = document.getElementById('passwordGestao').value.trim();
      } else {
        email = document.getElementById('emailProfessor').value.trim();
        password = document.getElementById('passwordProfessor').value.trim();
      }
      
      if(role === 'gestao' && email === 'gestao@escola.com' && password === 'gestao123'){
        showAppAs(role, email);
      } else if(role === 'professor' && email === 'professor@escola.com' && password === 'prof123'){
        showAppAs(role, email);
      } else {
        alert('E-mail ou senha incorretos.');
      }
    }
    
    function fillDemo(role){ 
      if (role === 'gestao') {
        document.getElementById('emailGestao').value='gestao@escola.com'; 
        document.getElementById('passwordGestao').value='gestao123'; 
      }
    }

    function showAppAs(role, email){
      currentUserRole = role;
      document.getElementById('loginScreen').style.display = 'none';
      
      if (role === 'gestao') {
        document.getElementById('mainAppGestao').style.display = 'flex';
        document.getElementById('mainAppProfessor').style.display = 'none';
        carregarTodosAlunos();
        carregarHistoricoGestao();
      } else {
        document.getElementById('mainAppGestao').style.display = 'none';
        document.getElementById('mainAppProfessor').style.display = 'flex';
        carregarProfessoresETurmas();
        carregarHistoricoProfessor();
      }
      
      document.getElementById('userDisplay').textContent = email + (role==='gestao'?' (Gestão)':' (Professor)');
      document.getElementById('btnLogout').style.display = 'inline-block';
      document.getElementById('btnDownloadPdf').style.display = 'inline-block';
    }

    function logout(){
      currentUserRole = null;
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('mainAppGestao').style.display = 'none';
      document.getElementById('mainAppProfessor').style.display = 'none';
      document.getElementById('userDisplay').textContent = 'Não autenticado';
      document.getElementById('btnLogout').style.display = 'none';
      document.getElementById('btnDownloadPdf').style.display = 'none';
      alunosDaTurmaAtual = []; alunosSelecionados = []; document.getElementById('selectedPills').innerHTML='';
      alunosDaTurmaAtualGestao = []; alunosSelecionadosGestao = []; document.getElementById('selectedPillsGestao').innerHTML='';
      
      // Limpar formulários
      document.getElementById('emailGestao').value = '';
      document.getElementById('passwordGestao').value = '';
      document.getElementById('emailProfessor').value = '';
      document.getElementById('passwordProfessor').value = '';
      
      // Reset placeholders
      document.getElementById('aluno_gestao_placeholder').textContent = "Selecione a turma e depois clique para escolher os alunos";
      document.getElementById('alunos_selected_placeholder').textContent = "Clique para selecionar";
    }

    /*******************************
     * GET professores & turmas (consultando BANCODEDADOSGERAL)
     *******************************/
    async function carregarProfessoresETurmas(){
      try {
        // professores (GET do sheet geral)
        const r1 = await fetch(`${SCRIPT_URL}?endpoint=teachers&sheet=${encodeURIComponent(SHEET_GERAL)}`);
        const j1 = await r1.json();
        if(j1 && j1.status === 'success' && Array.isArray(j1.teachers)) professores = j1.teachers;
        else professores = getFallbackProfessores();

        const profSel = document.getElementById('professor_select');
        profSel.innerHTML = '<option value="">-- selecione --</option>';
        professores.forEach(p => { const o = document.createElement('option'); o.value = p; o.textContent = p; profSel.appendChild(o) });

        // turmas (GET do sheet geral)
        const r2 = await fetch(`${SCRIPT_URL}?endpoint=classes&sheet=${encodeURIComponent(SHEET_GERAL)}`);
        const j2 = await r2.json();
        if(j2 && j2.status === 'success' && Array.isArray(j2.classes)) turmas = j2.classes;
        else turmas = Object.keys(_getClassRanges());

        const turmaSel = document.getElementById('turma_select');
        turmaSel.innerHTML = '<option value="">-- selecione --</option>';
        turmas.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; turmaSel.appendChild(o) });
      } catch(err){
        console.error('Erro carregar professores/turmas:', err);
        // fallback
        professores = getFallbackProfessores();
        const profSel = document.getElementById('professor_select');
        profSel.innerHTML = '<option value="">-- selecione --</option>';
        professores.forEach(p => { const o = document.createElement('option'); o.value = p; o.textContent = p; profSel.appendChild(o) });
        turmas = Object.keys(_getClassRanges());
        const turmaSel = document.getElementById('turma_select');
        turmaSel.innerHTML = '<option value="">-- selecione --</option>';
        turmas.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; turmaSel.appendChild(o) });
      }
    }

    /*******************************
     * GET students by class (consultando BANCODEDADOSGERAL)
     *******************************/
    async function onTurmaChange(){
      const turma = document.getElementById('turma_select').value;
      if(!turma){ alunosDaTurmaAtual = []; alunosComRA = []; renderStudentList([]); return; }
      await carregarAlunosPorTurma(turma);
      renderStudentList(alunosDaTurmaAtual);
    }

    async function carregarAlunosPorTurma(turma){
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=students&sheet=${encodeURIComponent(SHEET_GERAL)}&turma=${encodeURIComponent(turma)}`);
        const json = await resp.json();
        alunosDaTurmaAtual = json.students || json.studentsList || [];
        alunosComRA = json.studentsList || [];
        if(!Array.isArray(alunosDaTurmaAtual)) alunosDaTurmaAtual = [];
        if(!Array.isArray(alunosComRA)) alunosComRA = [];
      } catch(err){
        console.error('Erro get students:', err);
        alunosDaTurmaAtual = [];
        alunosComRA = [];
      }
    }

    /*******************************
     * Carregar alunos por turma (GESTÃO)
     *******************************/
    async function carregarAlunosPorTurmaGestao(turma){
      if(!turma){ 
        alunosDaTurmaAtualGestao = []; 
        alunosComRAGestao = [];
        document.getElementById('aluno_gestao_placeholder').textContent = "Selecione a turma e depois clique para escolher os alunos";
        return; 
      }
      
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=students&sheet=${encodeURIComponent(SHEET_GERAL)}&turma=${encodeURIComponent(turma)}`);
        const json = await resp.json();
        alunosDaTurmaAtualGestao = json.students || json.studentsList || [];
        alunosComRAGestao = json.studentsList || [];
        if(!Array.isArray(alunosDaTurmaAtualGestao)) alunosDaTurmaAtualGestao = [];
        if(!Array.isArray(alunosComRAGestao)) alunosComRAGestao = [];
        
        document.getElementById('aluno_gestao_placeholder').textContent = "Clique para selecionar os alunos";
      } catch(err){
        console.error('Erro get students (gestão):', err);
        alunosDaTurmaAtualGestao = [];
        alunosComRAGestao = [];
      }
    }

    /*******************************
     * carregarTodosAlunos (autocomplete gestor) - consulta BANCODEDADOSGERAL
     *******************************/
    async function carregarTodosAlunos(){
      allAlunos = [];
      const classList = Object.keys(_getClassRanges());
      for(const turma of classList){
        try{
          const r = await fetch(`${SCRIPT_URL}?endpoint=students&sheet=${encodeURIComponent(SHEET_GERAL)}&turma=${encodeURIComponent(turma)}`);
          const j = await r.json();
          const list = j.students || [];
          list.forEach(nome => { if(nome && String(nome).trim()) allAlunos.push({nome:String(nome).trim(), turma}) });
        }catch(e){}
      }
      // dedupe
      const seen = new Set();
      allAlunos = allAlunos.filter(a => { if(seen.has(a.nome)) return false; seen.add(a.nome); return true; });
    }

    /*******************************
     * Modal alunos (professor)
     *******************************/
    function openStudentsModal(){
      if(!alunosDaTurmaAtual || alunosDaTurmaAtual.length === 0){ alert('Nenhum aluno encontrado para a turma selecionada.'); return; }
      document.getElementById('modalRoot').style.display = 'flex';
      renderStudentList(alunosDaTurmaAtual);
      document.getElementById('studentSearch').value = '';
    }
    function closeStudentsModal(){ document.getElementById('modalRoot').style.display = 'none'; }

    function renderStudentList(list){
      const container = document.getElementById('studentList'); container.innerHTML = '';
      list.forEach(nome => {
        const row = document.createElement('div'); 
        row.className = 'student-checkbox';
        const lbl = document.createElement('div'); lbl.textContent = nome;
        const cb = document.createElement('input'); cb.type='checkbox'; cb.value = nome; cb.checked = alunosSelecionados.includes(nome);
        cb.onchange = (e) => { 
          if(e.target.checked){ 
            if(!alunosSelecionados.includes(nome)) alunosSelecionados.push(nome); 
          } else {
            alunosSelecionados = alunosSelecionados.filter(x => x !== nome); 
          }
        };
        row.appendChild(cb); 
        row.appendChild(lbl); 
        container.appendChild(row);
      });
    }

    function filterStudentList(){ 
      const q = document.getElementById('studentSearch').value.toLowerCase(); 
      const filtered = alunosDaTurmaAtual.filter(s => s.toLowerCase().includes(q)); 
      renderStudentList(filtered); 
    }

    function confirmStudents(){
      document.getElementById('alunos_selected_placeholder').textContent = alunosSelecionados.length > 0 
        ? `${alunosSelecionados.length} aluno(s) selecionado(s)` 
        : "Clique para selecionar";
        
      const pills = document.getElementById('selectedPills'); pills.innerHTML = '';
      alunosSelecionados.forEach(a => { 
        const el = document.createElement('div'); 
        el.className='pill'; 
        el.textContent = a; 
        pills.appendChild(el); 
      });
      closeStudentsModal();
    }

    /*******************************
     * Modal alunos (gestão)
     *******************************/
    function openStudentsModalGestao(){
      const turma = document.getElementById('serie_gestao').value;
      if(!turma){ alert('Selecione uma turma primeiro.'); return; }
      if(!alunosDaTurmaAtualGestao || alunosDaTurmaAtualGestao.length === 0){ alert('Nenhum aluno encontrado para a turma selecionada.'); return; }
      document.getElementById('modalRootGestao').style.display = 'flex';
      renderStudentListGestao(alunosDaTurmaAtualGestao);
      document.getElementById('studentSearchGestao').value = '';
    }
    
    function closeStudentsModalGestao(){ 
      document.getElementById('modalRootGestao').style.display = 'none'; 
    }

    function renderStudentListGestao(list){
      const container = document.getElementById('studentListGestao'); 
      container.innerHTML = '';
      list.forEach(nome => {
        const row = document.createElement('div'); 
        row.className = 'student-checkbox';
        const lbl = document.createElement('div'); lbl.textContent = nome;
        const cb = document.createElement('input'); 
        cb.type='checkbox'; 
        cb.value = nome; 
        cb.checked = alunosSelecionadosGestao.includes(nome);
        cb.onchange = (e) => { 
          if(e.target.checked){ 
            if(!alunosSelecionadosGestao.includes(nome)) alunosSelecionadosGestao.push(nome); 
          } else {
            alunosSelecionadosGestao = alunosSelecionadosGestao.filter(x => x !== nome); 
          }
        };
        row.appendChild(cb); 
        row.appendChild(lbl); 
        container.appendChild(row);
      });
    }

    function filterStudentListGestao(){ 
      const q = document.getElementById('studentSearchGestao').value.toLowerCase(); 
      const filtered = alunosDaTurmaAtualGestao.filter(s => s.toLowerCase().includes(q)); 
      renderStudentListGestao(filtered); 
    }

    function confirmStudentsGestao(){
      document.getElementById('aluno_gestao_placeholder').textContent = alunosSelecionadosGestao.length > 0 
        ? `${alunosSelecionadosGestao.length} aluno(s) selecionado(s)` 
        : "Clique para selecionar os alunos";
        
      const pills = document.getElementById('selectedPillsGestao'); pills.innerHTML = '';
      alunosSelecionadosGestao.forEach(a => { 
        const el = document.createElement('div'); 
        el.className='pill'; 
        el.textContent = a; 
        pills.appendChild(el); 
      });
      
      // Atualizar campo RA com os RAs dos alunos selecionados
      const rasDosSelecionados = [];
      alunosSelecionadosGestao.forEach(nomeAluno => {
        const alunoComRA = alunosComRAGestao.find(aluno => aluno.nome === nomeAluno);
        if (alunoComRA && alunoComRA.ra) {
          rasDosSelecionados.push(alunoComRA.ra);
        }
      });
      document.getElementById('ra_gestao').value = rasDosSelecionados.join(', ');
      
      closeStudentsModalGestao();
    }

    /*******************************
     * POST ocorrência (professor)
     *******************************/
    async function registrarOcorrenciaProfessor(){
      const prof = document.getElementById('professor_select').value;
      const turma = document.getElementById('turma_select').value;
      const data = document.getElementById('data_prof').value;
      const desc = document.getElementById('descricao_prof').value.trim();
      
      if(!prof || !turma || !data || alunosSelecionados.length === 0 || !desc){
        alert('Preencha todos os campos obrigatórios.');
        return;
      }
      
      const irregs = Array.from(document.querySelectorAll('input[name="irreg"]:checked')).map(cb => cb.value);
      if(irregs.length === 0){
        alert('Selecione pelo menos uma irregularidade.');
        return;
      }
      
      const payload = {
        sheet: SHEET_PROF,
        date: data,
        professor: prof,
        studentClass: turma,
        student: alunosSelecionados.join(', '),
        irregularities: irregs.join(', '),
        description: desc
      };
      
      try {
        const resp = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await resp.json();
        
        if(json && json.status === 'success'){
          document.getElementById('successMessageProfessor').style.display = 'block';
          setTimeout(() => document.getElementById('successMessageProfessor').style.display = 'none', 3000);
          clearProfessorForm();
          carregarHistoricoProfessor();
        } else {
          alert('Erro ao registrar: ' + (json && json.message ? json.message : 'Resposta inesperada'));
        }
      } catch(err){
        console.error('Erro registrarOcorrenciaProfessor:', err);
        alert('Erro ao comunicar com servidor.');
      }
    }

    /*******************************
     * POST ocorrência (gestão)
     *******************************/
    async function registrarOcorrenciaGestao(){
      const turma = document.getElementById('serie_gestao').value;
      const prof = document.getElementById('professor_gestao').value.trim();
      const disciplina = document.getElementById('disciplina_gestao').value.trim();
      const classificacao = document.getElementById('classificacao_gestao').value;
      const data = document.getElementById('data_gestao').value;
      const desc = document.getElementById('descricao_gestao').value.trim();
      const ra = document.getElementById('ra_gestao').value.trim();
      
      if(!turma || !prof || !disciplina || !classificacao || !data || alunosSelecionadosGestao.length === 0 || !desc){
        alert('Preencha todos os campos obrigatórios.');
        return;
      }
      
      const irregs = Array.from(document.querySelectorAll('input[name="irreg_gestao"]:checked')).map(cb => cb.value);
      if(irregs.length === 0){
        alert('Selecione pelo menos uma irregularidade.');
        return;
      }
      
      const payload = {
        sheet: SHEET_GESTAO,
        date: data,
        professor: prof,
        studentClass: turma,
        student: alunosSelecionadosGestao.join(', '),
        ra: ra,
        disciplina: disciplina,
        irregularities: irregs.join(', ') + ' (' + classificacao + ')',
        description: desc
      };
      
      try {
        const resp = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await resp.json();
        
        if(json && json.status === 'success'){
          document.getElementById('successMessageGestao').style.display = 'block';
          setTimeout(() => document.getElementById('successMessageGestao').style.display = 'none', 3000);
          clearGestaoForm();
          carregarHistoricoGestao();
        } else {
          alert('Erro ao registrar: ' + (json && json.message ? json.message : 'Resposta inesperada'));
        }
      } catch(err){
        console.error('Erro registrarOcorrenciaGestao:', err);
        alert('Erro ao comunicar com servidor.');
      }
    }

    /*******************************
     * Clear forms
     *******************************/
    function clearGestaoForm(){
      document.getElementById('serie_gestao').value=''; 
      document.getElementById('aluno_gestao_placeholder').textContent = "Selecione a turma e depois clique para escolher os alunos"; 
      document.getElementById('selectedPillsGestao').innerHTML=''; 
      document.getElementById('ra_gestao').value='';
      document.getElementById('professor_gestao').value='';
      document.getElementById('disciplina_gestao').value='';
      document.getElementById('classificacao_gestao').value='';
      document.getElementById('descricao_gestao').value=''; 
      alunosSelecionadosGestao = []; 
      Array.from(document.querySelectorAll('input[name="irreg_gestao"]')).forEach(cb => cb.checked=false); 
      document.getElementById('data_gestao').value = new Date().toISOString().split('T')[0];
    }

    function clearProfessorForm(){
      document.getElementById('professor_select').value=''; 
      document.getElementById('turma_select').value=''; 
      document.getElementById('alunos_selected_placeholder').textContent = "Clique para selecionar"; 
      document.getElementById('selectedPills').innerHTML=''; 
      document.getElementById('descricao_prof').value=''; 
      alunosSelecionados = []; 
      Array.from(document.querySelectorAll('input[name="irreg"]')).forEach(cb => cb.checked=false); 
      document.getElementById('data_prof').value = new Date().toISOString().split('T')[0];
    }

    /*******************************
     * GET histórico (consultando BANCODEDADOSGERAL)
     *******************************/
    async function carregarHistoricoGestao(){
      const container = document.getElementById('historyListGestao');
      container.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><div class="loader"></div><div class="muted">Carregando histórico...</div></div>`;
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=occurrences&sheet=${encodeURIComponent(SHEET_GESTAO)}`);
        const json = await resp.json();
        // backend pode retornar json.occurrences ou json.data
        const ocorrs = json.occurrences || json.data || [];
        container.innerHTML = '';
        if(!ocorrs || ocorrs.length === 0){ container.innerHTML = '<div class="muted">Nenhuma ocorrência encontrada.</div>'; return; }

        // Exibe do mais recente para o mais antigo
        ocorrs.slice().reverse().forEach(r => {
          const id = r.id || r.ID || r.Id || null;
          const date = r.DATA || r.date || r.col1 || '';
          const prof = r.PROFESSOR || r.professor || r.col2 || '';
          const turma = r.TURMA || r.studentClass || r.col3 || '';
          const aluno = r.ALUNO || r.student || r.col4 || '';
          const ra = r.RA || r.ra || r.col5 || '';
          const disciplina = r.DISCIPLINA || r.disciplina || r.col6 || '';
          const irreg = r.IRREGULARIDADES || r.irregularities || r.col7 || '';
          const desc = r.DESCRICAO || r.description || r.col8 || '';

          const div = document.createElement('div'); div.className='historyItem';
          const meta = document.createElement('div'); meta.className='meta';
          meta.innerHTML = `<div><strong>${date}</strong> — <span class="muted">${prof}</span></div>`;
          const controls = document.createElement('div');
          // botão gerar pdf via backend
          const pdfBtn = document.createElement('button');
          pdfBtn.className='btn-success'; pdfBtn.style.fontSize='12px'; pdfBtn.style.marginLeft='8px';
          pdfBtn.textContent = 'Gerar PDF (template)';
          pdfBtn.onclick = () => generatePdfFromBackend(id);
          // botão excluir
          const delBtn = document.createElement('button');
          delBtn.className='btn-danger'; delBtn.style.fontSize='12px'; delBtn.style.marginLeft='8px';
          delBtn.textContent = 'Excluir';
          delBtn.onclick = () => deleteOccurrence(id);

          controls.appendChild(pdfBtn); controls.appendChild(delBtn);
          meta.appendChild(controls);

          const ddesc = document.createElement('div'); ddesc.className='desc';
          ddesc.innerHTML = `
            <strong>Aluno(s):</strong> ${aluno || 'N/A'}<br/>
            <strong>RA(s):</strong> ${ra || 'N/A'}<br/>
            <strong>Turma:</strong> ${turma || 'N/A'}<br/>
            <strong>Disciplina:</strong> ${disciplina || 'N/A'}<br/>
            <strong>Irregularidades:</strong> ${irreg || 'N/A'}<br/>
            <em>${desc || ''}</em>
          `;

          // adicionar id visível (útil)
          const idLine = document.createElement('div'); idLine.style.marginTop='8px'; idLine.style.fontSize='12px'; idLine.style.opacity='0.9'; idLine.innerHTML = `ID: <span class="qnum">${id}</span>`;

          div.appendChild(meta); div.appendChild(ddesc); div.appendChild(idLine);
          container.appendChild(div);
        });
      } catch(err){
        console.error('Erro carregarHistorico:', err);
        document.getElementById('historyListGestao').innerHTML = '<div class="muted">Erro ao carregar histórico (ver console).</div>';
      }
    }

    async function carregarHistoricoProfessor(){
      const container = document.getElementById('historyListProfessor');
      container.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><div class="loader"></div><div class="muted">Carregando histórico...</div></div>`;
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=occurrences&sheet=${encodeURIComponent(SHEET_PROF)}`);
        const json = await resp.json();
        const ocorrs = json.occurrences || json.data || [];
        container.innerHTML = '';
        if(!ocorrs || ocorrs.length === 0){ container.innerHTML = '<div class="muted">Nenhuma ocorrência encontrada.</div>'; return; }

        // Exibe do mais recente para o mais antigo
        ocorrs.slice().reverse().forEach(r => {
          const id = r.id || r.ID || r.Id || null;
          const date = r.DATA || r.date || r.col1 || '';
          const prof = r.PROFESSOR || r.professor || r.col2 || '';
          const turma = r.TURMA || r.studentClass || r.col3 || '';
          const aluno = r.ALUNO || r.student || r.col4 || '';
          const irreg = r.IRREGULARIDADES || r.irregularities || r.col5 || '';
          const desc = r.DESCRICAO || r.description || r.col6 || '';

          const div = document.createElement('div'); div.className='historyItem';
          const meta = document.createElement('div'); meta.className='meta';
          meta.innerHTML = `<div><strong>${date}</strong> — <span class="muted">${prof}</span></div>`;
          
          const ddesc = document.createElement('div'); ddesc.className='desc';
          ddesc.innerHTML = `<strong>Aluno(s):</strong> ${aluno || 'N/A'}<br/><strong>Turma:</strong> ${turma || 'N/A'}<br/><strong>Irregularidades:</strong> ${irreg || 'N/A'}<br/><em>${desc || ''}</em>`;

          // adicionar id visível (útil)
          const idLine = document.createElement('div'); idLine.style.marginTop='8px'; idLine.style.fontSize='12px'; idLine.style.opacity='0.9'; idLine.innerHTML = `ID: <span class="qnum">${id}</span>`;

          div.appendChild(meta); div.appendChild(ddesc); div.appendChild(idLine);
          container.appendChild(div);
        });
      } catch(err){
        console.error('Erro carregarHistorico:', err);
        document.getElementById('historyListProfessor').innerHTML = '<div class="muted">Erro ao carregar histórico (ver console).</div>';
      }
    }

    /*******************************
     * DELETE ocorrência (POST ?endpoint=delete-occurrence) - envia sheet para contexto
     *******************************/
    async function deleteOccurrence(occurrenceId){
      if(occurrenceId === null || occurrenceId === undefined){ alert('ID inválido para exclusão.'); return; }
      if(!confirm('Confirma exclusão desta ocorrência (ID '+occurrenceId+')?')) return;
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=delete-occurrence`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ occurrenceId, sheet: SHEET_GESTAO })
        });
        const j = await resp.json();
        if(j && j.status === 'success'){ alert('Ocorrência excluída.'); carregarHistoricoGestao(); }
        else alert('Erro ao excluir: ' + (j && j.message ? j.message : 'Resposta inesperada'));
      } catch(err){ console.error('Erro deleteOccurrence:', err); alert('Erro ao comunicar com servidor.'); }
    }

    /*******************************
     * Geração de PDF via backend
     *******************************/
    async function generatePdfFromBackend(occurrenceId){
      if(!occurrenceId){ alert('ID inválido para geração de PDF.'); return; }
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=generate-pdf`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ occurrenceId, sheet: SHEET_GESTAO })
        });
        const j = await resp.json();
        if(j && j.status === 'success' && j.pdfUrl){
          // abrir link em nova aba
          window.open(j.pdfUrl, '_blank');
        } else {
          alert('Servidor não retornou URL do PDF. Resposta: ' + JSON.stringify(j));
        }
      } catch(err){
        console.error('Erro generatePdfFromBackend:', err);
        alert('Erro ao pedir geração de PDF. Verifique se o endpoint generate-pdf existe no Apps Script.');
      }
    }

    /*******************************
     * Função para download de template (botão "Baixar Template")
     *******************************/
    async function downloadDocument() {
      if (currentUserRole !== 'gestao') {
        alert('Funcionalidade disponível apenas para gestão.');
        return;
      }
      
      // Coletar dados do formulário
      const turma = document.getElementById('serie_gestao').value;
      const prof = document.getElementById('professor_gestao').value.trim();
      const disciplina = document.getElementById('disciplina_gestao').value.trim();
      const classificacao = document.getElementById('classificacao_gestao').value;
      const data = document.getElementById('data_gestao').value;
      const desc = document.getElementById('descricao_gestao').value.trim();
      const ra = document.getElementById('ra_gestao').value.trim();
      
      if(!turma || !prof || !disciplina || !data || alunosSelecionadosGestao.length === 0){
        alert('Preencha pelo menos os campos obrigatórios antes de baixar o template.');
        return;
      }
      
      const irregs = Array.from(document.querySelectorAll('input[name="irreg_gestao"]:checked')).map(cb => cb.value);
      
      const formData = {
        date: data,
        professor: prof,
        studentClass: turma,
        student: alunosSelecionadosGestao.join(', '),
        ra: ra,
        disciplina: disciplina,
        irregularities: irregs.join(', ') + (classificacao ? ' (' + classificacao + ')' : ''),
        description: desc
      };
      
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=generate-pdf-form`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        const json = await resp.json();
        
        if(json && json.status === 'success' && json.pdfUrl){
          // abrir link em nova aba
          window.open(json.pdfUrl, '_blank');
        } else {
          alert('Erro ao gerar PDF do template. Resposta: ' + JSON.stringify(json));
        }
      } catch(err){
        console.error('Erro downloadDocument:', err);
        alert('Erro ao comunicar com servidor para gerar PDF.');
      }
    }

    /*******************************
     * fallback: gerar PDF localmente (apenas conteúdo simples)
     *******************************/
    function generatePDFLocal(){
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text('Registro de Ocorrência', 14, 20);
        const turma = document.getElementById('serie_gestao').value || '';
        const alunos = alunosSelecionadosGestao.join(', ') || '';
        const ras = document.getElementById('ra_gestao').value || '';
        const prof = document.getElementById('professor_gestao').value || '';
        const disciplina = document.getElementById('disciplina_gestao').value || '';
        const classificacao = document.getElementById('classificacao_gestao').value || '';
        const desc = document.getElementById('descricao_gestao').value || '';
        let y = 36;
        
        if(turma){ doc.text(`Turma: ${turma}`, 14, y); y+=8; }
        if(alunos){ doc.text(`Aluno(s): ${alunos}`, 14, y); y+=8; }
        if(ras){ doc.text(`RA(s): ${ras}`, 14, y); y+=8; }
        if(prof){ doc.text(`Professor: ${prof}`, 14, y); y+=8; }
        if(disciplina){ doc.text(`Disciplina: ${disciplina}`, 14, y); y+=8; }
        if(classificacao){ doc.text(`Classificação: ${classificacao}`, 14, y); y+=8; }
        
        doc.text('Descrição:', 14, y); y+=8;
        const split = doc.splitTextToSize(desc || 'Sem descrição', 180);
        doc.text(split, 14, y);
        doc.save(`ocorrencia_${Date.now()}.pdf`);
      } catch(err){ console.error('Erro gerar PDF local:', err); alert('Erro ao gerar PDF local (ver console).'); }
    }

    /*******************************
     * utilitários / fallbacks
     *******************************/
    function _getClassRanges(){ return {
      "6° ANO A MANHA":"C3:C46","6° ANO B MANHA":"H3:H46","6° ANO C MANHA":"M3:M46","6° ANO D MANHA":"R3:R46",
      "6° ANO E TARDE":"W3:W46","6° ANO F TARDE":"AB3:AB46","7° ANO A TARDE":"AG3:AG46","7° ANO B TARDE":"AL3:AL46",
      "7° ANO C TARDE":"AQ3:AQ46","7° ANO D TARDE":"AV3:AV46","7° ANO E TARDE":"BA3:BA46","7° ANO F TARDE":"BF3:BF46",
      "8° ANO A TARDE":"BK3:BK46","8° ANO B TARDE":"BP3:BP46","8° ANO C TARDE":"BU3:BU46","8° ANO D TARDE":"BZ3:BZ46",
      "8° ANO E TARDE":"CE3:CE46","9° ANO A TARDE":"CJ3:CJ46","9° ANO B TARDE":"CO3:CO46","9° ANO C TARDE":"CT3:CT46",
      "9° ANO D TARDE":"CY3:CY46","1ª SERIE A MANHA":"DD3:DD46","1ª SERIE B MANHA":"DI3:DI46","1ª SERIE C MANHA":"DN3:DN46",
      "1ª SERIE D MANHA":"DS3:DS46","1ª SERIE E MANHA":"DX3:DX46","1ª SERIE F MANHA":"EC3:EC46","1ª SERIE G TARDE":"EH3:EH46",
      "1ª SERIE H NOITE":"EM3:EM46","1ª SERIE I NOITE":"ER3:ER46","2ª SERIE A MANHA":"EW3:EW46","2ª SERIE B MANHA":"FB3:FB46",
      "2ª SERIE C MANHA":"FG3:FG46","2ª SERIE D MANHA":"FL3:FL46","2ª SERIE E MANHA":"FQ3:FQ46","2ª SERIE F NOITE":"FV3:FV46",
      "2ª SERIE G NOITE":"GA3:GA46","2ª SERIE H NOITE":"GK3:GK46","3ª SERIE A MANHA":"GP3:GP46","3ª SERIE B MANHA":"GU3:GU46",
      "3ª SERIE C MANHA":"GZ3:GZ46","3ª SERIE D NOITE":"HE3:HE46","3ª SERIE E NOITE":"HJ3:HJ46","3ª SERIE F NOITE":"HO3:HO46",
      "3ª SERIE G NOITE":"HT3:HT46"
    };}

    function getFallbackProfessores(){
      return [
        "ALEX LUTH PEREIRA MARANHAO","ALEXSANDRA PAULA VARELLA DE SOUZA","ALISON VASCONCELOS BESERRA","AMAURI TEODORO DE OLIVEIRA",
        "ANA PAULA DOS SANTOS","ANDREIA DOS SANTOS FREITAS","ANDREIA MADUREIRA REIS","ANTONIO CARLOS DE OLIVEIRA",
        "ANTONIO RAMS DE ARAUJO","ANTONIO WILTON WANDERLEY CABRAL","AUGUSTO LINO PESSOA NETO","AUREA MARIA DE JESUS MARQUES",
        "CAROLINA PERNOMIAN PARUSSOLOLO","CASSIA OLIVEIRA ANTONIAZI","CLAUDINEIA DE AGUIAR LIMA","DANIEL DE FREITAS ALMEIDA",
        "DANIEL LOPES BARBOSA","DANIELA FERREIRA LIMA","DANIELLE LUCIA BATISTA DE ALMEIDA","EDIANE VIEIRA DA SILVA",
        "EDILEUSA NUNES PEREIRA","EDUARDO HENRIQUE DA FONSECA","ELIANE SANTOS SILVA","ELIAS MONTEIRO DA SILVA",
        "ELISABETE APARECIDA PIRES","ELZA DE FARIA PEREIRA","EMERSON GABLER DE ALMEIDA","EUZELI ARAUJO DE OLIVEIRA",
        "FABIANO AUGUSTO PIEDADE","FABIO CAMILO","FERNANDO JOSE DA SILVA FILHO","FLAVIA CRISTINA APARECIDA BICHLER",
        "FLAVIO CARDOSO FLEURY","FRANCISCA EDIVANIA DE MORAIS COSTA","GABRIELA SERIGHELLI DE MELO","GELSON DE ALMEIDA BATISTA",
        "GENILTON DE OLIVEIRA SILVA","GIANI CRISTINA DO PRADO","INGRYD CAROLINE SUGUIMOTO VIEIRA","IVANILDES DOS SANTOS OSHIKAWA",
        "JANINA DOS PASSOS BRAGA DE ALMEIDA","JOSE APARECIDO DA SILVA","JUAREZ GOMES DE MAGALHAES FILHO","JUREMA SOLEDADE FURINI SANTOS",
        "KATIUSCIA ALVES BOMFIM","LUANA CAROLINE ALVES LIMA","LUANA DE FREITAS SILVA","LUCIANA NOVAIS CORREIA SANTOS",
        "LUCIANO MOREIRA DE AZEVEDO","MARCIEL DA SILVA","MARIA HELENA CUNHA MORO","MARIA QUITÉRIA FERREIRA DOS SANTOS",
        "MARINA DA CONCEICAO FRANCISCO SILVA","MAURICIO DE BARROS SANTOS","MICHELE DE PINHO MORAES","MOISES ANTONIO DE BARROS",
        "PAULA ARMANI VILA","PAULO ROBERTO DA SILVA ITO","PEDRO ZANOTTI FILHO","RAUL PEREIRA VILERA JUNIOR",
        "REGIANE CURTI DE SOUZA OLIVEIRA","REGINA DA SILSA CASTRO","RICARDO AMERICO DA SILVA","ROBERTO SALGADO",
        "RODRIGO VIEIRA","ROSANGELA CAFASSO MOREIRA","ROSIMERY DE SOUZA PESSOA","ROSMARA DA SILSA CARDOSO",
        "SANDRA CRISTINA MACEDO MORAES","SELMA GOMES DA SILSA","SERGIO AGRIPINO VILLA NOVA","SOLANGE ALMEIDA DA SILSA",
        "SUZINEIDE SILSA DE FREITAS","THIAGO FABIANO BRITO","TITTO AUGUSTO NASCIMENTO SILSA","VANDERSON HYPPOLITO",
        "VANESSA IVETE GOMES DOS SANTOS","VANIA PENHA DE BARROS","VIVIANE LEAL CAMERA DE MORAES","WILSON RODRIGUES MOTA"
      ];
    }

  </script>
</body>
</html>
