<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cadastro de Ocorrências - 2025 (Corrigido)</title>

  <!-- jsPDF para geração local de PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* ===== Reset/Base ===== */
    * { box-sizing: border-box; margin:0; padding:0; }
    html,body{height:100%}
    body{
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #e6f2ff 0%, #e6ffe6 60%, #e6f9ff 100% );
      color:#333; font-weight:500; padding:20px;
    }
    .app{max-width:1200px;margin:0 auto;display:flex;flex-direction:column;gap:20px}

    /* Header Styles */
    header{
      display:flex;align-items:center;justify-content:space-between;padding:20px;
      border-radius:12px;background:linear-gradient(90deg,rgba(0,31,63,0.95),rgba(0,78,120,0.95));
      box-shadow:0 8px 30px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.1);
    }
    header h1{font-size:22px;margin:0;color:#fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2);}
    .header-controls{display:flex;gap:12px;align-items:center}

    /* Card Styles */
    .card{
      background:#fff;padding:24px;border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.1);border:1px solid #e0e0e0;
    }

    /* Layout */
    .flex-row{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap;}
    .flex-col{display:flex;flex-direction:column;gap:14px;}

    /* Form Sections with Gray Background and 3D effect */
    .form-section{
      background-color: #f0f0f0;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 18px;
      box-shadow:
         inset 0 2px 4px rgba(0,0,0,0.05),
        0 4px 8px rgba(0,0,0,0.1);
      border: 1px solid #d0d0d0;
    }

    /* Form Elements */
    label{display:block;margin-bottom:8px;font-size:14px;font-weight:600;color:#444;}
    input[type="text"],input[type="email"],input[type="password"],select,textarea,input[type="date"]{
      width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;font-size:14px;color:#333;
      background-color: #ffffff;
      transition:border-color 0.3s, box-shadow 0.3s;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus,
     select:focus, textarea:focus, input[type="date"]:focus {
      border-color: #2a5298;
      outline: none;
      box-shadow: 0 0 0 2px rgba(42, 82, 152, 0.2), inset 0 1px 3px rgba(0,0,0,0.1);
    }
    textarea{min-height:110px;resize:vertical;padding-top:12px}

    /* Buttons */
    button{
      cursor:pointer;border:none;padding:12px 18px;border-radius:8px;font-weight:600;transition:all 0.2s;
      box-shadow: 0 3px 6px rgba(0,0,0,0.16);
    }
    .btn-primary{background:linear-gradient(90deg,#1e3c72,#2a5298);color:#fff;}
    .btn-primary:hover{background:linear-gradient(90deg,#2a5298,#3a6bd1);transform:translateY(-2px);box-shadow: 0 5px 10px rgba(0,0,0,0.2);}
    .btn-danger{background:linear-gradient(90deg,#e94b4b,#c62828);color:#fff;}
    .btn-danger:hover{background:linear-gradient(90deg,#c62828,#d32f2f);transform:translateY(-2px);box-shadow: 0 5px 10px rgba(0,0,0,0.2);}
    .btn-success{background:linear-gradient(90deg,#4CAF50,#2E7D32);color:#fff;}
    .btn-success:hover{background:linear-gradient(90deg,#2E7D32,#388E3C);transform:translateY(-2px);box-shadow: 0 5px 10px rgba(0,0,0,0.2);}
    .btn-secondary{background:linear-gradient(90deg,#6c757d,#5a6268);color:#fff;}
    .btn-secondary:hover{background:linear-gradient(90deg,#5a6268,#6c757d);transform:translateY(-2px);box-shadow: 0 5px 10px rgba(0,0,0,0.2);}

    /* Text Elements */
    .subtitle{
      font-size:18px;color:#2a5298;margin-bottom:14px;font-weight:600;padding-bottom:8px;
      border-bottom:2px solid #2a5298; text-shadow: 0 1px 1px rgba(0,0,0,0.05);
    }
    .section-title{font-size:15px;color:#2a5298;margin:15px 0 10px;font-weight:600;}

    /* History List */
    .historyList{max-height:420px;overflow:auto;display:flex;flex-direction:column;gap:12px;padding-right:8px}
    .historyItem{
      background:#f9f9f9;border-left:4px solid #2a5298;padding:18px;border-radius:8px;color:#333;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .historyItem .meta{font-size:14px;color:#666;font-weight:600;display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:10px;}
    .historyItem .desc{margin-top:10px;color:#555;font-weight:400;font-size:14px;line-height:1.5;}

    /* Modal */
    .modal-root{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:2000;}
    .modal{
      width:92%;max-width:780px;background:#fff;color:#333;border-radius:12px;padding:24px;
      max-height:84vh;overflow:auto;box-shadow:0 12px 36px rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);
    }
    .studentList{display:flex;flex-direction:column;gap:10px;}

    /* Pills and Tags */
    .pill{
      background:linear-gradient(90deg,#2a5298,#3a6bd1);color:#fff;padding:6px 14px;border-radius:20px;
      font-weight:600;display:inline-block;margin:0 6px 6px 0;font-size:13px;box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
    .muted{opacity:.7;font-weight:500;color:#666;}
    .qnum{color:#e53935;font-weight:700;}

    /* Login Options */
    .login-options {display: flex; gap: 14px; margin-bottom: 20px;}
    .login-option {
      flex: 1; text-align: center; padding: 18px; border-radius: 10px; cursor: pointer;
       background: rgba(255,255,255,0.2); border: 2px solid transparent; transition: all 0.2s;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    .login-option.active {
      background: linear-gradient(90deg, rgba(0,78,120,0.8), rgba(0,120,120,0.8));
       color: #fff; border-color: #fff; box-shadow: 0 5px 12px rgba(0,0,0,0.2);
    }
    .login-option:hover {background: rgba(255,255,255,0.3); box-shadow: 0 4px 10px rgba(0,0,0,0.15);}
    .access-area {display: none;}

    /* Checkbox Styles */
    .checkbox-group {display: flex; flex-wrap: wrap; gap: 12px; margin: 12px 0;}
    .checkbox-item {
      display: flex; align-items: center; background: #f5f5f5; padding: 10px 14px;
       border-radius: 20px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    .checkbox-item:hover {background: #e9e9e9; box-shadow: 0 3px 6px rgba(0,0,0,0.12);}
    .checkbox-item input {margin-right: 8px;}

    /* Form Groups */
    .form-group {margin-bottom: 18px; flex: 1;}
    .form-group-half {flex: 0 0 calc(50% - 12px);}
    .form-group-third {flex: 0 0 calc(33.333% - 12px);}
    .form-group-quarter {flex: 0 0 calc(25% - 12px);}

    /* Student Selection */
    .student-selector {
      padding: 14px; border: 1px solid #ddd; border-radius: 8px; background: #fff;
       cursor: pointer; transition: all 0.2s; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    .student-selector:hover {background: #f0f0f0; border-color: #2a5298; box-shadow: inset 0 1px 4px rgba(0,0,0,0.15);}

    /* Responsive */
    @media(max-width:980px){
      .flex-row{flex-direction:column; gap: 12px;}
      header{flex-direction:column;gap:14px;align-items:flex-start;}
      .login-options {flex-direction: column;}
      .form-group-half, .form-group-third, .form-group-quarter {flex: 1;}
      .card {padding: 18px;}
    }

    /* Loader animation */
    @keyframes spin{to{transform:rotate(360deg)}}
    .loader{width:20px;height:20px;border:3px solid rgba(0,0,0,0.1);border-top-color:#2a5298;border-radius:50%;animation:spin 1s linear infinite;display:inline-block}

    /* Student checkbox in modal */
    .student-checkbox {
      display: flex; align-items: center; padding: 14px; border-bottom: 1px solid #eee;
       cursor: pointer; transition: background 0.2s; border-radius: 6px;
    }
    .student-checkbox:hover {background: #f0f4ff; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
    .student-checkbox input[type="checkbox"] {margin-right: 14px; transform: scale(1.3);}

    /* Custom styles for the redesign */
    .form-row {
      display: flex;
      gap: 18px;
      margin-bottom: 18px;
      align-items: flex-start;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .date-field {
      cursor: pointer;
    }

    .date-field::-webkit-calendar-picker-indicator {
      cursor: pointer;
      padding: 5px;
      border-radius: 3px;
    }

    /* Success message */
    .success-message {
      display:none;margin-top:12px;background:linear-gradient(90deg,#4CAF50,#2E7D32);
      padding:14px;border-radius:8px;color:#fff;font-weight:600; box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- HEADER -->
    <header>
      <h1>2025 — Cadastro de Ocorrências</h1>
      <div class="header-controls">
        <div id="userDisplay" class="muted">Não autenticado</div>
        <button id="btnLogout" class="btn-danger" style="display:none" onclick="logout()">Sair</button>
        <button id="btnDownloadPdf" class="btn-success" style="display:none" onclick="downloadDocument()">Baixar Template</button>
      </div>
    </header>

    <!-- LOGIN -->
    <div id="loginScreen" class="card" style="display:block">
      <div style="max-width:500px;margin:0 auto">
        <div class="subtitle">Selecione o tipo de acesso</div>

        <div class="login-options">
          <div class="login-option active" id="optionGestao" onclick="selectLoginOption('gestao')">
            Acesso Gestão
          </div>
          <div class="login-option" id="optionProfessor" onclick="selectLoginOption('professor')">
            Acesso Professor
          </div>
        </div>

        <div id="loginFormGestao" class="access-area">
          <div class="form-section">
            <div class="form-row">
              <div class="field-group">
                <label for="emailGestao">E-mail Gestão</label>
                <input id="emailGestao" type="email" placeholder="gestao@escola.com">
              </div>
              <div class="field-group">
                <label for="passwordGestao">Senha</label>
                <input id="passwordGestao" type="password" placeholder="senha">
              </div>
            </div>
          </div>

          <div class="flex-row">
            <button class="btn-primary" onclick="login('gestao')">Entrar como Gestão</button>
            <button class="btn-danger" onclick="fillDemo('gestao')">Demo Gestão</button>
          </div>
        </div>

        <div id="loginFormProfessor" class="access-area">
          <div class="form-section">
            <div class="form-row">
              <div class="field-group">
                <label for="emailProfessor">E-mail Professor</label>
                <input id="emailProfessor" type="email" placeholder="professor@escola.com">
              </div>
              <div class="field-group">
                <label for="passwordProfessor">Senha</label>
                <input id="passwordProfessor" type="password" placeholder="senha">
              </div>
            </div>
          </div>

          <div class="flex-row">
            <button class="btn-primary" onclick="login('professor')">Entrar como Professor</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN APP - GESTÃO -->
    <div id="mainAppGestao" style="display:none;flex-direction:column;gap:16px">
      <div class="flex-row">
        <!-- GESTÃO -->
        <div class="card flex-col" style="flex:1">
          <div class="subtitle">CADASTRO — GESTÃO</div>

          <div class="form-section">
            <div class="form-row">
              <div class="field-group">
                <label>Série / Turma</label>
                <select id="serie_gestao" onchange="carregarAlunosPorTurmaGestao(this.value)">
                  <option value="">Selecione a turma</option>
                  <option value="6° ANO A MANHA">6° ANO A MANHA</option>
                  <option value="6° ANO B MANHA">6° ANO B MANHA</option>
                  <option value="6° ANO C MANHA">6° ANO C MANHA</option>
                  <option value="6° ANO D MANHA">6° ANO D MANHA</option>
                  <option value="6° ANO E TARDE">6° ANO E TARDE</option>
                  <option value="6° ANO F TARDE">6° ANO F TARDE</option>
                  <option value="7° ANO A TARDE">7° ANO A TARDE</option>
                  <option value="7° ANO B TARDE">7° ANO B TARDE</option>
                  <option value="7° ANO C TARDE">7° ANO C TARDE</option>
                  <option value="7° ANO D TARDE">7° ANO D TARDE</option>
                  <option value="7° ANO E TARDE">7° ANO E TARDE</option>
                  <option value="7° ANO F TARDE">7° ANO F TARDE</option>
                  <option value="8° ANO A TARDE">8° ANO A TARDE</option>
                  <option value="8° ANO B TARDE">8° ANO B TARDE</option>
                  <option value="8° ANO C TARDE">8° ANO C TARDE</option>
                  <option value="8° ANO D TARDE">8° ANO D TARDE</option>
                  <option value="8° ANO E TARDE">8° ANO E TARDE</option>
                  <option value="9° ANO A TARDE">9° ANO A TARDE</option>
                  <option value="9° ANO B TARDE">9° ANO B TARDE</option>
                  <option value="9° ANO C TARDE">9° ANO C TARDE</option>
                  <option value="9° ANO D TARDE">9° ANO D TARDE</n>
                  <option value="1ª SERIE A MANHA">1ª SERIE A MANHA</option>
                  <option value="1ª SERIE B MANHA">1ª SERIE B MANHA</option>
                  <option value="1ª SERIE C MANHA">1ª SERIE C MANHA</option>
                  <option value="1ª SERIE D MANHA">1ª SERIE D MANHA</option>
                  <option value="1ª SERIE E MANHA">1ª SERIE E MANHA</option>
                  <option value="1ª SERIE F MANHA">1ª SERIE F MANHA</option>
                  <option value="1ª SERIE G TARDE">1ª SERIE G TARDE</option>
                  <option value="1ª SERIE H NOITE">1ª SERIE H NOITE</option>
                  <option value="1ª SERIE I NOITE">1ª SERIE I NOITE</option>
                  <option value="2ª SERIE A MANHA">2ª SERIE A MANHA</option>
                  <option value="2ª SERIE B MANHA">2ª SERIE B MANHA</option>
                  <option value="2ª SERIE C MANHA">2ª SERIE C MANHA</option>
                  <option value="2ª SERIE D MANHA">2ª SERIE D MANHA</n>
                  <option value="2ª SERIE E MANHA">2ª SERIE E MANHA</option>
                  <option value="2ª SERIE F NOITE">2ª SERIE F NOITE</option>
                  <option value="2ª SERIE G NOITE">2ª SERIE G NOITE</n>
                  <option value="2ª SERIE H NOITE">2ª SERIE H NOITE</option>
                  <option value="3ª SERIE A MANHA">3ª SERIE A MANHA</option>
                  <option value="3ª SERIE B MANHA">3ª SERIE B MANHA</option>
                  <option value="3ª SERIE C MANHA">3ª SERIE C MANHA</option>
                  <option value="3ª SERIE D NOITE">3ª SERIE D NOITE</option>
                  <option value="3ª SERIE E NOITE">3ª SERIE E NOITE</option>
                  <option value="3ª SERIE F NOITE">3ª SERIE F NOITE</option>
                  <option value="3ª SERIE G NOITE">3ª SERIE G NOITE</option>
                </select>
              </div>

              <div class="field-group">
                <label>Aluno(s)</label>
                <div class="student-selector" onclick="openStudentsModalGestao()">
                  <span id="aluno_gestao_placeholder">Selecione a turma e depois clique para escolher os alunos</span>
                </div>
                <div id="selectedPillsGestao" style="margin-top:10px"></div>
              </div>
            </div>

            <div class="form-row">
              <div class="field-group">
                <label>RA(s)</label>
                <input id="ra_gestao" type="text" readonly placeholder="Selecione os alunos para carregar o RA">
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-row">
              <div class="field-group">
                <label>Professor</label>
                <input id="professor_gestao" type="text">
              </div>
              <div class="field-group">
                <label>Disciplina</label>
                <input id="disciplina_gestao" type="text">
              </div>
            </div>

            <div class="form-row">
              <div class="field-group">
                <label>Classificação</label>
                <select id="classificacao_gestao" onchange="toggleSuspension('gestao')">
                  <option value="">Selecione</option>
                  <option value="OCORRÊNCIA">OCORRÊNCIA</option>
                  <option value="SUSPENSÃO">SUSPENSÃO</option>
                </select>
              </div>
              <div class="field-group" id="suspensionRow_gestao" style="display:none">
                <label>Data de retorno</label>
                <input id="dataRetorno_gestao" type="date" class="date-field">
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-row">
              <div class="field-group">
                <label>Descrição</label>
                <textarea id="descricao_gestao" placeholder="Descrição detalhada"></textarea>
              </div>
            </div>
          </div>

          <div class="flex-row">
            <button class="btn-primary" onclick="cadastrarOcorrenciaGestao()">Registrar (Gestão)</button>
            <button class="btn-success" onclick="generatePDFLocal()">Gerar PDF (local)</button>
          </div>

          <div id="successGestao" class="success-message">
            Ocorrência registrada com sucesso!
          </div>
        </div>
      </div>

      <!-- HISTÓRICO GESTÃO -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
          <div class="subtitle">HISTÓRICO DE OCORRÊNCIAS - GESTÃO</div>
          <div style="display:flex;gap:10px;align-items:center">
            <button class="btn-primary" onclick="carregarHistoricoGestao()">Atualizar</button>
          </div>
        </div>
        <div id="historyListGestao" class="historyList"></div>
      </div>
    </div> <!-- mainAppGestao -->

    <!-- MAIN APP - PROFESSOR -->
    <div id="mainAppProfessor" style="display:none;flex-direction:column;gap:16px">
      <div class="flex-row">
        <!-- PROFESSOR -->
        <div class="card flex-col" style="flex:1">
          <div class="subtitle">REGISTRO — PROFESSOR</div>

          <div class="form-section">
            <div class="form-row">
              <div class="field-group">
                <label>Professor</label>
                <select id="professor_select"></select>
              </div>
              <div class="field-group">
                <label>Turma</label>
                <select id="turma_select" onchange="onTurmaChange()"></select>
              </div>
              <div class="field-group">
                <label>Data</label>
                <input id="data_prof" type="date" class="date-field">
              </div>
            </div>

            <div class="form-row">
              <div class="field-group">
                <label>Alunos (clique para selecionar)</label>
                <div class="student-selector" onclick="openStudentsModal()">
                  <span id="alunos_selected_placeholder">Clique para selecionar</span>
                </div>
                <div id="selectedPills" style="margin-top:10px"></div>
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-row">
              <div class="field-group">
                <label>Irregularidades</label>
                <div class="checkbox-group">
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Agressão"> Agressão
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Danos ao patrimônio"> Danos ao patrimônio
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Desacato"> Desacato
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Estava fora da sala"> Estava fora da sala
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Falta de material"> Falta de material
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Indisciplina"> Indisciplina
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Não realiza as atividades"> Não realiza as atividades
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Saiu da sala sem autorização"> Saiu da sala sem autorização
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="irreg" value="Uso de celular"> Uso de celular
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-row">
              <div class="field-group">
                <label>Descrição</label>
                <textarea id="descricao_prof" placeholder="Descreva a ocorrência..."></textarea>
              </div>
            </div>
          </div>

          <div class="flex-row">
            <button class="btn-primary" onclick="registrarOcorrenciaProfessor()">Registrar (Professor)</button>
            <button class="btn-danger" onclick="clearProfessorForm()">Limpar</button>
          </div>

          <div id="successProfessor" class="success-message">
            Ocorrência registrada com sucesso!
          </div>
        </div>
      </div>

      <!-- HISTÓRICO PROFESSOR -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
          <div class="subtitle">HISTÓRICO DE OCORRÊNCIAS - PROFESSOR</div>
          <div style="display:flex;gap:10px;align-items:center">
            <button class="btn-primary" onclick="carregarHistoricoProfessor()">Atualizar</button>
          </div>
        </div>
        <div id="historyListProfessor" class="historyList"></div>
      </div>
    </div> <!-- mainAppProfessor -->

    <!-- MODAL SELEÇÃO ALUNOS PROFESSOR -->
    <div id="modalRoot" class="modal-root">
      <div class="modal">
        <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
          <strong>Selecionar alunos</strong>
          <button onclick="closeStudentsModal()" style="background:transparent;border:none;font-weight:700;cursor:pointer;font-size:20px">✕</button>
        </header>

        <div>
          <input id="studentSearch" type="text" placeholder="Filtrar alunos..." style="width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;margin-bottom:18px" oninput="filterStudentList()">
          <div id="studentList" class="studentList"></div>
        </div>

        <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:18px">
          <button class="btn-primary" onclick="confirmStudents()">Confirmar</button>
          <button class="btn-danger" onclick="closeStudentsModal()">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- MODAL SELEÇÃO ALUNOS GESTÃO -->
    <div id="modalRootGestao" class="modal-root">
      <div class="modal">
        <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
          <strong>Selecionar alunos para Gestão</strong>
          <button onclick="closeStudentsModalGestao()" style="background:transparent;border:none;font-weight:700;cursor:pointer;font-size:20px">✕</button>
        </header>

        <div>
          <input id="studentSearchGestao" type="text" placeholder="Filtrar alunos..." style="width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;margin-bottom:18px" oninput="filterStudentListGestao()">
          <div id="studentListGestao" class="studentList"></div>
        </div>

        <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:18px">
          <button class="btn-primary" onclick="confirmStudentsGestao()">Confirmar</button>
          <button class="btn-danger" onclick="closeStudentsModalGestao()">Cancelar</button>
        </div>
      </div>
    </div>

  </div> <!-- app -->

  <script>
    // Variáveis globais para armazenar dados
    let currentUser = null;
    let currentRole = null;
    let allStudents = []; // Armazena todos os alunos carregados do backend
    let selectedStudents = []; // Alunos selecionados no modal do Professor
    let selectedStudentsGestao = []; // Alunos selecionados no modal da Gestão

    // Função para simular a chamada ao Google Apps Script
    function googleScriptCall(functionName, args, callback) {
      // Simulação de chamada para testes locais
      console.log(`Simulando chamada para Google Apps Script: ${functionName} com args:`, args);
      if (functionName === 'doGetInitialData') {
        // Dados de exemplo para professores e turmas
        const demoData = {
          professores: ['Prof. Ana', 'Prof. Bruno', 'Prof. Carla'],
          turmas: [
            '6° ANO A MANHA', '6° ANO B MANHA', '6° ANO C MANHA',
            '7° ANO A TARDE', '7° ANO B TARDE',
            '8° ANO A TARDE', '8° ANO B TARDE',
            '9° ANO A TARDE', '9° ANO B TARDE',
            '1ª SERIE A MANHA', '1ª SERIE B MANHA',
            '2ª SERIE A MANHA', '2ª SERIE B MANHA',
            '3ª SERIE A MANHA', '3ª SERIE B MANHA'
          ],
          alunos: [
            { nome: 'Aluno 1', turma: '6° ANO A MANHA', ra: '12345' },
            { nome: 'Aluno 2', turma: '6° ANO A MANHA', ra: '12346' },
            { nome: 'Aluno 3', turma: '6° ANO B MANHA', ra: '12347' },
            { nome: 'Aluno 4', turma: '7° ANO A TARDE', ra: '12348' },
            { nome: 'Aluno 5', turma: '7° ANO A TARDE', ra: '12349' },
            { nome: 'Aluno 6', turma: '8° ANO A TARDE', ra: '12350' },
            { nome: 'Aluno 7', turma: '8° ANO A TARDE', ra: '12351' },
            { nome: 'Aluno 8', turma: '9° ANO A TARDE', ra: '12352' },
            { nome: 'Aluno 9', turma: '9° ANO A TARDE', ra: '12353' },
            { nome: 'Aluno 10', turma: '1ª SERIE A MANHA', ra: '12354' },
            { nome: 'Aluno 11', turma: '1ª SERIE A MANHA', ra: '12355' },
            { nome: 'Aluno 12', turma: '2ª SERIE A MANHA', ra: '12356' },
            { nome: 'Aluno 13', turma: '2ª SERIE A MANHA', ra: '12357' },
            { nome: 'Aluno 14', turma: '3ª SERIE A MANHA', ra: '12358' },
            { nome: 'Aluno 15', turma: '3ª SERIE A MANHA', ra: '12359' },
          ],
          historicoProfessor: [
            { data: '2025-01-01', professor: 'Prof. Ana', turma: '6° ANO A MANHA', alunos: 'Aluno 1', irregularidades: 'Indisciplina', descricao: 'Conversa excessiva em sala.' },
            { data: '2025-01-02', professor: 'Prof. Bruno', turma: '7° ANO A TARDE', alunos: 'Aluno 4, Aluno 5', irregularidades: 'Uso de celular', descricao: 'Alunos utilizando celular durante a aula.' }
          ],
          historicoGestao: [
            { data: '2025-01-05', professor: 'Prof. Carla', disciplina: 'Matemática', turma: '8° ANO A TARDE', alunos: 'Aluno 6', ra: '12350', classificacao: 'OCORRÊNCIA', dataRetorno: '', descricao: 'Falta de material e recusa em fazer atividade.' }
          ]
        };
        callback(demoData);
      } else if (functionName === 'doPost') {
        // Simula um registro bem-sucedido
        console.log('Dados enviados para registro:', args);
        callback({ status: 'SUCCESS', message: 'Registro simulado com sucesso!' });
      } else if (functionName === 'getStudentsByTurma') {
        const turma = args[0];
        const filteredStudents = allStudents.filter(student => student.turma === turma);
        callback(filteredStudents);
      } else if (functionName === 'getProfessorOccurrences') {
        // Simula o retorno de ocorrências do professor
        callback(demoData.historicoProfessor);
      } else if (functionName === 'getGestaoOccurrences') {
        // Simula o retorno de ocorrências da gestão
        callback(demoData.historicoGestao);
      }
    }

    // Substitua esta função pela chamada real ao Google Apps Script quando implantar
    // function googleScriptCall(functionName, args, callback) {
    //   google.script.run
    //     .withSuccessHandler(callback)
    //     .withFailureHandler(err => console.error("Erro no Google Apps Script:", err))
    //     [functionName](...args);
    // }

    // Funções de Login e Logout
    function selectLoginOption(option) {
      document.querySelectorAll('.login-option').forEach(el => el.classList.remove('active'));
      document.getElementById(`option${option.charAt(0).toUpperCase() + option.slice(1)}`).classList.add('active');

      document.querySelectorAll('.access-area').forEach(el => el.style.display = 'none');
      document.getElementById(`loginForm${option.charAt(0).toUpperCase() + option.slice(1)}`).style.display = 'block';
    }

    // login por tipo de usuário (demo local)
    function login(role){
      let email, password;
      if (role === 'gestao') {
        email = document.getElementById('emailGestao').value.trim();
        password = document.getElementById('passwordGestao').value.trim();
      } else {
        email = document.getElementById('emailProfessor').value.trim();
        password = document.getElementById('passwordProfessor').value.trim();
      }

      // Validação para Gestão
      if(role === 'gestao' && email.toLowerCase() === 'gestao@escola.com' && password === 'gestao123'){
        showAppAs(role, email);
        return;
      }
      
      // Validação para Professor
      if(role === 'professor' && email.toLowerCase() === 'professor@escola.com' && password === 'prof123'){
        showAppAs(role, email);
        return;
      }

      // Se nenhuma das validações passar, mostra o alerta
      alert('E-mail ou senha incorretos.');
    }

    function fillDemo(role) {
      if (role === 'gestao') {
        document.getElementById('emailGestao').value = 'gestao@escola.com';
        document.getElementById('passwordGestao').value = 'gestao123';
      } else if (role === 'professor') {
        document.getElementById('emailProfessor').value = 'professor@escola.com';
        document.getElementById('passwordProfessor').value = 'prof123';
      }
    }

    function showAppAs(role, email) {
      currentUser = email;
      currentRole = role;
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('userDisplay').textContent = `Logado como: ${email} (${role.toUpperCase()})`;
      document.getElementById('btnLogout').style.display = 'inline-block';

      if (role === 'gestao') {
        document.getElementById('mainAppGestao').style.display = 'flex';
        document.getElementById('mainAppProfessor').style.display = 'none';
        carregarHistoricoGestao();
      } else if (role === 'professor') {
        document.getElementById('mainAppProfessor').style.display = 'flex';
        document.getElementById('mainAppGestao').style.display = 'none';
        carregarHistoricoProfessor();
      }
      loadInitialData();
    }

    function logout() {
      currentUser = null;
      currentRole = null;
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('mainAppGestao').style.display = 'none';
      document.getElementById('mainAppProfessor').style.display = 'none';
      document.getElementById('userDisplay').textContent = 'Não autenticado';
      document.getElementById('btnLogout').style.display = 'none';
      // Limpar campos de login
      document.getElementById('emailGestao').value = '';
      document.getElementById('passwordGestao').value = '';
      document.getElementById('emailProfessor').value = '';
      document.getElementById('passwordProfessor').value = '';
      // Resetar seleção de login
      selectLoginOption('gestao');
    }

    // Funções de Carregamento de Dados Iniciais
    function loadInitialData() {
      googleScriptCall('doGetInitialData', [], function(response) {
        console.log('Dados iniciais carregados:', response);
        allStudents = response.alunos || [];
        populateDropdown('professor_select', response.professores);
        populateDropdown('turma_select', response.turmas);
        // Definir a data atual para os campos de data
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('data_prof').value = today;
        document.getElementById('dataRetorno_gestao').value = today;
      });
    }

    function populateDropdown(elementId, items) {
      const select = document.getElementById(elementId);
      select.innerHTML = '<option value="">Selecione</option>';
      items.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = item;
        select.appendChild(option);
      });
    }

    // Funções do Modal de Seleção de Alunos (Professor)
    function openStudentsModal() {
      const turma = document.getElementById('turma_select').value;
      if (!turma) {
        alert('Por favor, selecione uma turma primeiro.');
        return;
      }
      renderStudentList(turma, 'studentList', selectedStudents);
      document.getElementById('modalRoot').style.display = 'flex';
    }

    function closeStudentsModal() {
      document.getElementById('modalRoot').style.display = 'none';
      document.getElementById('studentSearch').value = ''; // Limpa o filtro
    }

    function renderStudentList(turma, listId, currentSelected) {
      const studentListDiv = document.getElementById(listId);
      studentListDiv.innerHTML = '';
      const filteredByTurma = allStudents.filter(student => student.turma === turma);

      if (filteredByTurma.length === 0) {
        studentListDiv.innerHTML = '<p>Nenhum aluno encontrado para esta turma.</p>';
        return;
      }

      filteredByTurma.forEach(student => {
        const isChecked = currentSelected.some(s => s.nome === student.nome && s.ra === student.ra);
        const studentDiv = document.createElement('div');
        studentDiv.className = 'student-checkbox';
        studentDiv.innerHTML = `
          <input type="checkbox" value="${student.nome}" data-ra="${student.ra}" ${isChecked ? 'checked' : ''}>
          <span>${student.nome} (RA: ${student.ra})</span>
        `;
        studentDiv.addEventListener('click', function(event) {
          // Toggle checkbox when clicking on the div
          const checkbox = studentDiv.querySelector('input[type="checkbox"]');
          checkbox.checked = !checkbox.checked;
          // Prevent event from bubbling up and re-toggling if clicked directly on checkbox
          event.stopPropagation();
        });
        studentListDiv.appendChild(studentDiv);
      });
    }

    function filterStudentList() {
      const searchInput = document.getElementById('studentSearch').value.toLowerCase();
      const studentItems = document.getElementById('studentList').querySelectorAll('.student-checkbox');
      studentItems.forEach(item => {
        const studentName = item.querySelector('span').textContent.toLowerCase();
        if (studentName.includes(searchInput)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }

    function confirmStudents() {
      const studentCheckboxes = document.getElementById('studentList').querySelectorAll('input[type="checkbox"]');
      selectedStudents = [];
      studentCheckboxes.forEach(checkbox => {
        if (checkbox.checked) {
          selectedStudents.push({ nome: checkbox.value, ra: checkbox.dataset.ra });
        }
      });
      updateSelectedStudentsDisplay('alunos_selected_placeholder', 'selectedPills', selectedStudents);
      closeStudentsModal();
    }

    function updateSelectedStudentsDisplay(placeholderId, pillsId, studentsArray) {
      const placeholder = document.getElementById(placeholderId);
      const pillsContainer = document.getElementById(pillsId);
      pillsContainer.innerHTML = '';

      if (studentsArray.length > 0) {
        placeholder.textContent = `${studentsArray.length} aluno(s) selecionado(s)`;
        studentsArray.forEach(student => {
          const pill = document.createElement('span');
          pill.className = 'pill';
          pill.textContent = student.nome;
          pillsContainer.appendChild(pill);
        });
      } else {
        placeholder.textContent = 'Clique para selecionar';
      }
    }

    // Funções do Modal de Seleção de Alunos (Gestão)
    function openStudentsModalGestao() {
      const turma = document.getElementById('serie_gestao').value;
      if (!turma) {
        alert('Por favor, selecione uma turma primeiro.');
        return;
      }
      renderStudentList(turma, 'studentListGestao', selectedStudentsGestao);
      document.getElementById('modalRootGestao').style.display = 'flex';
    }

    function closeStudentsModalGestao() {
      document.getElementById('modalRootGestao').style.display = 'none';
      document.getElementById('studentSearchGestao').value = ''; // Limpa o filtro
    }

    function filterStudentListGestao() {
      const searchInput = document.getElementById('studentSearchGestao').value.toLowerCase();
      const studentItems = document.getElementById('studentListGestao').querySelectorAll('.student-checkbox');
      studentItems.forEach(item => {
        const studentName = item.querySelector('span').textContent.toLowerCase();
        if (studentName.includes(searchInput)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }

    function confirmStudentsGestao() {
      const studentCheckboxes = document.getElementById('studentListGestao').querySelectorAll('input[type="checkbox"]');
      selectedStudentsGestao = [];
      const selectedRAs = [];
      studentCheckboxes.forEach(checkbox => {
        if (checkbox.checked) {
          selectedStudentsGestao.push({ nome: checkbox.value, ra: checkbox.dataset.ra });
          selectedRAs.push(checkbox.dataset.ra);
        }
      });
      updateSelectedStudentsDisplay('aluno_gestao_placeholder', 'selectedPillsGestao', selectedStudentsGestao);
      document.getElementById('ra_gestao').value = selectedRAs.join(', '); // Atualiza o campo RA(s)
      closeStudentsModalGestao();
    }

    // Funções de Ocorrência do Professor
    function onTurmaChange() {
      selectedStudents = []; // Limpa a seleção de alunos ao mudar a turma
      updateSelectedStudentsDisplay('alunos_selected_placeholder', 'selectedPills', selectedStudents);
    }

    function registrarOcorrenciaProfessor() {
      const professor = document.getElementById('professor_select').value;
      const turma = document.getElementById('turma_select').value;
      const data = document.getElementById('data_prof').value;
      const irregularidades = Array.from(document.querySelectorAll('input[name="irreg"]:checked')).map(cb => cb.value).join(', ');
      const descricao = document.getElementById('descricao_prof').value;
      const alunosNomes = selectedStudents.map(s => s.nome).join(', ');
      const alunosRAs = selectedStudents.map(s => s.ra).join(', ');

      if (!professor || !turma || !data || selectedStudents.length === 0 || !irregularidades || !descricao) {
        alert('Por favor, preencha todos os campos obrigatórios.');
        return;
      }

      const dataToSend = {
        professor: professor,
        turma: turma,
        data: data,
        alunos: alunosNomes,
        ras: alunosRAs,
        irregularidades: irregularidades,
        descricao: descricao,
        tipo: 'PROFESSOR' // Identificador para o tipo de registro
      };

      console.log('Dados a serem enviados (Professor):', dataToSend);

      googleScriptCall('doPost', [dataToSend], function(response) {
        console.log('Resposta do servidor (Professor):', response);
        if (response.status === 'SUCCESS') {
          showSuccessMessage('successProfessor');
          clearProfessorForm();
          carregarHistoricoProfessor();
        } else {
          alert('Erro ao registrar ocorrência: ' + response.message);
        }
      });
    }

    function clearProfessorForm() {
      document.getElementById('professor_select').value = '';
      document.getElementById('turma_select').value = '';
      document.getElementById('data_prof').value = new Date().toISOString().split('T')[0];
      document.querySelectorAll('input[name="irreg"]:checked').forEach(cb => cb.checked = false);
      document.getElementById('descricao_prof').value = '';
      selectedStudents = [];
      updateSelectedStudentsDisplay('alunos_selected_placeholder', 'selectedPills', selectedStudents);
    }

    function carregarHistoricoProfessor() {
      googleScriptCall('getProfessorOccurrences', [], function(historico) {
        const historyListDiv = document.getElementById('historyListProfessor');
        historyListDiv.innerHTML = '';
        if (historico && historico.length > 0) {
          historico.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'historyItem';
            itemDiv.innerHTML = `
              <div class="meta">
                <span>Data: ${item.data}</span>
                <span>Professor: ${item.professor}</span>
                <span>Turma: ${item.turma}</span>
              </div>
              <p><strong>Alunos:</strong> ${item.alunos}</p>
              <p><strong>Irregularidades:</strong> ${item.irregularidades}</p>
              <p class="desc"><strong>Descrição:</strong> ${item.descricao}</p>
            `;
            historyListDiv.appendChild(itemDiv);
          });
        } else {
          historyListDiv.innerHTML = '<p>Nenhuma ocorrência registrada para professores.</p>';
        }
      });
    }

    // Funções de Ocorrência da Gestão
    function carregarAlunosPorTurmaGestao(turma) {
      selectedStudentsGestao = []; // Limpa a seleção de alunos ao mudar a turma
      updateSelectedStudentsDisplay('aluno_gestao_placeholder', 'selectedPillsGestao', selectedStudentsGestao);
      document.getElementById('ra_gestao').value = ''; // Limpa o RA
    }

    function toggleSuspension(role) {
      const classificacao = document.getElementById(`classificacao_${role}`).value;
      const suspensionRow = document.getElementById(`suspensionRow_${role}`);
      if (classificacao === 'SUSPENSÃO') {
        suspensionRow.style.display = 'flex';
      } else {
        suspensionRow.style.display = 'none';
        document.getElementById(`dataRetorno_${role}`).value = ''; // Limpa a data se não for suspensão
      }
    }

    function cadastrarOcorrenciaGestao() {
      const serie = document.getElementById('serie_gestao').value;
      const alunosNomes = selectedStudentsGestao.map(s => s.nome).join(', ');
      const alunosRAs = document.getElementById('ra_gestao').value;
      const professor = document.getElementById('professor_gestao').value;
      const disciplina = document.getElementById('disciplina_gestao').value;
      const classificacao = document.getElementById('classificacao_gestao').value;
      const dataRetorno = document.getElementById('dataRetorno_gestao').value;
      const descricao = document.getElementById('descricao_gestao').value;

      if (!serie || selectedStudentsGestao.length === 0 || !alunosRAs || !professor || !disciplina || !classificacao || !descricao) {
        alert('Por favor, preencha todos os campos obrigatórios.');
        return;
      }

      const dataToSend = {
        serie: serie,
        alunos: alunosNomes,
        ras: alunosRAs,
        professor: professor,
        disciplina: disciplina,
        classificacao: classificacao,
        dataRetorno: classificacao === 'SUSPENSÃO' ? dataRetorno : '',
        descricao: descricao,
        tipo: 'GESTAO' // Identificador para o tipo de registro
      };

      console.log('Dados a serem enviados (Gestão):', dataToSend);

      googleScriptCall('doPost', [dataToSend], function(response) {
        console.log('Resposta do servidor (Gestão):', response);
        if (response.status === 'SUCCESS') {
          showSuccessMessage('successGestao');
          clearGestaoForm();
          carregarHistoricoGestao();
        } else {
          alert('Erro ao registrar ocorrência: ' + response.message);
        }
      });
    }

    function clearGestaoForm() {
      document.getElementById('serie_gestao').value = '';
      selectedStudentsGestao = [];
      updateSelectedStudentsDisplay('aluno_gestao_placeholder', 'selectedPillsGestao', selectedStudentsGestao);
      document.getElementById('ra_gestao').value = '';
      document.getElementById('professor_gestao').value = '';
      document.getElementById('disciplina_gestao').value = '';
      document.getElementById('classificacao_gestao').value = '';
      document.getElementById('dataRetorno_gestao').value = new Date().toISOString().split('T')[0];
      document.getElementById('suspensionRow_gestao').style.display = 'none';
      document.getElementById('descricao_gestao').value = '';
    }

    function carregarHistoricoGestao() {
      googleScriptCall('getGestaoOccurrences', [], function(historico) {
        const historyListDiv = document.getElementById('historyListGestao');
        historyListDiv.innerHTML = '';
        if (historico && historico.length > 0) {
          historico.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'historyItem';
            itemDiv.innerHTML = `
              <div class="meta">
                <span>Data: ${item.data}</span>
                <span>Professor: ${item.professor}</span>
                <span>Turma: ${item.serie}</span>
              </div>
              <p><strong>Alunos:</strong> ${item.alunos} (RA: ${item.ra})</p>
              <p><strong>Disciplina:</strong> ${item.disciplina}</p>
              <p><strong>Classificação:</strong> ${item.classificacao} ${item.dataRetorno ? `(Retorno: ${item.dataRetorno})` : ''}</p>
              <p class="desc"><strong>Descrição:</strong> ${item.descricao}</p>
            `;
            historyListDiv.appendChild(itemDiv);
          });
        } else {
          historyListDiv.innerHTML = '<p>Nenhuma ocorrência registrada para gestão.</p>';
        }
      });
    }

    // Função para mostrar mensagem de sucesso
    function showSuccessMessage(elementId) {
      const successMessage = document.getElementById(elementId);
      successMessage.style.display = 'block';
      setTimeout(() => {
        successMessage.style.display = 'none';
      }, 3000);
    }

    // Geração de PDF local (apenas para Gestão)
    function generatePDFLocal() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(18);
      doc.text("Relatório de Ocorrência", 14, 22);

      doc.setFontSize(12);
      const serie = document.getElementById('serie_gestao').value;
      const alunosNomes = selectedStudentsGestao.map(s => s.nome).join(', ');
      const alunosRAs = document.getElementById('ra_gestao').value;
      const professor = document.getElementById('professor_gestao').value;
      const disciplina = document.getElementById('disciplina_gestao').value;
      const classificacao = document.getElementById('classificacao_gestao').value;
      const dataRetorno = document.getElementById('dataRetorno_gestao').value;
      const descricao = document.getElementById('descricao_gestao').value;
      const dataAtual = new Date().toLocaleDateString('pt-BR');

      let y = 30;
      const addText = (label, value) => {
        doc.text(`${label}: ${value}`, 14, y);
        y += 7;
      };

      addText("Data do Registro", dataAtual);
      addText("Série/Turma", serie);
      addText("Alunos", alunosNomes);
      addText("RA(s)", alunosRAs);
      addText("Professor", professor);
      addText("Disciplina", disciplina);
      addText("Classificação", classificacao);
      if (classificacao === 'SUSPENSÃO' && dataRetorno) {
        addText("Data de Retorno", dataRetorno);
      }
      y += 5; // Espaço extra antes da descrição
      doc.text("Descrição:", 14, y);
      y += 7;
      const splitDescription = doc.splitTextToSize(descricao, 180); // 180mm largura máxima
      doc.text(splitDescription, 14, y);

      doc.save('ocorrencia.pdf');
    }

    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
      selectLoginOption('gestao'); // Seleciona Gestão por padrão
      // loadInitialData(); // Não carrega dados antes do login
    });
  </script>
</body>
</html>
