// =================================================================
//
//   ARQUIVO: Code.gs (Backend Completo para Cadastro de Ocorrências)
//   VERSÃO: Final Unificada (API Web + Funcionalidade da Planilha + Correção de CORS)
//   AUTOR: Manus (revisado e detalhado)
//
//   DESCRIÇÃO: Este script serve como backend para um formulário de
//   ocorrências. Ele expõe uma API web para ser consumida pelo
//   formulário HTML e mantém a funcionalidade para ser usado
//   diretamente de dentro da Planilha Google.
//
// =================================================================




// =================================================================
// 1. CONFIGURAÇÕES GLOBAIS E CONSTANTES
//    (Verifique se estes IDs estão corretos)
// =================================================================


const SPREADSHEET_ID = '1u7qMsMHkZT47OZdar5qvshQDRA8XJrLgDjAZVOViAio'; // ID da sua Planilha Google
const FOLDER_ID = '19JydmuXDW3ZA8ckj9N7tCjlDnEUozYxv';               // ID da pasta no Google Drive onde os PDFs serão salvos
const TEMPLATE_ID = '1dHwyN8mlb_4bltEksnoc3Yx5wUcDNgAkzqsluLPYeP8'; // ID do seu template Google Docs para gerar os PDFs


/**
 * Mapeamento centralizado dos nomes das turmas para seus respectivos
 * intervalos de células na aba 'BANCODEDADOSGERAL'.
 * Isso permite buscar a lista de alunos e seus RAs para cada turma.
 */
const CLASS_RANGES = {
  "6° ANO A MANHA":   { nome: "C3:C46",  ra: "D3:D46" },
  "6° ANO B MANHA":   { nome: "H3:H46",  ra: "I3:I46" },
  "6° ANO C MANHA":   { nome: "M3:M46",  ra: "N3:N46" },
  "6° ANO D MANHA":   { nome: "R3:R46",  ra: "S3:S46" },
  "6° ANO E TARDE":   { nome: "W3:W46",  ra: "X3:X46" },
  "6° ANO F TARDE":   { nome: "AB3:AB46", ra: "AC3:AC46" },
  "7° ANO A TARDE":   { nome: "AG3:AG46", ra: "AH3:AH46" },
  "7° ANO B TARDE":   { nome: "AL3:AL46", ra: "AM3:AM46" },
  "7° ANO C TARDE":   { nome: "AQ3:AQ46", ra: "AR3:AR46" },
  "7° ANO D TARDE":   { nome: "AV3:AV46", ra: "AW3:AW46" },
  "7° ANO E TARDE":   { nome: "BA3:BA46", ra: "BB3:BB46" },
  "7° ANO F TARDE":   { nome: "BF3:BF46", ra: "BG3:BG46" },
  "8° ANO A TARDE":   { nome: "BK3:BK46", ra: "BL3:BL46" },
  "8° ANO B TARDE":   { nome: "BP3:BP46", ra: "BQ3:BQ46" },
  "8° ANO C TARDE":   { nome: "BU3:BU46", ra: "BV3:BV46" },
  "8° ANO D TARDE":   { nome: "BZ3:BZ46", ra: "CA3:CA46" },
  "8° ANO E TARDE":   { nome: "CE3:CE46", ra: "CF3:CF46" },
  "9° ANO A TARDE":   { nome: "CJ3:CJ46", ra: "CK3:CK46" },
  "9° ANO B TARDE":   { nome: "CO3:CO46", ra: "CP3:CP46" },
  "9° ANO C TARDE":   { nome: "CT3:CT46", ra: "CU3:CU46" },
  "9° ANO D TARDE":   { nome: "CY3:CY46", ra: "CZ3:CZ46" },
  "1ª SERIE A MANHA": { nome: "DD3:DD46", ra: "DE3:DE46" },
  "1ª SERIE B MANHA": { nome: "DI3:DI46", ra: "DJ3:DJ46" },
  "1ª SERIE C MANHA": { nome: "DN3:DN46", ra: "DO3:DO46" },
  "1ª SERIE D MANHA": { nome: "DS3:DS46", ra: "DT3:DT46" },
  "1ª SERIE E MANHA": { nome: "DX3:DX46", ra: "DY3:DY46" },
  "1ª SERIE F MANHA": { nome: "EC3:EC46", ra: "ED3:ED46" },
  "1ª SERIE G TARDE": { nome: "EH3:EH46", ra: "EI3:EI46" },
  "1ª SERIE H NOITE": { nome: "EM3:EM46", ra: "EN3:EN46" },
  "1ª SERIE I NOITE": { nome: "ER3:ER46", ra: "ES3:ES46" },
  "2ª SERIE A MANHA": { nome: "EW3:EW46", ra: "EX3:EX46" },
  "2ª SERIE B MANHA": { nome: "FB3:FB46", ra: "FC3:FC46" },
  "2ª SERIE C MANHA": { nome: "FG3:FG46", ra: "FH3:FH46" },
  "2ª SERIE D MANHA": { nome: "FL3:FL46", ra: "FM3:FM46" },
  "2ª SERIE E MANHA": { nome: "FQ3:FQ46", ra: "FR3:FR46" },
  "2ª SERIE F NOITE": { nome: "FV3:FV46", ra: "FW3:FW46" },
  "2ª SERIE G NOITE": { nome: "GA3:GA46", ra: "GB3:GB46" },
  "2ª SERIE H NOITE": { nome: "GK3:GK46", ra: "GL3:GL46" },
  "3ª SERIE A MANHA": { nome: "GP3:GP46", ra: "GQ3:GQ46" },
  "3ª SERIE B MANHA": { nome: "GU3:GU46", ra: "GV3:GV46" },
  "3ª SERIE C MANHA": { nome: "GZ3:GZ46", ra: "HA3:HA46" },
  "3ª SERIE D NOITE": { nome: "HE3:HE46", ra: "HF3:HF46" },
  "3ª SERIE E NOITE": { nome: "HJ3:HJ46", ra: "HK3:HK46" },
  "3ª SERIE F NOITE": { nome: "HO3:HO46", ra: "HP3:HP46" },
  "3ª SERIE G NOITE": { nome: "HT3:HT46", ra: "HU3:HU46" }
};




// =================================================================
// 2. FUNÇÕES DA API WEB (doGet, doPost, doOptions)
// =================================================================


/**
 * Ponto de entrada para requisições GET. Usado para buscar dados.
 */
function doGet(e) {
  const params = e.parameter;
  let response;
  try {
    if (!params.endpoint) {
      throw new Error("Requisição GET inválida. O parâmetro 'endpoint' é obrigatório.");
    }
    switch (params.endpoint) {
      case 'classes':
        response = { status: 'success', classes: getAllClasses() };
        break;
      case 'teachers':
        response = { status: 'success', teachers: getAllTeachers() };
        break;
      case 'students':
        const turma = params.turma || '';
        if (!turma) throw new Error("O parâmetro 'turma' é obrigatório para buscar alunos.");
        response = { status: 'success', students: getStudentsWithRa(turma) };
        break;
      case 'occurrences':
        const sheetNameForGet = params.sheet;
        if (!sheetNameForGet) throw new Error("O parâmetro 'sheet' é obrigatório para buscar ocorrências.");
        response = { status: 'success', occurrences: getOccurrencesFromSheet(sheetNameForGet) };
        break;
      default:
        throw new Error(`Endpoint GET "${params.endpoint}" é desconhecido.`);
    }
  } catch (error) {
    response = { status: 'error', message: error.message };
  }
  return ContentService.createTextOutput(JSON.stringify(response))
    .setMimeType(ContentService.MimeType.JSON);
}


/**
 * Ponto de entrada para requisições POST. Usado para enviar/deletar dados.
 */
function doPost(e) {
  let response;
  try {
    const requestData = JSON.parse(e.postData.contents);
    const sheetName = requestData.sheet;
    if (!sheetName) throw new Error("A propriedade 'sheet' é obrigatória no corpo da requisição POST.");


    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) throw new Error(`A aba de destino "${sheetName}" não foi encontrada na planilha.`);


    if (requestData.endpoint === 'delete-occurrence') {
      const rowId = requestData.occurrenceId;
      if (!rowId || parseInt(rowId) <= 1) throw new Error(`ID de linha inválido para exclusão: ${rowId}`);
      sheet.deleteRow(parseInt(rowId));
      response = { status: 'success', message: `Linha ${rowId} excluída com sucesso.` };
    } else {
      const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0].map(h => String(h).toUpperCase());
      const newRow = headers.map(header => {
        switch (header) {
          case 'DATA': return requestData.date || new Date();
          case 'PROFESSOR': return requestData.professor || '';
          case 'TURMA': return requestData.studentClass || '';
          case 'ALUNO': case 'ALUNOS': return requestData.student || '';
          case 'RA': case 'RA(S)': return requestData.ra || '';
          case 'DISCIPLINA': return requestData.disciplina || '';
          case 'IRREGULARIDADES': return requestData.irregularities || '';
          case 'DESCRICAO': case 'DESCRIÇÃO': return requestData.description || '';
          default: return '';
        }
      });
      sheet.appendRow(newRow);
      response = { status: 'success', message: 'Ocorrência registrada com sucesso via API.' };
    }
  } catch (error) {
    response = { status: 'error', message: 'Erro no Servidor (doPost): ' + error.message };
  }
  return ContentService.createTextOutput(JSON.stringify(response))
    .setMimeType(ContentService.MimeType.JSON);
}


/**
 * Ponto de entrada para requisições OPTIONS (Preflight).
 * ESSA FUNÇÃO É A CORREÇÃO PARA O ERRO DE CORS.
 * Ela responde à "sondagem" do navegador, autorizando a requisição POST.
 */
function doOptions(e) {
  return ContentService.createTextOutput()
    .setMimeType(ContentService.MimeType.JSON)
    .withHeaders({
      "Access-Control-Allow-Origin": "https://raulvilera.github.io", // Permite requisições SOMENTE do seu site.
      "Access-Control-Allow-Methods": "POST, GET, OPTIONS",          // Métodos permitidos. OPTIONS é essencial.
      "Access-Control-Allow-Headers": "Content-Type",                // Cabeçalhos permitidos na requisição.
    } );
}




// =================================================================
// 3. FUNÇÕES PARA A INTERFACE DA PLANILHA (LÓGICA ORIGINAL RESTAURADA)
// =================================================================


/**
 * Função principal chamada por um botão/menu DENTRO da planilha Google Sheets.
 * Esta é a sua função original, restaurada para garantir a formatação correta do PDF.
 */
function cadastrarOcorrenciaEEnviarDocumento() {
  var lock = LockService.getScriptLock();
  var acquired = false;
  try {
    lock.waitLock(15000);
    acquired = true;


    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var ssCadastro = ss.getSheetByName('cadastro');
    if (!ssCadastro) {
      SpreadsheetApp.getUi().alert("Planilha 'cadastro' não encontrada.");
      return;
    }


    var nomeAluno = ssCadastro.getRange('C3').getDisplayValue();
    var serie = ssCadastro.getRange('C5').getDisplayValue();
    var professor = ssCadastro.getRange('C7').getDisplayValue();
    var ra = ssCadastro.getRange('C9').getDisplayValue();
    var disciplina = ssCadastro.getRange('C11').getDisplayValue();
    var descricao = ssCadastro.getRange('C16').getDisplayValue();
    var dataAtual = new Date();


    var ssBancoDeAlunos = ss.getSheetByName('BANCODEALUNOS');
    if (!ssBancoDeAlunos) {
      SpreadsheetApp.getUi().alert("Planilha 'BANCODEALUNOS' não encontrada.");
      return;
    }


    var descricaoOcorrencia = ssCadastro.getRange('F11').getDisplayValue();
    var ocorrenciaSelecionada = descricaoOcorrencia === "OCORRÊNCIA";
    var suspensaoSelecionada = descricaoOcorrencia === "SUSPENSÃO";
    var dataRetornoSuspensaoRaw = ssCadastro.getRange('F13').getValue();
    var dataRetornoSuspensao = null;


    if (dataRetornoSuspensaoRaw && dataRetornoSuspensaoRaw.toString().trim() !== '') {
      if (dataRetornoSuspensaoRaw instanceof Date && !isNaN(dataRetornoSuspensaoRaw)) {
        dataRetornoSuspensao = dataRetornoSuspensaoRaw;
      } else if (typeof dataRetornoSuspensaoRaw === 'string') {
        var parsedDate = new Date(dataRetornoSuspensaoRaw);
        if (!isNaN(parsedDate)) {
          dataRetornoSuspensao = parsedDate;
        }
      }
    }


    var pdfUrl = criarDocumento(
      nomeAluno, serie, professor, ra, disciplina, descricao, dataAtual,
      descricaoOcorrencia, ocorrenciaSelecionada, suspensaoSelecionada, dataRetornoSuspensao
    );


    ssBancoDeAlunos.insertRowBefore(2);
    ssBancoDeAlunos.getRange(2, 1, 1, 9).setValues([[
      nomeAluno, serie, professor, ra, disciplina,
      Utilities.formatDate(dataAtual, Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm:ss"),
      descricao, pdfUrl, ''
    ]]);


    if (ssBancoDeAlunos.getMaxRows() >= 3) {
      ssBancoDeAlunos.getRange(3, 1, 1, 9).copyTo(ssBancoDeAlunos.getRange(2, 1, 1, 9), SpreadsheetApp.CopyPasteType.PASTE_FORMAT, false);
    }


    if (dataRetornoSuspensao) {
      ssBancoDeAlunos.getRange(2, 9).setValue(Utilities.formatDate(dataRetornoSuspensao, Session.getScriptTimeZone(), "dd/MM/yyyy"));
    }


    var html = HtmlService.createHtmlOutput(
      '<div style="background-color:#001f3f; color:white; font-weight:bold; padding:20px; text-align:center; font-size:16px;">CADASTRO REALIZADO COM SUCESSO</div>'
    ).setWidth(350).setHeight(100);
    SpreadsheetApp.getUi().showModalDialog(html, "Mensagem");


  } catch (err) {
    SpreadsheetApp.getUi().alert("Ocorreu um erro: " + err.message);
  } finally {
    if (acquired) {
      lock.releaseLock();
    }
  }
}


/**
 * Cria um documento a partir de um template.
 * Esta é a sua função original, restaurada para garantir a formatação correta do PDF.
 */
function criarDocumento(nomeAluno, serie, professor, ra, disciplina, descricao, data, descricaoOcorrencia, ocorrenciaSelecionada, suspensaoSelecionada, dataRetornoSuspensao) {
  const pastaDestino = DriveApp.getFolderById(FOLDER_ID);
  const modelo = DriveApp.getFileById(TEMPLATE_ID);
  const nomeArquivo = `${nomeAluno} - ${suspensaoSelecionada ? 'Suspensão' : 'Ocorrência'}`;
  const novoArquivo = modelo.makeCopy(nomeArquivo, pastaDestino);
  const novoDoc = DocumentApp.openById(novoArquivo.getId());
  const docCorpo = novoDoc.getBody();


  docCorpo.replaceText('\\{NOME\\}', nomeAluno || '');
  docCorpo.replaceText('\\{SÉRIE\\}', serie || '');
  docCorpo.replaceText('\\{SERIE\\}', serie || '');
  docCorpo.replaceText('\\{PROFESSOR\\}', professor || '');
  docCorpo.replaceText('\\{RA\\}', ra || '');
  docCorpo.replaceText('\\{DISCIPLINA\\}', disciplina || '');
  docCorpo.replaceText('\\{DATA\\}', Utilities.formatDate(data, Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm:ss"));
  docCorpo.replaceText('\\{OCORRÊNCIA\\}', ocorrenciaSelecionada ? "OCORRÊNCIA" : " ");
  docCorpo.replaceText('\\{OCORRENCIA\\}', ocorrenciaSelecionada ? "OCORRÊNCIA" : " ");
  docCorpo.replaceText('\\{SUSPENSÃO\\}', suspensaoSelecionada ? "SUSPENSÃO" : " ");
  docCorpo.replaceText('\\{SUSPENSAO\\}', suspensaoSelecionada ? "SUSPENSÃO" : " ");
  docCorpo.replaceText('\\{DESCRIÇÃO\\}', descricao || '');
  docCorpo.replaceText('\\{DESCRICAO\\}', descricao || '');


  if (suspensaoSelecionada && dataRetornoSuspensao) {
    docCorpo.replaceText('\\{DATA_RETORNO_SUSPENSAO\\}', Utilities.formatDate(dataRetornoSuspensao, Session.getScriptTimeZone(), "dd/MM/yyyy"));
    docCorpo.replaceText('\\{RETORNO\\}', "O aluno deverá retornar em " + Utilities.formatDate(dataRetornoSuspensao, Session.getScriptTimeZone(), "dd/MM/yyyy"));
  } else {
    docCorpo.replaceText('\\{DATA_RETORNO_SUSPENSAO\\}', '___/___/______');
    docCorpo.replaceText('\\{RETORNO\\}', "");
  }


  novoDoc.saveAndClose();
  const pdfBlob = novoArquivo.getAs(MimeType.PDF);
  const pdfFile = pastaDestino.createFile(pdfBlob).setName(nomeArquivo + '.pdf');
  DriveApp.getFileById(novoArquivo.getId()).setTrashed(true);
  return pdfFile.getUrl();
}




// =================================================================
// 4. FUNÇÕES AUXILIARES (COMPARTILHADAS)
// =================================================================


function getAllTeachers() {
  return [
    "ALEX LUTH PEREIRA MARANHAO","ALEXSANDRA PAULA VARELLA DE SOUZA","ALISON VASCONCELOS BESERRA","AMAURI TEODORO DE OLIVEIRA",
    "ANA PAULA DOS SANTOS","ANDREIA DOS SANTOS FREITAS","ANDREIA MADUREIRA REIS","ANTONIO CARLOS DE OLIVEIRA",
    "ANTONIO RAMS DE ARAUJO","ANTONIO WILTON WANDERLEY CABRAL","AUGUSTO LINO PESSOA NETO","AUREA MARIA DE JESUS MARQUES",
    "CAROLINA PERNOMIAN PARUSSOLOLO","CASSIA OLIVEIRA ANTONIAZI","CLAUDINEIA DE AGUIAR LIMA","DANIEL DE FREITAS ALMEIDA",
    "DANIEL LOPES BARBOSA","DANIELA FERREIRA LIMA","DANIELLE LUCIA BATISTA DE ALMEIDA","EDIANE VIEIRA DA SILVA",
    "EDILEUSA NUNES PEREIRA","EDUARDO HENRIQUE DA FONSECA","ELIANE SANTOS SILVA","ELIAS MONTEIRO DA SILVA",
    "ELISABETE APARECIDA PIRES","ELZA DE FARIA PEREIRA","EMERSON GABLER DE ALMEIDA","EUZELI ARAUJO DE OLIVEIRA",
    "FABIANO AUGUSTO PIEDADE","FABIO CAMILO","FERNANDO JOSE DA SILVA FILHO","FLAVIA CRISTINA APARECIDA BICHLER",
    "FLAVIO CARDOSO FLEURY","FRANCISCA EDIVANIA DE MORAIS COSTA","GABRIELA SERIGHELLI DE MELO","GELSON DE ALMEIDA BATISTA",
    "GENILTON DE OLIVEIRA SILVA","GIANI CRISTINA DO PRADO","INGRYD CAROLINE SUGUIMOTO VIEIRA","IVANILDES DOS SANTOS OSHIKAWA",
    "JANINA DOS PASSOS BRAGA DE ALMEIDA","JOSE APARECIDO DA SILVA","JUAREZ GOMES DE MAGALHAES FILHO","JUREMA SOLEDADE FURINI SANTOS",
    "KATIUSCIA ALVES BOMFIM","LUANA CAROLINE ALVES LIMA","LUANA DE FREITAS SILVA","LUCIANA NOVAIS CORREIA SANTOS",
    "LUCIANO MOREIRA DE AZEVEDO","MARCIEL DA SILVA","MARIA HELENA CUNHA MORO","MARIA QUITÉRIA FERREIRA DOS SANTOS",
    "MARINA DA CONCEICAO FRANCISCO SILVA","MAURICIO DE BARROS SANTOS","MICHELE DE PINHO MORAES","MOISES ANTONIO DE BARROS",
    "PAULA ARMANI VILA","PAULO ROBERTO DA SILVA ITO","PEDRO ZANOTTI FILHO","RAUL PEREIRA VILERA JUNIOR",
    "REGIANE CURTI DE SOUZA OLIVEIRA","REGINA DA SILSA CASTRO","RICARDO AMERICO DA SILVA","ROBERTO SALGADO",
    "RODRIGO VIEIRA","ROSANGELA CAFASSO MOREIRA","ROSIMERY DE SOUZA PESSOA","ROSMARA DA SILSA CARDOSO",
    "SANDRA CRISTINA MACEDO MORAES","SELMA GOMES DA SILSA","SERGIO AGRIPINO VILLA NOVA","SOLANGE ALMEIDA DA SILSA",
    "SUZINEIDE SILSA DE FREITAS","THIAGO FABIANO BRITO","TITTO AUGUSTO NASCIMENTO SILSA","VANDERSON HYPPOLITO",
    "VANESSA IVETE GOMES DOS SANTOS","VANIA PENHA DE BARROS","VIVIANE LEAL CAMERA DE MORAES","WILSON RODRIGUES MOTA"
  ];
}


function getAllClasses() {
  return Object.keys(CLASS_RANGES);
}


function getStudentsWithRa(turma) {
  try {
    if (!turma || !CLASS_RANGES[turma]) return [];
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName('BANCODEDADOSGERAL');
    if (!sheet) return [];
    const names = sheet.getRange(CLASS_RANGES[turma].nome).getValues().flat();
    const ras = sheet.getRange(CLASS_RANGES[turma].ra).getValues().flat();
    return names.map((name, index) => ({
      nome: String(name).trim(),
      ra: (ras[index] || '').toString().trim()
    })).filter(student => student.nome !== '');
  } catch (err) {
    console.error(`Erro em getStudentsWithRa para a turma "${turma}": ${err.message}`);
    return [];
  }
}


function getOccurrencesFromSheet(sheetName) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) return [];
    const values = sheet.getDataRange().getValues();
    if (values.length <= 1) return [];
    const headers = values.shift().map(h => String(h || '').toLowerCase());
    return values.map((row, idx) => {
      const obj = { id: idx + 2 };
      headers.forEach((h, i) => {
        let value = row[i];
        if (value instanceof Date) {
          value = Utilities.formatDate(value, Session.getScriptTimeZone(), "yyyy-MM-dd");
        }
        obj[h] = value;
      });
      return obj;
    });
  } catch (err) {
    console.error(`Erro em getOccurrencesFromSheet para a aba "${sheetName}": ${err.message}`);
    return [];
  }
}



